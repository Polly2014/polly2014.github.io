<!doctype html><html><head><title>OpenHands 源码解析系列（五）：代理系统与任务分配</title><meta content="解析 OpenHands 的代理设计模式及其在任务分配中的作用。" name=description><meta content="Polly, Blog, AI Blog, AI Assistant, Tutorials, Technology Blog, Baoli Wang" name=keywords><meta content="width=device-width,initial-scale=1" name=viewport><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content=article property=og:type><meta content=https://polly.wang/openhands-source-code-analysis-005/ property=og:url><meta content="OpenHands 源码解析系列（五）：代理系统与任务分配" property=og:title><meta content="解析 OpenHands 的代理设计模式及其在任务分配中的作用。" property=og:description><meta content=https://polly.wang/images/polly.png property=og:image><meta content="Polly Blog" property=og:site_name><meta content=zh_CN property=og:locale><meta content=summary_large_image name=twitter:card><meta content=https://polly.wang/openhands-source-code-analysis-005/ name=twitter:url><meta content="OpenHands 源码解析系列（五）：代理系统与任务分配" name=twitter:title><meta content="解析 OpenHands 的代理设计模式及其在任务分配中的作用。" name=twitter:description><meta content=https://polly.wang/images/polly.png name=twitter:image><meta content=2025-02-24T00:00:00 property=article:published_time><meta content=Polly property=article:author><meta content=OpenHands property=article:tag><meta content=源码解析 property=article:tag><meta content=代理系统 property=article:tag><link rel="shortcut icon" href=https://polly.wang/images/polly.ico type=image/x-icon><link href=https://polly.wang/images/polly.ico rel=icon type=image/x-icon><link href=https://polly.wang/images/polly.ico rel=apple-touch-icon><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css rel=stylesheet><link href=https://polly.wang/css/style_new.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-8JD13N7PHS" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8JD13N7PHS';);</script><body><div class=menu-toggle><img alt=Menu src=https://polly.wang/images/polly.png></div><div class=overlay></div><div class="pure-g container"><div class="sidebar pure-u-1 pure-u-md-1-5"><div class=title><a class=pure-menu-heading href=https://polly.wang> <img class="avatar pure-img-responsive" src=https://polly.wang/images/polly.png> </a><div class=introduction><p>Polly's Blog</div><div class=nav><ul class=nav-links><li><a href=https://polly.wang><i class="fas fa-home"></i>Home</a><li><a href=https://polly.wang/archive><i class="fas fa-archive"></i>Archive</a><li><a href=https://polly.wang/category><i class="fas fa-folder"></i>Category</a><li><a href=https://polly.wang/blog><i class="fas fa-file-alt"></i>Posts</a><li><a href=https://polly.wang/cfp><i class="fas fa-calendar-alt"></i>CFP</a><li><a href=https://polly.wang/publication><i class="fas fa-file-pdf"></i>Research</a><li><a href=https://polly.wang/changelog><i class="fas fa-history"></i>Change log</a><li><a href=https://polly.wang/about><i class="fas fa-info-circle"></i>About Me</a></ul></div><div class=social><ul class=social-links><li><a href=mailto:26716201@qq.com><i class="fas fa-envelope"></i></a><li><a href=https://twitter.com/Polly__007><i class="fab fa-twitter"></i></a><li><a href=https://www.linkedin.com/in/baoliwang><i class="fab fa-linkedin-in"></i></a><li><a href=https://github.com/Polly2014><i class="fab fa-github"></i></a></ul></div></div></div><div class="content pure-u-1 pure-u-md-4-5"><div class=blog-post><h1>OpenHands 源码解析系列（五）：代理系统与任务分配</h1><div class=content><p>代理系统是 OpenHands 的核心组件之一，负责执行具体任务。本文将深入解析代理的设计模式及其在任务分配中的作用，帮助读者理解其实现细节和设计理念。<hr><h2 id=dai-li-de-she-ji-xiang-jie>代理的设计详解</h2><p>代理系统的核心逻辑位于 <code>agenthub</code> 模块，以下是其设计的详细分析：<ol><li><p><strong>模块化设计</strong>：</p> <ul><li><strong>特点</strong>：每个代理负责特定任务（如代码生成、网页浏览）。<li><strong>优势</strong>：模块化设计使得新增代理类型变得简单。</ul><li><p><strong>基类定义</strong>：</p> <ul><li><strong>文件路径</strong>：<code>agenthub/micro/microagent.py</code><li><strong>功能</strong>：定义所有代理的通用接口和行为。<li><strong>示例代码</strong>：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#b48ead>class </span><span style=color:#ebcb8b>MicroAgent</span><span style=color:#eff1f5>:
</span><span>    </span><span style=color:#b48ead>def </span><span style=color:#96b5b4>__init__</span><span>(</span><span style=color:#bf616a>self</span><span>, </span><span style=color:#bf616a>name</span><span>: str):
</span><span>        </span><span style=color:#bf616a>self</span><span>.name = name
</span><span>
</span><span>    </span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>handle_request</span><span>(</span><span style=color:#bf616a>self</span><span>, </span><span style=color:#bf616a>request</span><span>: dict) -> dict:
</span><span>        </span><span style=color:#b48ead>raise </span><span style=color:#bf616a>NotImplementedError</span><span>("</span><span style=color:#a3be8c>Subclasses must implement this method</span><span>")
</span></code></pre></ul></ol><hr><h2 id=shi-li-dai-li-xiang-jie>示例代理详解</h2><p>以下是两个主要代理的详细分析：<ol><li><p><strong>BrowsingAgent</strong>：</p> <ul><li><strong>功能</strong>：处理网页搜索任务。<li><strong>文件路径</strong>：<code>agenthub/browsing_agent</code><li><strong>实现细节</strong>： <ul><li>调用搜索引擎 API，获取搜索结果。<li>返回结果的格式化数据。</ul></ul><li><p><strong>CodeActAgent</strong>：</p> <ul><li><strong>功能</strong>：处理代码生成和分析任务。<li><strong>文件路径</strong>：<code>agenthub/codeact_agent</code><li><strong>实现细节</strong>： <ul><li>调用 LLM 模块生成代码。<li>分析用户提供的代码片段，返回优化建议。</ul></ul></ol><hr><h2 id=ren-wu-fen-pei-xiang-jie>任务分配详解</h2><p>任务分配的核心逻辑位于 <code>controller/agent_controller.py</code>，以下是其详细分析：<ol><li><p><strong>选择代理</strong>：</p> <ul><li><strong>功能</strong>：根据用户意图分配合适的代理。<li><strong>示例代码</strong>：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#b48ead>def </span><span style=color:#8fa1b3>assign_agent</span><span>(</span><span style=color:#bf616a>parsed_action</span><span>: dict):
</span><span>    </span><span style=color:#b48ead>if </span><span>parsed_action["</span><span style=color:#a3be8c>action</span><span>"] == "</span><span style=color:#a3be8c>search</span><span>":
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#bf616a>BrowsingAgent</span><span>()
</span><span>    </span><span style=color:#b48ead>elif </span><span>parsed_action["</span><span style=color:#a3be8c>action</span><span>"] == "</span><span style=color:#a3be8c>code</span><span>":
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#bf616a>CodeActAgent</span><span>()
</span><span>    </span><span style=color:#b48ead>else</span><span>:
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#bf616a>ChatAgent</span><span>()
</span></code></pre></ul><li><p><strong>执行任务</strong>：</p> <ul><li><strong>功能</strong>：调用代理的 <code>handle_request</code> 方法处理请求。<li><strong>实现细节</strong>： <ul><li>每个代理实现特定的任务逻辑。<li>返回处理结果给调用方。</ul></ul></ol><hr><h2 id=shen-du-fen-xi-kuo-zhan-xing-yu-you-hua>深度分析：扩展性与优化</h2><ol><li><p><strong>扩展性</strong>：</p> <ul><li>新增代理类型： <ul><li>在 <code>agenthub</code> 模块中添加新的代理类。<li>在 <code>agent_controller.py</code> 中注册新代理。</ul><li>示例：新增一个 <code>DataAnalysisAgent</code>，用于处理数据分析任务。</ul><li><p><strong>性能优化</strong>：</p> <ul><li>使用异步编程： <ul><li>在代理的任务处理中引入 <code>async/await</code>，提升并发性能。</ul><li>缓存机制： <ul><li>对于常见的任务结果进行缓存，减少重复计算。</ul></ul></ol><hr><p>通过以上分析，我们可以看到 OpenHands 的代理系统设计清晰且易于扩展。在下一篇文章中，我们将深入解析与大语言模型（LLM）的交互逻辑，带你了解其核心实现。<hr><h2 id=dai-li-de-she-ji>代理的设计</h2><p>代理的核心逻辑位于 <code>agenthub</code> 模块，主要特点包括：<ol><li><p><strong>模块化设计</strong>：</p> <ul><li>每个代理负责特定任务（如代码生成、网页浏览）。</ul><li><p><strong>基类定义</strong>：</p> <ul><li>所有代理继承自 <code>MicroAgent</code> 基类。</ul></ol><hr><h2 id=shi-li-dai-li>示例代理</h2><ol><li><p><strong>BrowsingAgent</strong>：</p> <ul><li>处理网页搜索任务。<li>位于 <code>agenthub/browsing_agent</code>。</ul><li><p><strong>CodeActAgent</strong>：</p> <ul><li>处理代码生成和分析任务。<li>位于 <code>agenthub/codeact_agent</code>。</ul></ol><hr><h2 id=ren-wu-fen-pei>任务分配</h2><p>任务分配的核心逻辑位于 <code>controller/agent_controller.py</code>，主要功能包括：<ol><li><p><strong>选择代理</strong>：</p> <ul><li>根据用户意图分配合适的代理。</ul><li><p><strong>执行任务</strong>：</p> <ul><li>调用代理的 <code>handle_request</code> 方法处理请求。</ul></ol><hr><h2 id=zong-jie>总结</h2><p>通过模块化的代理设计，OpenHands 能够高效地执行多种任务。在下一篇文章中，我们将深入解析与大语言模型（LLM）的交互逻辑。<hr><p>下一篇：<a href=#>OpenHands 源码解析系列（六）：与大语言模型（LLM）的交互</a></div><div class=navigation></div></div><div id=giscus-container><h2>留言与讨论</h2><div class=giscus></div></div><script data-category="Blog Comments" async crossorigin data-category-id=DIC_kwDOL45duM4CnjlZ data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=pathname data-reactions-enabled=1 data-repo=Polly2014/polly2014.github.io data-repo-id=R_kgDOL45duA data-strict=0 data-theme=noborder_light src=https://giscus.app/client.js></script><script type=module>
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                // 灰白黑色调 + 蓝色点缀
                primaryColor: '#e8e8e8',
                primaryTextColor: '#333',
                primaryBorderColor: '#999',
                lineColor: 'rgb(61, 146, 201)',
                secondaryColor: '#f5f5f5',
                tertiaryColor: '#fafafa',
                background: '#f2f2f2',
                mainBkg: '#f5f5f5',
                nodeBorder: '#999',
                clusterBkg: '#eee',
                clusterBorder: '#ccc',
                titleColor: '#333',
                edgeLabelBackground: '#f2f2f2',
                // 文本颜色
                textColor: '#333',
                nodeTextColor: '#333',
                // 其他
                fontFamily: "'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace"
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        // 查找所有 mermaid 代码块并渲染
        document.querySelectorAll('pre code.language-mermaid').forEach((block, index) => {
            const container = document.createElement('div');
            container.className = 'mermaid';
            container.textContent = block.textContent;
            block.parentNode.replaceWith(container);
        });

        // 渲染所有 mermaid 图表
        await mermaid.run();
    </script><style>.cover-image{text-align:center;margin:1.5em 0 2em 0}.cover-image img{width:60%;height:auto;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)}.mermaid{background:#fafafa;border:1px solid #ddd;padding:20px;margin:20px 0;overflow-x:auto}.mermaid svg{max-width:100%;height:auto}@media (max-width:768px){.cover-image img{width:100%}}</style></div></div><script>document.addEventListener('DOMContentLoaded',function(){const c=document.querySelector('.menu-toggle');const d=document.querySelector('.sidebar');const e=document.querySelector('.overlay');function a(){d.classList.toggle('active');e.classList.toggle('active')}c.addEventListener('click',a);e.addEventListener('click',a);let f=0;let g=0;document.addEventListener('touchstart',h=>{f=h.changedTouches[0].screenX},false);document.addEventListener('touchend',h=>{g=h.changedTouches[0].screenX;b()},false);function b(){const h=g- f;if(h>50&&f<30){d.classList.add('active');e.classList.add('active')}else if(h<-50&&d.classList.contains('active')){d.classList.remove('active');e.classList.remove('active')}}})</script>