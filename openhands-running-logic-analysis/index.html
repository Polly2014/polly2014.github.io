<!doctype html><html><head><title>Polly Blog - AI Assistant, Tutorials, and Insights</title><meta content="Explore Polly Blog for AI tutorials, insights, and updates on cutting-edge technology." name=description><meta content="Polly, Blog, AI Blog, AI Assistant, Tutorials, Technology Blog, Baoli Wang" name=keywords><meta content="width=device-width,initial-scale=1" name=viewport><meta content="text/html; charset=utf-8" http-equiv=content-type><link rel="shortcut icon" href=https://polly2014.github.io/images/polly.ico type=image/x-icon><link href=https://polly2014.github.io/images/polly.ico rel=icon type=image/x-icon><link href=https://polly2014.github.io/images/polly.ico rel=apple-touch-icon><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css rel=stylesheet><link href=https://polly2014.github.io/css/style_new.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-8JD13N7PHS" async></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-8JD13N7PHS')</script><body><div class=menu-toggle><img alt=Menu src=https://polly2014.github.io/images/polly.png></div><div class=overlay></div><div class="pure-g container"><div class="sidebar pure-u-1 pure-u-md-1-5"><div class=title><a class=pure-menu-heading href=https://polly2014.github.io> <img class="avatar pure-img-responsive" src=https://polly2014.github.io/images/polly.png> </a><div class=introduction><p>Polly's Blog</div><div class=nav><ul class=nav-links><li><a href=https://polly2014.github.io><i class="fas fa-home"></i>Home</a><li><a href=https://polly2014.github.io/archive><i class="fas fa-archive"></i>Archive</a><li><a href=https://polly2014.github.io/category><i class="fas fa-folder"></i>Category</a><li><a href=https://polly2014.github.io/blog><i class="fas fa-file-alt"></i>Posts</a><li><a href=https://polly2014.github.io/publication><i class="fas fa-file-pdf"></i>Research</a><li><a href=https://polly2014.github.io/changelog><i class="fas fa-history"></i>Change log</a><li><a href=https://polly2014.github.io/about><i class="fas fa-info-circle"></i>About Me</a></ul></div><div class=social><ul class=social-links><li><a href=mailto:26716201@qq.com><i class="fas fa-envelope"></i></a><li><a href=https://twitter.com/Polly__007><i class="fab fa-twitter"></i></a><li><a href=https://www.linkedin.com/in/baoliwang><i class="fab fa-linkedin-in"></i></a><li><a href=https://github.com/Polly2014><i class="fab fa-github"></i></a></ul></div></div></div><div class="content pure-u-1 pure-u-md-4-5"><div class=blog-post><h1>OpenHands 运行流程分析：杭州三天旅游案例</h1><div class=content><h1 id=openhands-yun-xing-liu-cheng-fen-xi-hang-zhou-san-tian-lu-you-an-li>OpenHands 运行流程分析：杭州三天旅游案例</h1><h2 id=yi-zheng-ti-jia-gou-gai-shu>一、整体架构概述</h2><p>OpenHands 是一个基于 Agent Hub 的智能端到端编码平台，通过多个组件的协同工作来完成用户任务。从日志可以看出，系统主要包括以下核心部分：<ol><li><strong>会话管理器 (Conversation Manager)</strong>：负责创建、管理和跟踪对话<li><strong>代理控制器 (Agent Controller)</strong>：协调各组件的工作流程<li><strong>大模型组件 (LLM)</strong>：使用 Claude 3.7 Sonnet 进行核心推理<li><strong>运行时环境 (Runtime)</strong>：在 Docker 容器中提供安全的执行环境<li><strong>Agent工具集 (Agent Tools)</strong>：包括文件操作、命令执行等各种工具<li><strong>事件流系统 (Event Stream)</strong>：所有组件通过事件流进行通信</ol><h2 id=er-gong-zuo-liu-cheng-fen-jie>二、工作流程分解</h2><h3 id=1-hui-hua-chu-shi-hua-jie-duan>1. 会话初始化阶段</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:08:07 - openhands:INFO: manage_conversations.py:148 - Initializing new conversation
</span><span>12:08:07 - openhands:INFO: manage_conversations.py:54 - Creating conversation
</span></code></pre><p>当用户发起请求时，系统首先初始化一个新的会话，分配一个唯一的会话 ID (<code>740715d40a3c4be385b644a20b0fdfaf</code>)，用于后续所有组件的协调和跟踪。<h3 id=2-pei-zhi-jia-zai-jie-duan>2. 配置加载阶段</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:08:07 - openhands:INFO: manage_conversations.py:58 - Loading settings
</span><span>12:08:07 - openhands:DEBUG: llm.py:385 - Model info: { "key": "claude-3-7-sonnet-20250219", ... }
</span></code></pre><p>系统加载配置信息，包括语言模型的设置、最大token限制、支持的功能等。此案例使用的是 Anthropic 的 Claude 3.7 Sonnet 模型。<h3 id=3-yun-xing-shi-huan-jing-zhun-bei>3. 运行时环境准备</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:08:07 - openhands:DEBUG: agent_session.py:232 - Initializing runtime `docker` now...
</span><span>12:08:08 - openhands:INFO: runtime_build.py:182 - Building image: ghcr.io/all-hands-ai/runtime:oh_v0.29.1...
</span></code></pre><p>系统启动一个隔离的 Docker 容器作为运行时环境，这样可以安全地执行代码而不影响主系统。容器有特定端口映射（53941、56576）用于网络应用访问。<h3 id=4-gong-ju-jia-zai-jie-duan>4. 工具加载阶段</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:08:38 - openhands:DEBUG: codeact_agent.py:75 - TOOLS loaded for CodeActAgent: execute_bash, think, finish, web_read, browser, execute_ipython_cell, str_replace_editor
</span></code></pre><p>系统启动 Agent (CodeActAgent) 并为其加载相关工具，让 Agent 能够执行命令、编辑文件等操作。这些工具是 CodeActAgent 与 Runtime 运行时环境交互的接口。<h3 id=5-yong-hu-shu-ru-chu-li>5. 用户输入处理</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:08:38 - openhands:DEBUG: agent_controller.py:441 - **MessageAction** (source=EventSource.USER)
</span><span>CONTENT: 给我做一个杭州三天春游的规划，给我一个可访问的web让我看规划内容
</span></code></pre><p>系统捕获并处理用户输入，识别出这是一个需要创建网页内容的请求。<h3 id=6-agent-si-kao-yu-gui-hua-jie-duan>6. Agent 思考与规划阶段</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:08:38 - openhands:DEBUG: logger.py:445 - Logging to .../prompt_001.log
</span><span>12:09:37 - openhands:DEBUG: logger.py:445 - Logging to .../response_001.log
</span></code></pre><p>Agent 使用大型语言模型 (Claude 3.7) 分析用户请求，并制定执行计划。这个过程大约持续了59秒，系统记录了完整的思考过程。<h3 id=7-wen-jian-chuang-jian-cao-zuo>7. 文件创建操作</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:09:37 - openhands:DEBUG: stream.py:273 - Adding FileEditAction id=6 from AGENT
</span><span>12:09:37 - openhands:DEBUG: agent_controller.py:795 - **FileEditAction**
</span><span>Path: [/tmp/hangzhou_trip_planner.py]
</span></code></pre><p>Agent Controller 决定创建一个 Flask 网页应用，包含完整的杭州三天春游规划。它使用 <code>str_replace_editor</code> 工具创建文件，并嵌入了 HTML、CSS 和后端逻辑。<h3 id=8-yi-lai-an-zhuang-jie-duan>8. 依赖安装阶段</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:09:40 - openhands:DEBUG: stream.py:273 - Adding CmdRunAction id=8 from AGENT
</span><span>COMMAND: pip install flask flask-cors
</span></code></pre><p>Agent 识别到需要安装依赖库（Flask 和 Flask-CORS），并自动执行安装命令。这显示了 Agent 能够理解和处理依赖关系。<h3 id=9-ying-yong-qi-dong-jie-duan>9. 应用启动阶段</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:09:45 - openhands:DEBUG: stream.py:273 - Adding CmdRunAction id=10 from AGENT
</span><span>COMMAND: python /tmp/hangzhou_trip_planner.py
</span></code></pre><p>安装完依赖后，在运行时环境中启动创建的网页应用。应用在端口 53941 上运行，允许用户通过浏览器访问。<h3 id=10-jie-guo-cheng-xian-jie-duan>10. 结果呈现阶段</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:10:24 - openhands:DEBUG: stream.py:273 - Adding MessageAction id=12 from AGENT
</span><span>CONTENT: 太好了！网页应用已经成功运行起来了。您现在可以通过以下链接访问杭州三天春游规划：http://localhost:53941
</span></code></pre><p>Agent 返回成功消息，告知用户可以通过指定链接访问旅游规划，并提供内容概览。<h2 id=san-he-xin-zu-jian-xiang-jie>三、核心组件详解</h2><h3 id=1-shi-jian-liu-xi-tong>1. 事件流系统</h3><p>整个系统基于事件流工作：<pre style=background:#2b303b;color:#c0c5ce><code><span>12:08:38 - openhands:DEBUG: stream.py:273 - Adding MessageAction id=1 from USER
</span><span>12:08:38 - openhands:DEBUG: stream.py:273 - Adding RecallAction id=3 from USER
</span></code></pre><p>所有操作都被封装为事件，由事件流系统处理，确保组件间通信有序可追踪。<h3 id=2-dai-li-zhuang-tai-guan-li>2. 代理状态管理</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:08:38 - openhands:INFO: agent_controller.py:520 - Setting agent(CodeActAgent) state from AgentState.LOADING to AgentState.RUNNING
</span></code></pre><p>系统维护了代理的状态机，从加载(LOADING)到运行(RUNNING)再到等待用户输入(AWAITING_USER_INPUT)，确保行为的连贯性。<h3 id=3-yu-yan-mo-xing-shi-yong>3. 语言模型使用</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:09:37 - openhands:DEBUG: llm.py:561 - Cost: 0.10 USD | Accumulated Cost: 0.10 USD
</span><span>Response Latency: 58.893 seconds
</span><span>Input tokens: 5411 | Output tokens: 4202
</span></code></pre><p>系统对语言模型的使用非常精确，记录每次调用的成本、延迟和token使用情况，并使用缓存优化性能：<pre style=background:#2b303b;color:#c0c5ce><code><span>Input tokens (cache hit): 9633
</span><span>Input tokens (cache write): 818
</span></code></pre><h3 id=4-dockeryun-xing-shi-huan-jing>4. Docker运行时环境</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:08:08 - openhands:DEBUG: docker_runtime.py:256 - Mount dir: /home/ubuntu/GitHub_Workspace/pro-agent/workspace
</span><span>12:08:08 - openhands:DEBUG: docker_runtime.py:262 - Sandbox workspace: /workspace
</span></code></pre><p>系统创建隔离的Docker容器作为沙盒环境，并挂载必要的目录以保持文件持久性，同时确保安全执行。<h3 id=5-gong-ju-diao-yong-xi-tong>5. 工具调用系统</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>12:09:37 - openhands:DEBUG: conversation_memory.py:207 - Tool calls type: &LTclass 'list'>, value: [ChatCompletionMessageToolCall...]
</span></code></pre><p>Agent通过结构化格式调用工具，每个工具调用都包含明确的参数和目标。这种方式让AI能以一致的方式使用各种系统功能。<h2 id=si-guan-jian-ji-zhu-liang-dian>四、关键技术亮点</h2><ol><li><p><strong>事件驱动架构</strong>：系统通过事件流协调各组件，使复杂流程更容易管理和追踪</p><li><p><strong>沙盒安全执行</strong>：使用Docker容器创建安全的执行环境，防止恶意代码影响宿主系统</p><li><p><strong>智能工具使用</strong>：AI能够识别任务所需的工具链（如依赖安装、代码执行），并按正确顺序使用</p><li><p><strong>清晰的工作流状态</strong>：系统维护代理状态机，确保处理流程的连贯性</p><li><p><strong>资源优化</strong>：通过缓存和累计成本跟踪优化语言模型使用</p><li><p><strong>多模态输出</strong>：不仅生成文字描述，还能创建完整的网页应用，提供更丰富的用户体验</p></ol><h2 id=wu-zhi-xing-liu-cheng-tu>五、执行流程图</h2><details><summary>OpenHands执行流程详细图示 (点击展开)</summary> <p><img alt=OpenHands执行流程图 src=https://polly2014.github.io/openhands-running-logic-analysis/openhands_running_logic.svg></p></details><h2 id=liu-agent-hubjia-gou-de-you-shi>六、Agent Hub架构的优势</h2><p>在OpenHands的Agent Hub架构下，各个组件通过事件流系统紧密协作，形成了一个高效的智能编码生态系统：<ol><li><strong>组件解耦</strong>：每个组件负责特定功能，可以独立升级和维护<li><strong>流程透明</strong>：完整的日志记录和事件跟踪使得系统行为可预测和可调试<li><strong>扩展性强</strong>：新工具可以轻松集成到现有架构中，无需修改核心逻辑<li><strong>安全可控</strong>：Docker运行时提供了隔离执行环境，同时支持丰富的权限控制<li><strong>快速响应</strong>：事件驱动模式确保系统能够实时响应用户输入和环境变化</ol><p>这种架构设计使得OpenHands能够处理从简单的代码生成到复杂的应用开发等多样化任务，同时保持系统的稳定性和安全性。<h2 id=qi-shi-ji-ying-yong-chang-jing-fen-xi>七、实际应用场景分析</h2><p>我们的杭州春游案例展示了OpenHands处理实际问题的能力。值得注意的是，Agent在整个过程中表现出了以下关键能力：<ol><li><strong>需求理解</strong>：正确解析了用户想要一个可访问的网页展示旅游规划的需求<li><strong>技术选型</strong>：自主选择了Flask作为网页框架，适合快速构建轻量级应用<li><strong>依赖管理</strong>：识别并安装了所需的Python包（flask、flask-cors）<li><strong>内容创建</strong>：组织了有价值的旅游信息，包括景点、美食和交通建议<li><strong>用户体验设计</strong>：创建了一个包含CSS样式的美观网页，而不是简单的文本输出<li><strong>端口配置</strong>：正确配置了Web服务器端口，确保用户可访问</ol><p>这个案例完美展示了OpenHands如何从用户简单的自然语言请求出发，通过一系列复杂但协调一致的步骤，最终交付一个完整可用的解决方案。</div><div class=navigation></div></div><div id=giscus-container><h2>留言与讨论</h2><div class=giscus></div></div><script data-category="Blog Comments" async crossorigin data-category-id=DIC_kwDOL45duM4CnjlZ data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=pathname data-reactions-enabled=1 data-repo=Polly2014/polly2014.github.io data-repo-id=R_kgDOL45duA data-strict=0 data-theme=noborder_light src=https://giscus.app/client.js></script></div></div><script>document.addEventListener('DOMContentLoaded',function(){const c=document.querySelector('.menu-toggle');const d=document.querySelector('.sidebar');const e=document.querySelector('.overlay');function a(){d.classList.toggle('active');e.classList.toggle('active')}c.addEventListener('click',a);e.addEventListener('click',a);let f=0;let g=0;document.addEventListener('touchstart',h=>{f=h.changedTouches[0].screenX},false);document.addEventListener('touchend',h=>{g=h.changedTouches[0].screenX;b()},false);function b(){const h=g- f;if(h>50&&f<30){d.classList.add('active');e.classList.add('active')}else if(h<-50&&d.classList.contains('active')){d.classList.remove('active');e.classList.remove('active')}}})</script>