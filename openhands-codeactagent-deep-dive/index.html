<!doctype html><html><head><title>Polly Blog - AI Assistant, Tutorials, and Insights</title><meta content="Explore Polly Blog for AI tutorials, insights, and updates on cutting-edge technology." name=description><meta content="Polly, Blog, AI Blog, AI Assistant, Tutorials, Technology Blog, Baoli Wang" name=keywords><meta content="width=device-width,initial-scale=1" name=viewport><meta content="text/html; charset=utf-8" http-equiv=content-type><link rel="shortcut icon" href=https://polly.wang/images/polly.ico type=image/x-icon><link href=https://polly.wang/images/polly.ico rel=icon type=image/x-icon><link href=https://polly.wang/images/polly.ico rel=apple-touch-icon><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css rel=stylesheet><link href=https://polly.wang/css/style_new.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-8JD13N7PHS" async></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-8JD13N7PHS')</script><body><div class=menu-toggle><img alt=Menu src=https://polly.wang/images/polly.png></div><div class=overlay></div><div class="pure-g container"><div class="sidebar pure-u-1 pure-u-md-1-5"><div class=title><a class=pure-menu-heading href=https://polly.wang> <img class="avatar pure-img-responsive" src=https://polly.wang/images/polly.png> </a><div class=introduction><p>Polly's Blog</div><div class=nav><ul class=nav-links><li><a href=https://polly.wang><i class="fas fa-home"></i>Home</a><li><a href=https://polly.wang/archive><i class="fas fa-archive"></i>Archive</a><li><a href=https://polly.wang/category><i class="fas fa-folder"></i>Category</a><li><a href=https://polly.wang/blog><i class="fas fa-file-alt"></i>Posts</a><li><a href=https://polly.wang/publication><i class="fas fa-file-pdf"></i>Research</a><li><a href=https://polly.wang/changelog><i class="fas fa-history"></i>Change log</a><li><a href=https://polly.wang/about><i class="fas fa-info-circle"></i>About Me</a></ul></div><div class=social><ul class=social-links><li><a href=mailto:26716201@qq.com><i class="fas fa-envelope"></i></a><li><a href=https://twitter.com/Polly__007><i class="fab fa-twitter"></i></a><li><a href=https://www.linkedin.com/in/baoliwang><i class="fab fa-linkedin-in"></i></a><li><a href=https://github.com/Polly2014><i class="fab fa-github"></i></a></ul></div></div></div><div class="content pure-u-1 pure-u-md-4-5"><div class=blog-post><h1>深度解析 OpenHands CodeActAgent: 智能代理的核心架构</h1><div class=content><p>CodeActAgent 是 OpenHands 框架中的核心组件，旨在通过统一的代码操作空间（CodeAct）简化和增强 LLM（大语言模型）代理的功能。本文将详细解析 CodeActAgent 的组成、功能和运作方式，并结合一个具体案例（TODO 应用）展示其工作流程。<hr><h2 id=codeactagent-de-he-xin-zu-cheng>CodeActAgent 的核心组成</h2><p>CodeActAgent 是一个高度模块化的代理，其核心组成部分包括 Profile、Prompt 和 Memory。这些模块共同协作，确保代理能够高效地分解任务、调用工具并与用户交互。<h3 id=1-profile>1. Profile</h3><h4 id=profile-shi-shi-yao>Profile 是什么</h4><ul><li><strong>Profile</strong> 是 CodeActAgent 的配置文件，定义了代理的行为、工具支持、内存管理等。<li>它通过 <code>AgentConfig</code> 类进行配置，包含以下关键参数： <ul><li><code>codeact_enable_browsing</code>：是否启用浏览器工具。<li><code>codeact_enable_jupyter</code>：是否启用 IPython 工具。<li><code>codeact_enable_llm_editor</code>：是否启用基于 LLM 的文件编辑工具。<li><code>condenser</code>：事件压缩器的配置，用于优化内存中的历史记录。<li><code>enable_prompt_extensions</code>：是否启用扩展提示（Prompt）。</ul></ul><h4 id=profile-de-jie-gou>Profile 的结构</h4><p>Profile 是一个字典或对象，包含以下关键参数：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span>config = </span><span style=color:#bf616a>AgentConfig</span><span>(
</span><span>    </span><span style=color:#bf616a>codeact_enable_browsing</span><span>=</span><span style=color:#d08770>True</span><span>,
</span><span>    </span><span style=color:#bf616a>codeact_enable_jupyter</span><span>=</span><span style=color:#d08770>True</span><span>,
</span><span>    </span><span style=color:#bf616a>codeact_enable_llm_editor</span><span>=</span><span style=color:#d08770>False</span><span>,
</span><span>    </span><span style=color:#bf616a>condenser</span><span>={"</span><span style=color:#a3be8c>type</span><span>": "</span><span style=color:#a3be8c>default</span><span>", "</span><span style=color:#a3be8c>max_events</span><span>": </span><span style=color:#d08770>100</span><span>},
</span><span>    </span><span style=color:#bf616a>enable_prompt_extensions</span><span>=</span><span style=color:#d08770>True</span><span>,
</span><span>    </span><span style=color:#bf616a>disabled_microagents</span><span>=["</span><span style=color:#a3be8c>npm</span><span>", "</span><span style=color:#a3be8c>github</span><span>"],
</span><span>)
</span></code></pre><h4 id=profile-de-zuo-yong>Profile 的作用</h4><ul><li>Profile 决定了 CodeActAgent 的能力范围和行为模式。<li>例如： <ul><li>如果启用 <code>codeact_enable_browsing</code>，代理可以使用浏览器工具与网页交互。<li>如果启用 <code>codeact_enable_jupyter</code>，代理可以运行 Python 代码来完成任务。</ul></ul><hr><h3 id=2-prompt>2. Prompt</h3><h4 id=prompt-shi-shi-yao>Prompt 是什么</h4><ul><li><strong>Prompt</strong> 是 CodeActAgent 与 LLM 交互的输入内容，定义了任务的上下文、目标和约束。<li>它通过 <code>PromptManager</code> 动态生成，包含以下部分： <ul><li><strong>系统消息</strong>：定义代理的角色和目标。<li><strong>用户消息</strong>：用户输入的任务描述。<li><strong>工具调用消息</strong>：代理调用工具的记录。<li><strong>观察消息</strong>：工具返回的结果。</ul></ul><h4 id=prompt-de-jie-gou>Prompt 的结构</h4><p>Prompt 是一个消息列表，包含以下类型的消息：<ol><li><p><strong>系统消息</strong>：</p> <pre class=language-plaintext data-lang=plaintext style=background:#2b303b;color:#c0c5ce><code class=language-plaintext data-lang=plaintext><span>System: You are CodeActAgent, a highly capable assistant designed to perform tasks by executing code and interacting with tools.
</span></code></pre><li><p><strong>用户消息</strong>：</p> <pre class=language-plaintext data-lang=plaintext style=background:#2b303b;color:#c0c5ce><code class=language-plaintext data-lang=plaintext><span>User: 创建一个 TODO 应用，支持添加、删除和查看任务。
</span></code></pre><li><p><strong>工具调用消息</strong>：</p> <pre class=language-plaintext data-lang=plaintext style=background:#2b303b;color:#c0c5ce><code class=language-plaintext data-lang=plaintext><span>Assistant: Calling tool: execute_ipython_cell
</span><span>Tool arguments: {"code": "tasks = []"}
</span></code></pre><li><p><strong>观察消息</strong>：</p> <pre class=language-plaintext data-lang=plaintext style=background:#2b303b;color:#c0c5ce><code class=language-plaintext data-lang=plaintext><span>Observation: Tool returned: "Initialized an empty task list."
</span></code></pre></ol><h4 id=prompt-de-sheng-cheng-luo-ji>Prompt 的生成逻辑</h4><p>Prompt 的生成是 CodeActAgent 与 LLM 交互的关键步骤，以下是其详细逻辑：<ol><li><p><strong>系统消息初始化</strong>：</p> <ul><li>CodeActAgent 使用 <code>PromptManager</code> 添加系统消息，定义代理的角色和目标。</ul><li><p><strong>用户消息处理</strong>：</p> <ul><li>用户输入的任务描述被添加到消息列表中。</ul><li><p><strong>工具调用与观察消息</strong>：</p> <ul><li>CodeActAgent 从 <code>ConversationMemory</code> 中提取工具调用记录和观察结果，并将其添加到 Prompt。</ul><li><p><strong>消息增强</strong>：</p> <ul><li>使用 <code>PromptManager</code> 为用户消息添加上下文信息（如示例或扩展信息）。</ul></ol><hr><h3 id=3-memory>3. Memory</h3><h4 id=memory-de-zuo-yong>Memory 的作用</h4><p>Memory 是 CodeActAgent 的会话内存模块，负责记录代理的对话历史、工具调用记录以及观察结果。它通过 <code>ConversationMemory</code> 和 <code>Condenser</code> 协同工作，确保代理能够在多轮交互中保持上下文一致性。<h4 id=memory-de-jie-gou>Memory 的结构</h4><p>Memory 包含以下几个关键部分：<ol><li><strong>事件历史</strong>：存储所有的动作和观察，完整记录代理的交互过程。<li><strong>压缩历史</strong>：通过 <code>Condenser</code> 压缩后的关键事件，优化存储空间并提高检索效率。<li><strong>缓存</strong>：用于特定 LLM 的提示缓存，减少重复计算并提高响应速度。</ol><h4 id=memory-de-gong-zuo-liu-cheng>Memory 的工作流程</h4><ol><li><p><strong>事件记录</strong>：</p> <ul><li>每次工具调用或用户交互都会生成一个事件，并存储到事件历史中。<li>示例：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span>event = {"</span><span style=color:#a3be8c>type</span><span>": "</span><span style=color:#a3be8c>tool_call</span><span>", "</span><span style=color:#a3be8c>tool</span><span>": "</span><span style=color:#a3be8c>execute_ipython_cell</span><span>", "</span><span style=color:#a3be8c>result</span><span>": "</span><span style=color:#a3be8c>Initialized task list.</span><span>"}
</span><span>memory.</span><span style=color:#bf616a>add_event</span><span>(event)
</span></code></pre></ul><li><p><strong>事件压缩</strong>：</p> <ul><li>使用 <code>Condenser</code> 对事件历史进行压缩，提取关键事件以减少冗余。<li>示例：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span>condensed_events = memory.condenser.</span><span style=color:#bf616a>condensed_history</span><span>(state)
</span></code></pre></ul><li><p><strong>上下文检索</strong>：</p> <ul><li>在生成 Prompt 时，Memory 提供上下文信息以确保对话的连贯性。<li>示例：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span>messages = memory.</span><span style=color:#bf616a>process_events</span><span>(</span><span style=color:#bf616a>condensed_history</span><span>=condensed_events)
</span></code></pre></ul></ol><h4 id=zai-todo-ying-yong-zhong-de-zuo-yong>在 TODO 应用中的作用</h4><p>在实现 TODO 应用时，Memory 的主要作用包括：<ul><li><strong>记录任务分解过程</strong>：存储每个子任务的工具调用记录和结果。<li><strong>维护上下文一致性</strong>：确保代理能够根据用户的后续输入调整任务。<li><strong>优化交互效率</strong>：通过事件压缩减少冗余信息，提高响应速度。</ul><h4 id=memory-shi-shi-yao>Memory 是什么</h4><ul><li><strong>Memory</strong> 是代理的会话内存，用于存储对话历史、工具调用记录和观察结果。<li>它通过 <code>ConversationMemory</code> 管理，支持事件压缩和历史记录的动态更新。</ul><h4 id=memory-de-jie-gou-1>Memory 的结构</h4><p>Memory 包含以下部分：<ol><li><strong>事件历史</strong>：存储所有的动作和观察。<li><strong>压缩历史</strong>：通过 <code>Condenser</code> 压缩后的关键事件。<li><strong>缓存</strong>：用于特定 LLM 的提示缓存。</ol><h4 id=memory-de-zuo-yong-1>Memory 的作用</h4><ul><li>Memory 记录了任务的分解过程和工具调用结果，确保代理能够在多轮对话中保持上下文一致。</ul><hr><h2 id=jie-he-an-li-shi-xian-yi-ge-todo-ying-yong>结合案例：实现一个 TODO 应用</h2><h3 id=ren-wu-miao-shu>任务描述</h3><p>用户输入任务：“创建一个 TODO 应用，支持添加、删除和查看任务。”<h3 id=ren-wu-fen-jie>任务分解</h3><p>CodeActAgent 的任务分解通过与 LLM 的交互实现，以下是具体流程：<ol><li><p><strong>用户输入任务</strong>：</p> <ul><li>用户输入任务描述：“创建一个 TODO 应用，支持添加、删除和查看任务。”</ul><li><p><strong>构建 Prompt</strong>：</p> <ul><li>CodeActAgent 构建消息列表并发送给 LLM。</ul><li><p><strong>解析 LLM 响应</strong>：</p> <ul><li>LLM 返回的响应被解析为一系列子任务： <ul><li>初始化任务列表。<li>实现添加任务功能。<li>实现删除任务功能。<li>实现查看任务功能。</ul></ul></ol><h3 id=zi-ren-wu-fen-fa>子任务分发</h3><p>CodeActAgent 的子任务分发通过工具调用实现，以下是具体流程：<ol><li><p><strong>工具调用</strong>：</p> <ul><li>根据子任务调用相应的工具（如执行 Python 代码、编辑文件）。<li>示例：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span>action = </span><span style=color:#bf616a>CmdRunAction</span><span>(</span><span style=color:#bf616a>command</span><span>="</span><span style=color:#a3be8c>tasks = []</span><span>")
</span><span>result = action.</span><span style=color:#bf616a>execute</span><span>()
</span></code></pre></ul><li><p><strong>结果存储</strong>：</p> <ul><li>工具返回的结果被存储为观察消息。<li>示例：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span>observation_message = </span><span style=color:#bf616a>Message</span><span>(</span><span style=color:#bf616a>role</span><span>="</span><span style=color:#a3be8c>observation</span><span>", </span><span style=color:#bf616a>content</span><span>="</span><span style=color:#a3be8c>Tool returned: </span><span style=color:#96b5b4>\"</span><span style=color:#a3be8c>Initialized an empty task list.</span><span style=color:#96b5b4>\"</span><span>")
</span><span>state.</span><span style=color:#bf616a>add_observation</span><span>(observation_message)
</span></code></pre></ul><li><p><strong>反馈给用户</strong>：</p> <ul><li>CodeActAgent 将工具调用结果反馈给用户。<li>示例：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span>final_message = </span><span style=color:#bf616a>Message</span><span>(</span><span style=color:#bf616a>role</span><span>="</span><span style=color:#a3be8c>assistant</span><span>", </span><span style=color:#bf616a>content</span><span>="</span><span style=color:#a3be8c>TODO 应用已创建，支持添加、删除和查看任务。</span><span>")
</span><span>state.</span><span style=color:#bf616a>add_message</span><span>(final_message)
</span></code></pre></ul></ol><hr><h2 id=wan-zheng-shi-xian-shi-li>完整实现示例</h2><p>以下是一个完整的实现示例，展示如何使用 CodeActAgent 创建一个 TODO 应用：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#b48ead>from </span><span>openhands.core.config </span><span style=color:#b48ead>import </span><span>AgentConfig
</span><span style=color:#b48ead>from </span><span>openhands.llm.llm </span><span style=color:#b48ead>import </span><span style=color:#bf616a>LLM
</span><span style=color:#b48ead>from </span><span>openhands.agenthub.codeact_agent.codeact_agent </span><span style=color:#b48ead>import </span><span>CodeActAgent
</span><span style=color:#b48ead>from </span><span>openhands.controller.state.state </span><span style=color:#b48ead>import </span><span>State
</span><span style=color:#b48ead>from </span><span>openhands.core.message </span><span style=color:#b48ead>import </span><span>Message
</span><span>
</span><span style=color:#65737e># 配置代理
</span><span>config = </span><span style=color:#bf616a>AgentConfig</span><span>(
</span><span>    </span><span style=color:#bf616a>codeact_enable_browsing</span><span>=</span><span style=color:#d08770>False</span><span>,
</span><span>    </span><span style=color:#bf616a>codeact_enable_jupyter</span><span>=</span><span style=color:#d08770>True</span><span>,
</span><span>    </span><span style=color:#bf616a>codeact_enable_llm_editor</span><span>=</span><span style=color:#d08770>False</span><span>,
</span><span>    </span><span style=color:#bf616a>condenser</span><span>={"</span><span style=color:#a3be8c>type</span><span>": "</span><span style=color:#a3be8c>default</span><span>", "</span><span style=color:#a3be8c>max_events</span><span>": </span><span style=color:#d08770>50</span><span>},
</span><span>    </span><span style=color:#bf616a>enable_prompt_extensions</span><span>=</span><span style=color:#d08770>True</span><span>,
</span><span>    </span><span style=color:#bf616a>disabled_microagents</span><span>=[],
</span><span>)
</span><span>
</span><span style=color:#65737e># 初始化 LLM 和代理
</span><span>llm = </span><span style=color:#bf616a>LLM</span><span>(</span><span style=color:#bf616a>model_name</span><span>="</span><span style=color:#a3be8c>gpt-4</span><span>")
</span><span>agent = </span><span style=color:#bf616a>CodeActAgent</span><span>(</span><span style=color:#bf616a>llm</span><span>=llm, </span><span style=color:#bf616a>config</span><span>=config)
</span><span>
</span><span style=color:#65737e># 创建初始状态
</span><span>state = </span><span style=color:#bf616a>State</span><span>()
</span><span>
</span><span style=color:#65737e># 用户输入任务
</span><span>user_message = </span><span style=color:#bf616a>Message</span><span>(</span><span style=color:#bf616a>role</span><span>="</span><span style=color:#a3be8c>user</span><span>", </span><span style=color:#bf616a>content</span><span>="</span><span style=color:#a3be8c>创建一个 TODO 应用，支持添加、删除和查看任务。</span><span>")
</span><span>state.</span><span style=color:#bf616a>add_message</span><span>(user_message)
</span><span>
</span><span style=color:#65737e># 构建 Prompt 并与 LLM 交互
</span><span>messages = agent.</span><span style=color:#bf616a>_get_messages</span><span>(state)
</span><span>response = llm.</span><span style=color:#bf616a>completion</span><span>(</span><span style=color:#bf616a>messages</span><span>=agent.llm.</span><span style=color:#bf616a>format_messages_for_llm</span><span>(messages))
</span><span>
</span><span style=color:#65737e># 解析 LLM 响应
</span><span>actions = agent.tools.</span><span style=color:#bf616a>response_to_actions</span><span>(response)
</span><span>
</span><span style=color:#65737e># 执行子任务
</span><span style=color:#b48ead>for </span><span>action </span><span style=color:#b48ead>in </span><span>actions:
</span><span>    result = action.</span><span style=color:#bf616a>execute</span><span>()
</span><span>    observation_message = </span><span style=color:#bf616a>Message</span><span>(</span><span style=color:#bf616a>role</span><span>="</span><span style=color:#a3be8c>observation</span><span>", </span><span style=color:#bf616a>content</span><span>=</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Tool returned: </span><span>{result}")
</span><span>    state.</span><span style=color:#bf616a>add_observation</span><span>(observation_message)
</span><span>
</span><span style=color:#65737e># 反馈结果
</span><span>final_message = </span><span style=color:#bf616a>Message</span><span>(</span><span style=color:#bf616a>role</span><span>="</span><span style=color:#a3be8c>assistant</span><span>", </span><span style=color:#bf616a>content</span><span>="</span><span style=color:#a3be8c>TODO 应用已创建，支持添加、删除和查看任务。</span><span>")
</span><span>state.</span><span style=color:#bf616a>add_message</span><span>(final_message)
</span><span>
</span><span style=color:#65737e># 输出对话历史
</span><span style=color:#b48ead>for </span><span>msg </span><span style=color:#b48ead>in </span><span>state.history:
</span><span>    </span><span style=color:#96b5b4>print</span><span>(</span><span style=color:#b48ead>f</span><span>"{msg.role}</span><span style=color:#a3be8c>: </span><span>{msg.content}")
</span></code></pre><hr><h2 id=zong-jie>总结</h2><p>通过上述分析和实现示例，我们可以清晰地了解 CodeActAgent 的 Prompt 和 Profile，以及它们在任务分解和子任务分发中的作用。您可以根据这些信息手动实现一个类似的代理，并根据任务需求动态生成 Prompt 和配置 Profile。</div><div class=navigation></div></div><div id=giscus-container><h2>留言与讨论</h2><div class=giscus></div></div><script data-category="Blog Comments" async crossorigin data-category-id=DIC_kwDOL45duM4CnjlZ data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=pathname data-reactions-enabled=1 data-repo=Polly2014/polly2014.github.io data-repo-id=R_kgDOL45duA data-strict=0 data-theme=noborder_light src=https://giscus.app/client.js></script></div></div><script>document.addEventListener('DOMContentLoaded',function(){const c=document.querySelector('.menu-toggle');const d=document.querySelector('.sidebar');const e=document.querySelector('.overlay');function a(){d.classList.toggle('active');e.classList.toggle('active')}c.addEventListener('click',a);e.addEventListener('click',a);let f=0;let g=0;document.addEventListener('touchstart',h=>{f=h.changedTouches[0].screenX},false);document.addEventListener('touchend',h=>{g=h.changedTouches[0].screenX;b()},false);function b(){const h=g- f;if(h>50&&f<30){d.classList.add('active');e.classList.add('active')}else if(h<-50&&d.classList.contains('active')){d.classList.remove('active');e.classList.remove('active')}}})</script>