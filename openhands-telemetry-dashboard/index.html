<!doctype html><html><head><title>Polly Blog - AI Assistant, Tutorials, and Insights</title><meta content="Explore Polly Blog for AI tutorials, insights, and updates on cutting-edge technology." name=description><meta content="Polly, Blog, AI Blog, AI Assistant, Tutorials, Technology Blog, Baoli Wang" name=keywords><meta content="width=device-width,initial-scale=1" name=viewport><meta content="text/html; charset=utf-8" http-equiv=content-type><link rel="shortcut icon" href=https://polly2014.github.io/images/polly.ico type=image/x-icon><link href=https://polly2014.github.io/images/polly.ico rel=icon type=image/x-icon><link href=https://polly2014.github.io/images/polly.ico rel=apple-touch-icon><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css rel=stylesheet><link href=https://polly2014.github.io/css/style_new.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-8JD13N7PHS" async></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-8JD13N7PHS')</script><body><div class=menu-toggle><img alt=Menu src=https://polly2014.github.io/images/polly.png></div><div class=overlay></div><div class="pure-g container"><div class="sidebar pure-u-1 pure-u-md-1-5"><div class=title><a class=pure-menu-heading href=https://polly2014.github.io> <img class="avatar pure-img-responsive" src=https://polly2014.github.io/images/polly.png> </a><div class=introduction><p>Polly's Blog</div><div class=nav><ul class=nav-links><li><a href=https://polly2014.github.io><i class="fas fa-home"></i>Home</a><li><a href=https://polly2014.github.io/archive><i class="fas fa-archive"></i>Archive</a><li><a href=https://polly2014.github.io/category><i class="fas fa-folder"></i>Category</a><li><a href=https://polly2014.github.io/blog><i class="fas fa-file-alt"></i>Posts</a><li><a href=https://polly2014.github.io/publication><i class="fas fa-file-pdf"></i>Research</a><li><a href=https://polly2014.github.io/changelog><i class="fas fa-history"></i>Change log</a><li><a href=https://polly2014.github.io/about><i class="fas fa-info-circle"></i>About Me</a></ul></div><div class=social><ul class=social-links><li><a href=mailto:26716201@qq.com><i class="fas fa-envelope"></i></a><li><a href=https://twitter.com/Polly__007><i class="fab fa-twitter"></i></a><li><a href=https://www.linkedin.com/in/baoliwang><i class="fab fa-linkedin-in"></i></a><li><a href=https://github.com/Polly2014><i class="fab fa-github"></i></a></ul></div></div></div><div class="content pure-u-1 pure-u-md-4-5"><div class=blog-post><h1>OpenHands Starter Telemetry Dashboard 实践</h1><div class=content><h2 id=yi-xiang-mu-bei-jing-yu-yi-yi>一、项目背景与意义</h2><p>OpenHands Starter是一个帮助用户快速部署AI开发平台的工具，为了更好地了解用户安装体验和潜在问题，我们需要收集关键遥测数据。然而，原始数据难以直观理解，团队迫切需要一个可视化仪表板，将这些数据转化为有价值的见解。<p>基于此需求，我们设计并实现了OpenHands Starter遥测仪表板，它能够展示关键安装指标、操作系统分布、安装步骤成功率，并提供详细的会话分析功能，帮助开发团队不断优化产品体验。<p><img alt="OpenHands Telemetry Dashboard" src=https://polly2014.github.io/openhands-telemetry-dashboard/dashboard_preview.png><h2 id=er-ji-zhu-zhan-xuan-ze>二、技术栈选择</h2><p>在技术选型上，我们考虑了开发效率、性能和用户体验，最终选定：<ol><li><strong>FastAPI</strong> - 高性能Python后端框架，用于构建API服务<li><strong>MongoDB</strong> - 灵活的文档数据库，适合存储结构多变的遥测数据<li><strong>Streamlit</strong> - 轻量级数据可视化框架，快速构建交互式仪表板<li><strong>Plotly</strong> - 强大的交互式图表库，增强数据可视化体验<li><strong>Docker</strong> - 容器化部署，确保环境一致性和简化部署流程</ol><p>选择FastAPI与Streamlit这一组合是经过深思熟虑的决定。FastAPI提供了高性能的数据处理能力和类型提示优势，Streamlit则极大简化了数据可视化前端开发，二者结合实现了快速开发和卓越性能的平衡。<h2 id=san-jia-gou-she-ji>三、架构设计</h2><p>系统采用前后端分离架构，职责清晰：<pre style=background:#2b303b;color:#c0c5ce><code><span>OpenHands Telemetry Dashboard
</span><span>├── 数据层 (MongoDB)
</span><span>├── API服务层 (FastAPI)
</span><span>│   ├── 数据接收模块
</span><span>│   ├── 数据处理模块
</span><span>│   └── 数据分析模块
</span><span>└── 可视化层 (Streamlit)
</span><span>    ├── 概览仪表板
</span><span>    ├── 详细会话分析
</span><span>    └── 数据导出功能
</span></code></pre><p>整体架构如下：<details><summary>OpenHands Telemetry架构 (点击展开)</summary> <p><img alt="OpenHands Starter Telemetry Dashboard" src=https://polly2014.github.io/openhands-telemetry-dashboard/OpenHands_Starter_Telemetry_Architecture.svg></p></details><h2 id=si-xi-tong-shi-xian-xiang-jie>四、系统实现详解</h2><h3 id=4-1-xiang-mu-jie-gou-she-zhi>4.1 项目结构设置</h3><pre class=language-text data-lang=text style=background:#2b303b;color:#c0c5ce><code class=language-text data-lang=text><span>openhands-telemetry/           # 项目根目录
</span><span>│
</span><span>├── api/                       # API 后端
</span><span>│   ├── venv/                  # Python 虚拟环境
</span><span>│   ├── requirements.txt       # 依赖列表
</span><span>│   └── app/                   # API 源代码目录
</span><span>│       ├── main.py            # 主入口文件
</span><span>│       ├── .env               # 环境变量配置
</span><span>│       ├── routers/           # API 路由
</span><span>│       │   └── telemetry.py
</span><span>│       ├── models/            # 数据模型
</span><span>│       │   └── telemetry.py
</span><span>│       ├── config/            # 配置文件
</span><span>│       │   └── db.py
</span><span>│       └── utils/             # 工具函数
</span><span>│           └── logger.py
</span><span>│
</span><span>├── dashboard/                 # Streamlit 前端
</span><span>│   ├── venv/                  # Python 虚拟环境
</span><span>│   ├── requirements.txt       # 依赖列表
</span><span>│   └── app.py                 # Streamlit 应用
</span><span>│
</span><span>└── docker/                    # Docker 配置
</span><span>    ├── api.Dockerfile
</span><span>    └── dashboard.Dockerfile
</span></code></pre><p>首先，我们创建一个清晰的项目结构：<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>mkdir -p</span><span> openhands-telemetry/{api,dashboard,docker}
</span><span style=color:#96b5b4>cd</span><span> openhands-telemetry
</span></code></pre><h3 id=4-2-fastapihou-duan-shi-xian>4.2 FastAPI后端实现</h3><h4 id=4-2-1-shu-ju-mo-xing-she-ji>4.2.1 数据模型设计</h4><p>定义清晰的数据模型是系统的基础。我们使用Pydantic构建强类型模型：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#65737e># api/app/models/telemetry.py
</span><span style=color:#b48ead>from </span><span>datetime </span><span style=color:#b48ead>import </span><span>datetime
</span><span style=color:#b48ead>from </span><span>typing </span><span style=color:#b48ead>import </span><span>Dict, Any, Optional
</span><span style=color:#b48ead>from </span><span>pydantic </span><span style=color:#b48ead>import </span><span>BaseModel, Field
</span><span>
</span><span style=color:#b48ead>class </span><span style=color:#ebcb8b>TelemetryEvent</span><span style=color:#eff1f5>(</span><span style=color:#a3be8c>BaseModel</span><span style=color:#eff1f5>):
</span><span>    anonymousId: str
</span><span>    sessionId: str
</span><span>    step: str
</span><span>    status: str
</span><span>    timestamp: datetime = </span><span style=color:#bf616a>Field</span><span>(</span><span style=color:#bf616a>default_factory</span><span>=datetime.utcnow)
</span><span>    scriptVersion: Optional[str] = </span><span style=color:#d08770>None
</span><span>    osVersion: Optional[str] = </span><span style=color:#d08770>None 
</span><span>    osName: Optional[str] = </span><span style=color:#d08770>None
</span><span>    cpuArchitecture: Optional[str] = </span><span style=color:#d08770>None
</span><span>    memoryGB: Optional[float] = </span><span style=color:#d08770>None
</span><span>    metrics: Dict[str, Any] = </span><span style=color:#bf616a>Field</span><span>(</span><span style=color:#bf616a>default_factory</span><span>=dict)
</span><span>
</span><span style=color:#b48ead>class </span><span style=color:#ebcb8b>TelemetryStats</span><span style=color:#eff1f5>(</span><span style=color:#a3be8c>BaseModel</span><span style=color:#eff1f5>):
</span><span>    total_sessions: int
</span><span>    successful_installs: int
</span><span>    success_rate: float
</span><span>    installation_by_os: Dict[str, int]
</span><span>    steps_status: Dict[str, Dict[str, int]]
</span><span>    avg_install_time: float
</span></code></pre><h4 id=4-2-2-shu-ju-ku-lian-jie-pei-zhi>4.2.2 数据库连接配置</h4><p>使用Motor作为MongoDB的异步客户端：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#65737e># api/app/config/db.py
</span><span style=color:#b48ead>import </span><span>os
</span><span style=color:#b48ead>from </span><span>motor.motor_asyncio </span><span style=color:#b48ead>import </span><span>AsyncIOMotorClient
</span><span style=color:#b48ead>from </span><span>dotenv </span><span style=color:#b48ead>import </span><span>load_dotenv
</span><span>
</span><span style=color:#bf616a>load_dotenv</span><span>()
</span><span>
</span><span>mongodb_uri = os.</span><span style=color:#bf616a>getenv</span><span>("</span><span style=color:#a3be8c>MONGODB_URI</span><span>", "</span><span style=color:#a3be8c>mongodb://localhost:27017</span><span>")
</span><span>mongodb_db = os.</span><span style=color:#bf616a>getenv</span><span>("</span><span style=color:#a3be8c>MONGODB_DB</span><span>", "</span><span style=color:#a3be8c>openhands_telemetry</span><span>")
</span><span>
</span><span>client = </span><span style=color:#bf616a>AsyncIOMotorClient</span><span>(mongodb_uri)
</span><span>db = client[mongodb_db]
</span><span>
</span><span>telemetry_collection = db.telemetry_events
</span></code></pre><h4 id=4-2-3-he-xin-apilu-you-shi-xian>4.2.3 核心API路由实现</h4><p>实现数据接收与分析API：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#65737e># api/app/routers/telemetry.py
</span><span style=color:#b48ead>from </span><span>fastapi </span><span style=color:#b48ead>import </span><span>APIRouter, HTTPException, status
</span><span style=color:#b48ead>from </span><span>datetime </span><span style=color:#b48ead>import </span><span>datetime, timedelta
</span><span style=color:#b48ead>from </span><span>typing </span><span style=color:#b48ead>import </span><span>Dict, Any, List
</span><span>
</span><span style=color:#b48ead>from ..</span><span>models.telemetry </span><span style=color:#b48ead>import </span><span>TelemetryEvent, TelemetryStats
</span><span style=color:#b48ead>from ..</span><span>config.db </span><span style=color:#b48ead>import </span><span>telemetry_collection
</span><span style=color:#b48ead>from ..</span><span>utils.logger </span><span style=color:#b48ead>import </span><span>get_logger
</span><span>
</span><span>router = </span><span style=color:#bf616a>APIRouter</span><span>(</span><span style=color:#bf616a>prefix</span><span>="</span><span style=color:#a3be8c>/api/telemetry</span><span>", </span><span style=color:#bf616a>tags</span><span>=["</span><span style=color:#a3be8c>telemetry</span><span>"])
</span><span>logger = </span><span style=color:#bf616a>get_logger</span><span>("</span><span style=color:#a3be8c>telemetry_router</span><span>")
</span><span>
</span><span>@router.</span><span style=color:#bf616a>post</span><span>("</span><span style=color:#a3be8c>/</span><span>", </span><span style=color:#bf616a>status_code</span><span>=status.</span><span style=color:#bf616a>HTTP_201_CREATED</span><span>)
</span><span style=color:#b48ead>async def </span><span style=color:#8fa1b3>receive_telemetry</span><span>(</span><span style=color:#bf616a>event</span><span>: Dict[str, Any]):
</span><span>    </span><span style=color:#65737e>"""接收遥测数据"""
</span><span>    </span><span style=color:#b48ead>try</span><span>:
</span><span>        </span><span style=color:#65737e># 提取基础字段
</span><span>        telemetry_data = {
</span><span>            "</span><span style=color:#a3be8c>anonymousId</span><span>": event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>anonymousId</span><span>"),
</span><span>            "</span><span style=color:#a3be8c>sessionId</span><span>": event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>sessionId</span><span>"),
</span><span>            "</span><span style=color:#a3be8c>step</span><span>": event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>step</span><span>"),
</span><span>            "</span><span style=color:#a3be8c>status</span><span>": event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>status</span><span>"),
</span><span>            "</span><span style=color:#a3be8c>scriptVersion</span><span>": event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>scriptVersion</span><span>"),
</span><span>            "</span><span style=color:#a3be8c>osVersion</span><span>": event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>osVersion</span><span>"),
</span><span>            "</span><span style=color:#a3be8c>osName</span><span>": event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>osName</span><span>"),
</span><span>            "</span><span style=color:#a3be8c>cpuArchitecture</span><span>": event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>cpuArchitecture</span><span>"),
</span><span>            "</span><span style=color:#a3be8c>memoryGB</span><span>": event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>memoryGB</span><span>")
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#65737e># 处理时间戳
</span><span>        timestamp = event.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>timestamp</span><span>")
</span><span>        </span><span style=color:#b48ead>if </span><span>timestamp:
</span><span>            </span><span style=color:#b48ead>try</span><span>:
</span><span>                telemetry_data["</span><span style=color:#a3be8c>timestamp</span><span>"] = datetime.</span><span style=color:#bf616a>fromisoformat</span><span>(timestamp.</span><span style=color:#bf616a>replace</span><span>("</span><span style=color:#a3be8c>Z</span><span>", "</span><span style=color:#a3be8c>+00:00</span><span>"))
</span><span>            </span><span style=color:#b48ead>except </span><span>(ValueError, TypeError):
</span><span>                telemetry_data["</span><span style=color:#a3be8c>timestamp</span><span>"] = datetime.</span><span style=color:#bf616a>utcnow</span><span>()
</span><span>        </span><span style=color:#b48ead>else</span><span>:
</span><span>            telemetry_data["</span><span style=color:#a3be8c>timestamp</span><span>"] = datetime.</span><span style=color:#bf616a>utcnow</span><span>()
</span><span>        
</span><span>        </span><span style=color:#65737e># 额外的指标数据
</span><span>        metrics = {}
</span><span>        </span><span style=color:#b48ead>for </span><span>key, value </span><span style=color:#b48ead>in </span><span>event.</span><span style=color:#bf616a>items</span><span>():
</span><span>            </span><span style=color:#b48ead>if </span><span>key not in telemetry_data:
</span><span>                metrics[key] = value
</span><span>        
</span><span>        telemetry_data["</span><span style=color:#a3be8c>metrics</span><span>"] = metrics
</span><span>        
</span><span>        </span><span style=color:#65737e># 存储到数据库
</span><span>        result = </span><span style=color:#b48ead>await </span><span>telemetry_collection.</span><span style=color:#bf616a>insert_one</span><span>(telemetry_data)
</span><span>        
</span><span>        </span><span style=color:#b48ead>return </span><span>{"</span><span style=color:#a3be8c>status</span><span>": "</span><span style=color:#a3be8c>success</span><span>", "</span><span style=color:#a3be8c>id</span><span>": </span><span style=color:#bf616a>str</span><span>(result.inserted_id)}
</span><span>    
</span><span>    </span><span style=color:#b48ead>except </span><span>Exception </span><span style=color:#b48ead>as </span><span>e:
</span><span>        logger.</span><span style=color:#bf616a>error</span><span>(</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Error processing telemetry: </span><span>{</span><span style=color:#bf616a>str</span><span>(e)}")
</span><span>        </span><span style=color:#b48ead>raise </span><span style=color:#bf616a>HTTPException</span><span>(
</span><span>            </span><span style=color:#bf616a>status_code</span><span>=status.</span><span style=color:#bf616a>HTTP_500_INTERNAL_SERVER_ERROR</span><span>,
</span><span>            </span><span style=color:#bf616a>detail</span><span>=</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Failed to process telemetry data: </span><span>{</span><span style=color:#bf616a>str</span><span>(e)}"
</span><span>        )
</span></code></pre><h4 id=4-2-4-tong-ji-shu-ju-api>4.2.4 统计数据API</h4><p>实现用于仪表板的数据统计API：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span>@router.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>/stats</span><span>", </span><span style=color:#bf616a>response_model</span><span>=TelemetryStats)
</span><span style=color:#b48ead>async def </span><span style=color:#8fa1b3>get_telemetry_stats</span><span>():
</span><span>    </span><span style=color:#65737e>"""获取遥测数据统计摘要"""
</span><span>    </span><span style=color:#b48ead>try</span><span>:
</span><span>        </span><span style=color:#65737e># 获取会话总数
</span><span>        total_sessions = </span><span style=color:#96b5b4>len</span><span>(</span><span style=color:#b48ead>await </span><span>telemetry_collection.</span><span style=color:#bf616a>distinct</span><span>("</span><span style=color:#a3be8c>sessionId</span><span>"))
</span><span>        
</span><span>        </span><span style=color:#65737e># 获取成功安装数
</span><span>        completed_installs = </span><span style=color:#b48ead>await </span><span>telemetry_collection.</span><span style=color:#bf616a>count_documents</span><span>({
</span><span>            "</span><span style=color:#a3be8c>step</span><span>": "</span><span style=color:#a3be8c>install</span><span>",
</span><span>            "</span><span style=color:#a3be8c>status</span><span>": "</span><span style=color:#a3be8c>completed</span><span>",
</span><span>            "</span><span style=color:#a3be8c>metrics.success</span><span>": </span><span style=color:#d08770>True
</span><span>        })
</span><span>        
</span><span>        </span><span style=color:#65737e># 计算成功率
</span><span>        success_rate = (completed_installs / total_sessions * </span><span style=color:#d08770>100</span><span>) </span><span style=color:#b48ead>if </span><span>total_sessions > </span><span style=color:#d08770>0 </span><span style=color:#b48ead>else </span><span style=color:#d08770>0
</span><span>        
</span><span>        </span><span style=color:#65737e># 获取按操作系统划分的安装数
</span><span>        os_pipeline = [
</span><span>            {"</span><span style=color:#a3be8c>$group</span><span>": {
</span><span>                "</span><span style=color:#a3be8c>_id</span><span>": "</span><span style=color:#a3be8c>$osName</span><span>",
</span><span>                "</span><span style=color:#a3be8c>count</span><span>": {"</span><span style=color:#a3be8c>$sum</span><span>": </span><span style=color:#d08770>1</span><span>}
</span><span>            }},
</span><span>            {"</span><span style=color:#a3be8c>$match</span><span>": {"</span><span style=color:#a3be8c>_id</span><span>": {"</span><span style=color:#a3be8c>$ne</span><span>": </span><span style=color:#d08770>None</span><span>}}}
</span><span>        ]
</span><span>        
</span><span>        os_result = </span><span style=color:#b48ead>await </span><span>telemetry_collection.</span><span style=color:#bf616a>aggregate</span><span>(os_pipeline).</span><span style=color:#bf616a>to_list</span><span>(</span><span style=color:#d08770>None</span><span>)
</span><span>        installation_by_os = {item["</span><span style=color:#a3be8c>_id</span><span>"]: item["</span><span style=color:#a3be8c>count</span><span>"] </span><span style=color:#b48ead>for </span><span>item </span><span style=color:#b48ead>in </span><span>os_result}
</span><span>        
</span><span>        </span><span style=color:#65737e># 获取按步骤划分的状态统计
</span><span>        steps_pipeline = [
</span><span>            {"</span><span style=color:#a3be8c>$group</span><span>": {
</span><span>                "</span><span style=color:#a3be8c>_id</span><span>": {"</span><span style=color:#a3be8c>step</span><span>": "</span><span style=color:#a3be8c>$step</span><span>", "</span><span style=color:#a3be8c>status</span><span>": "</span><span style=color:#a3be8c>$status</span><span>"},
</span><span>                "</span><span style=color:#a3be8c>count</span><span>": {"</span><span style=color:#a3be8c>$sum</span><span>": </span><span style=color:#d08770>1</span><span>}
</span><span>            }}
</span><span>        ]
</span><span>        
</span><span>        steps_result = </span><span style=color:#b48ead>await </span><span>telemetry_collection.</span><span style=color:#bf616a>aggregate</span><span>(steps_pipeline).</span><span style=color:#bf616a>to_list</span><span>(</span><span style=color:#d08770>None</span><span>)
</span><span>        
</span><span>        steps_status = {}
</span><span>        </span><span style=color:#b48ead>for </span><span>item </span><span style=color:#b48ead>in </span><span>steps_result:
</span><span>            step = item["</span><span style=color:#a3be8c>_id</span><span>"]["</span><span style=color:#a3be8c>step</span><span>"]
</span><span>            status = item["</span><span style=color:#a3be8c>_id</span><span>"]["</span><span style=color:#a3be8c>status</span><span>"]
</span><span>            count = item["</span><span style=color:#a3be8c>count</span><span>"]
</span><span>            
</span><span>            </span><span style=color:#b48ead>if </span><span>step not in steps_status:
</span><span>                steps_status[step] = {}
</span><span>            
</span><span>            steps_status[step][status] = count
</span><span>        
</span><span>        </span><span style=color:#65737e># 计算平均安装时间
</span><span>        time_pipeline = [
</span><span>            {"</span><span style=color:#a3be8c>$match</span><span>": {
</span><span>                "</span><span style=color:#a3be8c>step</span><span>": "</span><span style=color:#a3be8c>install</span><span>"
</span><span>            }},
</span><span>            {"</span><span style=color:#a3be8c>$group</span><span>": {
</span><span>                "</span><span style=color:#a3be8c>_id</span><span>": "</span><span style=color:#a3be8c>$sessionId</span><span>",
</span><span>                "</span><span style=color:#a3be8c>minTime</span><span>": {"</span><span style=color:#a3be8c>$min</span><span>": "</span><span style=color:#a3be8c>$timestamp</span><span>"},
</span><span>                "</span><span style=color:#a3be8c>maxTime</span><span>": {"</span><span style=color:#a3be8c>$max</span><span>": "</span><span style=color:#a3be8c>$timestamp</span><span>"}
</span><span>            }},
</span><span>            {"</span><span style=color:#a3be8c>$project</span><span>": {
</span><span>                "</span><span style=color:#a3be8c>_id</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>                "</span><span style=color:#a3be8c>duration</span><span>": {"</span><span style=color:#a3be8c>$subtract</span><span>": ["</span><span style=color:#a3be8c>$maxTime</span><span>", "</span><span style=color:#a3be8c>$minTime</span><span>"]}
</span><span>            }},
</span><span>            {"</span><span style=color:#a3be8c>$group</span><span>": {
</span><span>                "</span><span style=color:#a3be8c>_id</span><span>": </span><span style=color:#d08770>None</span><span>,
</span><span>                "</span><span style=color:#a3be8c>avgDuration</span><span>": {"</span><span style=color:#a3be8c>$avg</span><span>": "</span><span style=color:#a3be8c>$duration</span><span>"}
</span><span>            }}
</span><span>        ]
</span><span>        
</span><span>        time_result = </span><span style=color:#b48ead>await </span><span>telemetry_collection.</span><span style=color:#bf616a>aggregate</span><span>(time_pipeline).</span><span style=color:#bf616a>to_list</span><span>(</span><span style=color:#d08770>None</span><span>)
</span><span>        avg_install_time = </span><span style=color:#d08770>0
</span><span>        
</span><span>        </span><span style=color:#b48ead>if </span><span>time_result:
</span><span>            </span><span style=color:#65737e># 转换为秒
</span><span>            avg_install_time = time_result[</span><span style=color:#d08770>0</span><span>]["</span><span style=color:#a3be8c>avgDuration</span><span>"] / </span><span style=color:#d08770>1000 </span><span style=color:#b48ead>if </span><span>time_result </span><span style=color:#b48ead>else </span><span style=color:#d08770>0
</span><span>        
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#bf616a>TelemetryStats</span><span>(
</span><span>            </span><span style=color:#bf616a>total_sessions</span><span>=total_sessions,
</span><span>            </span><span style=color:#bf616a>successful_installs</span><span>=completed_installs,
</span><span>            </span><span style=color:#bf616a>success_rate</span><span>=success_rate,
</span><span>            </span><span style=color:#bf616a>installation_by_os</span><span>=installation_by_os,
</span><span>            </span><span style=color:#bf616a>steps_status</span><span>=steps_status,
</span><span>            </span><span style=color:#bf616a>avg_install_time</span><span>=avg_install_time
</span><span>        )
</span><span>    
</span><span>    </span><span style=color:#b48ead>except </span><span>Exception </span><span style=color:#b48ead>as </span><span>e:
</span><span>        logger.</span><span style=color:#bf616a>error</span><span>(</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Error generating telemetry stats: </span><span>{</span><span style=color:#bf616a>str</span><span>(e)}")
</span><span>        </span><span style=color:#b48ead>raise </span><span style=color:#bf616a>HTTPException</span><span>(
</span><span>            </span><span style=color:#bf616a>status_code</span><span>=status.</span><span style=color:#bf616a>HTTP_500_INTERNAL_SERVER_ERROR</span><span>,
</span><span>            </span><span style=color:#bf616a>detail</span><span>=</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Failed to generate telemetry statistics: </span><span>{</span><span style=color:#bf616a>str</span><span>(e)}"
</span><span>        )
</span></code></pre><h4 id=4-2-5-hui-hua-xiang-qing-api>4.2.5 会话详情API</h4><pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span>@router.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>/sessions/</span><span style=color:#d08770>{session_id}</span><span style=color:#a3be8c>/events</span><span>")
</span><span style=color:#b48ead>async def </span><span style=color:#8fa1b3>get_session_events</span><span>(</span><span style=color:#bf616a>session_id</span><span>: str):
</span><span>    </span><span style=color:#65737e>"""获取指定会话的事件序列"""
</span><span>    </span><span style=color:#b48ead>try</span><span>:
</span><span>        events = </span><span style=color:#b48ead>await </span><span>telemetry_collection.</span><span style=color:#bf616a>find</span><span>(
</span><span>            {"</span><span style=color:#a3be8c>sessionId</span><span>": session_id}
</span><span>        ).</span><span style=color:#bf616a>sort</span><span>("</span><span style=color:#a3be8c>timestamp</span><span>", </span><span style=color:#d08770>1</span><span>).</span><span style=color:#bf616a>to_list</span><span>(</span><span style=color:#d08770>None</span><span>)
</span><span>        
</span><span>        </span><span style=color:#65737e># 转换 ObjectId 为字符串
</span><span>        </span><span style=color:#b48ead>for </span><span>event </span><span style=color:#b48ead>in </span><span>events:
</span><span>            event["</span><span style=color:#a3be8c>_id</span><span>"] = </span><span style=color:#bf616a>str</span><span>(event["</span><span style=color:#a3be8c>_id</span><span>"])
</span><span>        
</span><span>        </span><span style=color:#b48ead>if </span><span>not events:
</span><span>            </span><span style=color:#b48ead>raise </span><span style=color:#bf616a>HTTPException</span><span>(
</span><span>                </span><span style=color:#bf616a>status_code</span><span>=status.</span><span style=color:#bf616a>HTTP_404_NOT_FOUND</span><span>,
</span><span>                </span><span style=color:#bf616a>detail</span><span>=</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Session with ID </span><span>{session_id}</span><span style=color:#a3be8c> not found</span><span>"
</span><span>            )
</span><span>            
</span><span>        </span><span style=color:#b48ead>return </span><span>{"</span><span style=color:#a3be8c>session_id</span><span>": session_id, "</span><span style=color:#a3be8c>events</span><span>": events}
</span><span>    
</span><span>    </span><span style=color:#b48ead>except </span><span>HTTPException:
</span><span>        </span><span style=color:#b48ead>raise
</span><span>    </span><span style=color:#b48ead>except </span><span>Exception </span><span style=color:#b48ead>as </span><span>e:
</span><span>        logger.</span><span style=color:#bf616a>error</span><span>(</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Error retrieving session events: </span><span>{</span><span style=color:#bf616a>str</span><span>(e)}")
</span><span>        </span><span style=color:#b48ead>raise </span><span style=color:#bf616a>HTTPException</span><span>(
</span><span>            </span><span style=color:#bf616a>status_code</span><span>=status.</span><span style=color:#bf616a>HTTP_500_INTERNAL_SERVER_ERROR</span><span>,
</span><span>            </span><span style=color:#bf616a>detail</span><span>=</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Failed to retrieve session events: </span><span>{</span><span style=color:#bf616a>str</span><span>(e)}"
</span><span>        )
</span></code></pre><h4 id=4-2-6-ying-yong-ru-kou-dian>4.2.6 应用入口点</h4><p>将所有组件连接到FastAPI应用：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#65737e># api/app/main.py
</span><span style=color:#b48ead>from </span><span>fastapi </span><span style=color:#b48ead>import </span><span>FastAPI
</span><span style=color:#b48ead>from </span><span>fastapi.middleware.cors </span><span style=color:#b48ead>import </span><span>CORSMiddleware
</span><span style=color:#b48ead>import </span><span>uvicorn
</span><span style=color:#b48ead>import </span><span>os
</span><span style=color:#b48ead>from </span><span>dotenv </span><span style=color:#b48ead>import </span><span>load_dotenv
</span><span>
</span><span style=color:#b48ead>from .</span><span>routers </span><span style=color:#b48ead>import </span><span>telemetry
</span><span style=color:#b48ead>from .</span><span>utils.logger </span><span style=color:#b48ead>import </span><span>get_logger
</span><span>
</span><span style=color:#65737e># 加载环境变量
</span><span style=color:#bf616a>load_dotenv</span><span>()
</span><span>
</span><span style=color:#65737e># 初始化 FastAPI 应用
</span><span>app = </span><span style=color:#bf616a>FastAPI</span><span>(
</span><span>    </span><span style=color:#bf616a>title</span><span>="</span><span style=color:#a3be8c>OpenHands Telemetry API</span><span>",
</span><span>    </span><span style=color:#bf616a>description</span><span>="</span><span style=color:#a3be8c>API for receiving and analyzing OpenHands installation telemetry</span><span>",
</span><span>    </span><span style=color:#bf616a>version</span><span>="</span><span style=color:#a3be8c>1.0.0</span><span>"
</span><span>)
</span><span>
</span><span style=color:#65737e># 添加CORS中间件
</span><span>app.</span><span style=color:#bf616a>add_middleware</span><span>(
</span><span>    CORSMiddleware,
</span><span>    </span><span style=color:#bf616a>allow_origins</span><span>=["</span><span style=color:#a3be8c>*</span><span>"],  </span><span style=color:#65737e># 在生产环境中应限制为特定域名
</span><span>    </span><span style=color:#bf616a>allow_credentials</span><span>=</span><span style=color:#d08770>True</span><span>,
</span><span>    </span><span style=color:#bf616a>allow_methods</span><span>=["</span><span style=color:#a3be8c>*</span><span>"],
</span><span>    </span><span style=color:#bf616a>allow_headers</span><span>=["</span><span style=color:#a3be8c>*</span><span>"],
</span><span>)
</span><span>
</span><span style=color:#65737e># 包含路由
</span><span>app.</span><span style=color:#bf616a>include_router</span><span>(telemetry.router)
</span><span>
</span><span style=color:#65737e># 根路由
</span><span>@app.</span><span style=color:#bf616a>get</span><span>("</span><span style=color:#a3be8c>/</span><span>")
</span><span style=color:#b48ead>async def </span><span style=color:#8fa1b3>root</span><span>():
</span><span>    </span><span style=color:#b48ead>return </span><span>{
</span><span>        "</span><span style=color:#a3be8c>message</span><span>": "</span><span style=color:#a3be8c>Welcome to OpenHands Telemetry API</span><span>",
</span><span>        "</span><span style=color:#a3be8c>documentation</span><span>": "</span><span style=color:#a3be8c>/docs</span><span>",
</span><span>    }
</span><span>
</span><span style=color:#b48ead>if </span><span>__name__ == "</span><span style=color:#a3be8c>__main__</span><span>":
</span><span>    port = </span><span style=color:#bf616a>int</span><span>(os.</span><span style=color:#bf616a>getenv</span><span>("</span><span style=color:#a3be8c>API_PORT</span><span>", </span><span style=color:#d08770>9999</span><span>))
</span><span>    uvicorn.</span><span style=color:#bf616a>run</span><span>("</span><span style=color:#a3be8c>app.main:app</span><span>", </span><span style=color:#bf616a>host</span><span>="</span><span style=color:#a3be8c>0.0.0.0</span><span>", </span><span style=color:#bf616a>port</span><span>=port, </span><span style=color:#bf616a>reload</span><span>=</span><span style=color:#d08770>True</span><span>)
</span></code></pre><h3 id=4-3-streamlityi-biao-ban-shi-xian>4.3 Streamlit仪表板实现</h3><p>Streamlit让我们能够快速创建交互式数据可视化界面：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#65737e># dashboard/app.py
</span><span style=color:#b48ead>import </span><span>streamlit </span><span style=color:#b48ead>as </span><span>st
</span><span style=color:#b48ead>import </span><span>pandas </span><span style=color:#b48ead>as </span><span>pd
</span><span style=color:#b48ead>import </span><span>plotly.express </span><span style=color:#b48ead>as </span><span>px
</span><span style=color:#b48ead>import </span><span>plotly.graph_objects </span><span style=color:#b48ead>as </span><span>go
</span><span style=color:#b48ead>import </span><span>requests
</span><span style=color:#b48ead>from </span><span>datetime </span><span style=color:#b48ead>import </span><span>datetime, timedelta
</span><span style=color:#b48ead>import </span><span>os
</span><span style=color:#b48ead>from </span><span>dotenv </span><span style=color:#b48ead>import </span><span>load_dotenv
</span><span>
</span><span style=color:#65737e># 加载环境变量
</span><span style=color:#bf616a>load_dotenv</span><span>()
</span><span>
</span><span style=color:#65737e># 设置页面配置
</span><span>st.</span><span style=color:#bf616a>set_page_config</span><span>(
</span><span>    </span><span style=color:#bf616a>page_title</span><span>="</span><span style=color:#a3be8c>OpenHands Telemetry Dashboard</span><span>",
</span><span>    </span><span style=color:#bf616a>page_icon</span><span>="</span><span style=color:#a3be8c>📊</span><span>",
</span><span>    </span><span style=color:#bf616a>layout</span><span>="</span><span style=color:#a3be8c>wide</span><span>"
</span><span>)
</span><span>
</span><span style=color:#65737e># 配置
</span><span style=color:#bf616a>API_URL </span><span>= os.</span><span style=color:#bf616a>getenv</span><span>("</span><span style=color:#a3be8c>API_URL</span><span>", "</span><span style=color:#a3be8c>http://localhost:9999</span><span>")
</span><span>
</span><span style=color:#65737e># 页面标题
</span><span>st.</span><span style=color:#bf616a>title</span><span>("</span><span style=color:#a3be8c>OpenHands Telemetry Dashboard</span><span>")
</span><span>st.</span><span style=color:#bf616a>markdown</span><span>("</span><span style=color:#a3be8c>### Installation Telemetry Analytics</span><span>")
</span><span>
</span><span style=color:#65737e># 在仪表板中添加日期选择器
</span><span>st.sidebar.</span><span style=color:#bf616a>header</span><span>("</span><span style=color:#a3be8c>筛选器</span><span>")
</span><span>date_options = ["</span><span style=color:#a3be8c>最近7天</span><span>", "</span><span style=color:#a3be8c>最近30天</span><span>", "</span><span style=color:#a3be8c>最近90天</span><span>", "</span><span style=color:#a3be8c>全部</span><span>"]
</span><span>date_filter = st.sidebar.</span><span style=color:#bf616a>selectbox</span><span>("</span><span style=color:#a3be8c>时间范围</span><span>", date_options)
</span><span>
</span><span style=color:#65737e># 根据日期筛选修改 API 请求
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>filter_by_date</span><span>(</span><span style=color:#bf616a>date_filter</span><span>):
</span><span>    today = datetime.</span><span style=color:#bf616a>utcnow</span><span>()
</span><span>    </span><span style=color:#b48ead>if </span><span>date_filter == "</span><span style=color:#a3be8c>最近7天</span><span>":
</span><span>        start_date = today - </span><span style=color:#bf616a>timedelta</span><span>(</span><span style=color:#bf616a>days</span><span>=</span><span style=color:#d08770>7</span><span>)
</span><span>    </span><span style=color:#b48ead>elif </span><span>date_filter == "</span><span style=color:#a3be8c>最近30天</span><span>":
</span><span>        start_date = today - </span><span style=color:#bf616a>timedelta</span><span>(</span><span style=color:#bf616a>days</span><span>=</span><span style=color:#d08770>30</span><span>)
</span><span>    </span><span style=color:#b48ead>elif </span><span>date_filter == "</span><span style=color:#a3be8c>最近90天</span><span>":
</span><span>        start_date = today - </span><span style=color:#bf616a>timedelta</span><span>(</span><span style=color:#bf616a>days</span><span>=</span><span style=color:#d08770>90</span><span>)
</span><span>    </span><span style=color:#b48ead>else</span><span>:
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#d08770>None  </span><span style=color:#65737e># 全部数据
</span><span>    
</span><span>    </span><span style=color:#b48ead>return </span><span>start_date.</span><span style=color:#bf616a>isoformat</span><span>()
</span><span>
</span><span style=color:#65737e># 获取统计数据
</span><span>@st.</span><span style=color:#bf616a>cache_data</span><span>(</span><span style=color:#bf616a>ttl</span><span>=</span><span style=color:#d08770>300</span><span>)  </span><span style=color:#65737e># 缓存5分钟
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>get_telemetry_stats</span><span>():
</span><span>    </span><span style=color:#b48ead>try</span><span>:
</span><span>        response = requests.</span><span style=color:#bf616a>get</span><span>(</span><span style=color:#b48ead>f</span><span>"{</span><span style=color:#bf616a>API_URL</span><span>}</span><span style=color:#a3be8c>/api/telemetry/stats</span><span>")
</span><span>        response.</span><span style=color:#bf616a>raise_for_status</span><span>()
</span><span>        </span><span style=color:#b48ead>return </span><span>response.</span><span style=color:#bf616a>json</span><span>()
</span><span>    </span><span style=color:#b48ead>except </span><span>Exception </span><span style=color:#b48ead>as </span><span>e:
</span><span>        st.</span><span style=color:#bf616a>error</span><span>(</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Error fetching telemetry stats: </span><span>{</span><span style=color:#bf616a>str</span><span>(e)}")
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#d08770>None
</span><span>
</span><span style=color:#65737e># 获取最近会话
</span><span>@st.</span><span style=color:#bf616a>cache_data</span><span>(</span><span style=color:#bf616a>ttl</span><span>=</span><span style=color:#d08770>300</span><span>)
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>get_recent_sessions</span><span>(</span><span style=color:#bf616a>limit</span><span>=</span><span style=color:#d08770>10</span><span>):
</span><span>    </span><span style=color:#b48ead>try</span><span>:
</span><span>        response = requests.</span><span style=color:#bf616a>get</span><span>(</span><span style=color:#b48ead>f</span><span>"{</span><span style=color:#bf616a>API_URL</span><span>}</span><span style=color:#a3be8c>/api/telemetry/recent?limit=</span><span>{limit}")
</span><span>        response.</span><span style=color:#bf616a>raise_for_status</span><span>()
</span><span>        </span><span style=color:#b48ead>return </span><span>response.</span><span style=color:#bf616a>json</span><span>()
</span><span>    </span><span style=color:#b48ead>except </span><span>Exception </span><span style=color:#b48ead>as </span><span>e:
</span><span>        st.</span><span style=color:#bf616a>error</span><span>(</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Error fetching recent sessions: </span><span>{</span><span style=color:#bf616a>str</span><span>(e)}")
</span><span>        </span><span style=color:#b48ead>return </span><span>[]
</span><span>
</span><span style=color:#65737e># 获取会话详情
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>get_session_events</span><span>(</span><span style=color:#bf616a>session_id</span><span>):
</span><span>    </span><span style=color:#b48ead>try</span><span>:
</span><span>        response = requests.</span><span style=color:#bf616a>get</span><span>(</span><span style=color:#b48ead>f</span><span>"{</span><span style=color:#bf616a>API_URL</span><span>}</span><span style=color:#a3be8c>/api/telemetry/sessions/</span><span>{session_id}</span><span style=color:#a3be8c>/events</span><span>")
</span><span>        response.</span><span style=color:#bf616a>raise_for_status</span><span>()
</span><span>        </span><span style=color:#b48ead>return </span><span>response.</span><span style=color:#bf616a>json</span><span>()
</span><span>    </span><span style=color:#b48ead>except </span><span>Exception </span><span style=color:#b48ead>as </span><span>e:
</span><span>        st.</span><span style=color:#bf616a>error</span><span>(</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>Error fetching session events: </span><span>{</span><span style=color:#bf616a>str</span><span>(e)}")
</span><span>        </span><span style=color:#b48ead>return </span><span style=color:#d08770>None
</span><span>
</span><span style=color:#65737e># 导出功能
</span><span style=color:#b48ead>def </span><span style=color:#8fa1b3>export_to_csv</span><span>(</span><span style=color:#bf616a>df</span><span>, </span><span style=color:#bf616a>filename</span><span>):
</span><span>    </span><span style=color:#b48ead>return </span><span>df.</span><span style=color:#bf616a>to_csv</span><span>().</span><span style=color:#bf616a>encode</span><span>('</span><span style=color:#a3be8c>utf-8</span><span>')
</span><span>
</span><span style=color:#65737e># 刷新按钮
</span><span style=color:#b48ead>if </span><span>st.</span><span style=color:#bf616a>button</span><span>("</span><span style=color:#a3be8c>刷新数据</span><span>"):
</span><span>    st.cache_data.</span><span style=color:#bf616a>clear</span><span>()
</span><span>    st.</span><span style=color:#bf616a>success</span><span>("</span><span style=color:#a3be8c>数据已刷新!</span><span>")
</span><span>
</span><span style=color:#65737e># 获取数据
</span><span>stats = </span><span style=color:#bf616a>get_telemetry_stats</span><span>()
</span><span>recent_sessions = </span><span style=color:#bf616a>get_recent_sessions</span><span>(</span><span style=color:#d08770>20</span><span>)
</span><span>
</span><span style=color:#65737e># 显示KPI卡片
</span><span style=color:#b48ead>if </span><span>stats:
</span><span>    col1, col2, col3, col4 = st.</span><span style=color:#bf616a>columns</span><span>(</span><span style=color:#d08770>4</span><span>)
</span><span>    </span><span style=color:#b48ead>with </span><span>col1:
</span><span>        st.</span><span style=color:#bf616a>metric</span><span>("</span><span style=color:#a3be8c>总安装次数</span><span>", stats['</span><span style=color:#a3be8c>total_sessions</span><span>'])
</span><span>    </span><span style=color:#b48ead>with </span><span>col2:
</span><span>        st.</span><span style=color:#bf616a>metric</span><span>("</span><span style=color:#a3be8c>成功安装</span><span>", stats['</span><span style=color:#a3be8c>successful_installs</span><span>'])
</span><span>    </span><span style=color:#b48ead>with </span><span>col3:
</span><span>        st.</span><span style=color:#bf616a>metric</span><span>("</span><span style=color:#a3be8c>成功率</span><span>", </span><span style=color:#b48ead>f</span><span>"{stats['</span><span style=color:#a3be8c>success_rate</span><span>']</span><span style=color:#d08770>:.1f</span><span>}</span><span style=color:#a3be8c>%</span><span>")
</span><span>    </span><span style=color:#b48ead>with </span><span>col4:
</span><span>        st.</span><span style=color:#bf616a>metric</span><span>("</span><span style=color:#a3be8c>平均安装时间</span><span>", </span><span style=color:#b48ead>f</span><span>"{stats['</span><span style=color:#a3be8c>avg_install_time</span><span>']</span><span style=color:#d08770>:.1f</span><span>}</span><span style=color:#a3be8c> 秒</span><span>")
</span><span>
</span><span>    </span><span style=color:#65737e># 创建操作系统分布图表
</span><span>    st.</span><span style=color:#bf616a>subheader</span><span>("</span><span style=color:#a3be8c>按操作系统分类的安装数</span><span>")
</span><span>    os_data = pd.</span><span style=color:#bf616a>DataFrame</span><span>({
</span><span>        "</span><span style=color:#a3be8c>操作系统</span><span>": stats["</span><span style=color:#a3be8c>installation_by_os</span><span>"].</span><span style=color:#bf616a>keys</span><span>(),
</span><span>        "</span><span style=color:#a3be8c>安装数</span><span>": stats["</span><span style=color:#a3be8c>installation_by_os</span><span>"].</span><span style=color:#bf616a>values</span><span>()
</span><span>    })
</span><span>    
</span><span>    </span><span style=color:#b48ead>if </span><span>not os_data.empty:
</span><span>        fig = px.</span><span style=color:#bf616a>pie</span><span>(os_data, </span><span style=color:#bf616a>names</span><span>="</span><span style=color:#a3be8c>操作系统</span><span>", </span><span style=color:#bf616a>values</span><span>="</span><span style=color:#a3be8c>安装数</span><span>", </span><span style=color:#bf616a>hole</span><span>=</span><span style=color:#d08770>0.4</span><span>)
</span><span>        fig.</span><span style=color:#bf616a>update_layout</span><span>(</span><span style=color:#bf616a>height</span><span>=</span><span style=color:#d08770>400</span><span>)
</span><span>        st.</span><span style=color:#bf616a>plotly_chart</span><span>(fig, </span><span style=color:#bf616a>use_container_width</span><span>=</span><span style=color:#d08770>True</span><span>)
</span><span>    </span><span style=color:#b48ead>else</span><span>:
</span><span>        st.</span><span style=color:#bf616a>info</span><span>("</span><span style=color:#a3be8c>暂无操作系统数据</span><span>")
</span><span>
</span><span>    </span><span style=color:#65737e># 创建步骤成功率图表
</span><span>    st.</span><span style=color:#bf616a>subheader</span><span>("</span><span style=color:#a3be8c>安装步骤状态分布</span><span>")
</span><span>    
</span><span>    steps_data = []
</span><span>    </span><span style=color:#b48ead>for </span><span>step, statuses </span><span style=color:#b48ead>in </span><span>stats["</span><span style=color:#a3be8c>steps_status</span><span>"].</span><span style=color:#bf616a>items</span><span>():
</span><span>        total = </span><span style=color:#96b5b4>sum</span><span>(statuses.</span><span style=color:#bf616a>values</span><span>())
</span><span>        </span><span style=color:#b48ead>for </span><span>status, count </span><span style=color:#b48ead>in </span><span>statuses.</span><span style=color:#bf616a>items</span><span>():
</span><span>            steps_data.</span><span style=color:#bf616a>append</span><span>({
</span><span>                "</span><span style=color:#a3be8c>步骤</span><span>": step,
</span><span>                "</span><span style=color:#a3be8c>状态</span><span>": status,
</span><span>                "</span><span style=color:#a3be8c>数量</span><span>": count,
</span><span>                "</span><span style=color:#a3be8c>百分比</span><span>": (count / total * </span><span style=color:#d08770>100</span><span>) </span><span style=color:#b48ead>if </span><span>total > </span><span style=color:#d08770>0 </span><span style=color:#b48ead>else </span><span style=color:#d08770>0
</span><span>            })
</span><span>    
</span><span>    steps_df = pd.</span><span style=color:#bf616a>DataFrame</span><span>(steps_data)
</span><span>    </span><span style=color:#b48ead>if </span><span>not steps_df.empty:
</span><span>        fig = px.</span><span style=color:#bf616a>bar</span><span>(
</span><span>            steps_df,
</span><span>            </span><span style=color:#bf616a>x</span><span>="</span><span style=color:#a3be8c>步骤</span><span>",
</span><span>            </span><span style=color:#bf616a>y</span><span>="</span><span style=color:#a3be8c>数量</span><span>",
</span><span>            </span><span style=color:#bf616a>color</span><span>="</span><span style=color:#a3be8c>状态</span><span>",
</span><span>            </span><span style=color:#bf616a>barmode</span><span>="</span><span style=color:#a3be8c>stack</span><span>",
</span><span>            </span><span style=color:#bf616a>text</span><span>="</span><span style=color:#a3be8c>百分比</span><span>",
</span><span>            </span><span style=color:#bf616a>labels</span><span>={"</span><span style=color:#a3be8c>百分比</span><span>": "</span><span style=color:#a3be8c>%</span><span>"}
</span><span>        )
</span><span>        fig.</span><span style=color:#bf616a>update_layout</span><span>(</span><span style=color:#bf616a>height</span><span>=</span><span style=color:#d08770>500</span><span>)
</span><span>        st.</span><span style=color:#bf616a>plotly_chart</span><span>(fig, </span><span style=color:#bf616a>use_container_width</span><span>=</span><span style=color:#d08770>True</span><span>)
</span><span>    </span><span style=color:#b48ead>else</span><span>:
</span><span>        st.</span><span style=color:#bf616a>info</span><span>("</span><span style=color:#a3be8c>暂无步骤数据</span><span>")
</span><span style=color:#b48ead>else</span><span>:
</span><span>    st.</span><span style=color:#bf616a>warning</span><span>("</span><span style=color:#a3be8c>无法获取统计数据。请确保后端API正在运行。</span><span>")
</span><span>
</span><span style=color:#65737e># 显示最近会话
</span><span>st.</span><span style=color:#bf616a>subheader</span><span>("</span><span style=color:#a3be8c>最近安装会话</span><span>")
</span><span style=color:#b48ead>if </span><span>recent_sessions:
</span><span>    </span><span style=color:#65737e># 创建会话表格
</span><span>    sessions_df = pd.</span><span style=color:#bf616a>DataFrame</span><span>(recent_sessions)
</span><span>    sessions_df["</span><span style=color:#a3be8c>timestamp</span><span>"] = pd.</span><span style=color:#bf616a>to_datetime</span><span>(sessions_df["</span><span style=color:#a3be8c>timestamp</span><span>"])
</span><span>    sessions_df["</span><span style=color:#a3be8c>时间</span><span>"] = sessions_df["</span><span style=color:#a3be8c>timestamp</span><span>"].dt.</span><span style=color:#bf616a>strftime</span><span>("</span><span style=color:#d08770>%Y</span><span style=color:#a3be8c>-</span><span style=color:#d08770>%m</span><span style=color:#a3be8c>-</span><span style=color:#d08770>%d %H</span><span style=color:#a3be8c>:</span><span style=color:#d08770>%M</span><span style=color:#a3be8c>:</span><span style=color:#d08770>%S</span><span>")
</span><span>    sessions_df["</span><span style=color:#a3be8c>状态</span><span>"] = sessions_df["</span><span style=color:#a3be8c>success</span><span>"].</span><span style=color:#bf616a>apply</span><span>(</span><span style=color:#b48ead>lambda </span><span style=color:#bf616a>x</span><span>: "</span><span style=color:#a3be8c>成功</span><span>" </span><span style=color:#b48ead>if </span><span>x </span><span style=color:#b48ead>else </span><span>"</span><span style=color:#a3be8c>失败</span><span>")
</span><span>    sessions_df["</span><span style=color:#a3be8c>持续时间</span><span>"] = sessions_df["</span><span style=color:#a3be8c>duration_seconds</span><span>"].</span><span style=color:#bf616a>apply</span><span>(</span><span style=color:#b48ead>lambda </span><span style=color:#bf616a>x</span><span>: </span><span style=color:#b48ead>f</span><span>"{x</span><span style=color:#d08770>:.1f</span><span>}</span><span style=color:#a3be8c> 秒</span><span>")
</span><span>    
</span><span>    </span><span style=color:#65737e># 使用Streamlit的列格式化
</span><span>    sessions_display = sessions_df[["</span><span style=color:#a3be8c>session_id</span><span>", "</span><span style=color:#a3be8c>时间</span><span>", "</span><span style=color:#a3be8c>状态</span><span>", "</span><span style=color:#a3be8c>持续时间</span><span>", "</span><span style=color:#a3be8c>os</span><span>"]]
</span><span>    sessions_display.columns = ["</span><span style=color:#a3be8c>会话ID</span><span>", "</span><span style=color:#a3be8c>时间</span><span>", "</span><span style=color:#a3be8c>状态</span><span>", "</span><span style=color:#a3be8c>持续时间</span><span>", "</span><span style=color:#a3be8c>操作系统</span><span>"]
</span><span>
</span><span>    </span><span style=color:#65737e># 添加导出功能
</span><span>    csv = </span><span style=color:#bf616a>export_to_csv</span><span>(sessions_df, "</span><span style=color:#a3be8c>sessions.csv</span><span>")
</span><span>    st.</span><span style=color:#bf616a>download_button</span><span>(
</span><span>        </span><span style=color:#bf616a>label</span><span>="</span><span style=color:#a3be8c>导出会话数据为CSV</span><span>",
</span><span>        </span><span style=color:#bf616a>data</span><span>=csv,
</span><span>        </span><span style=color:#bf616a>file_name</span><span>="</span><span style=color:#a3be8c>openhands_sessions.csv</span><span>",
</span><span>        </span><span style=color:#bf616a>mime</span><span>="</span><span style=color:#a3be8c>text/csv</span><span>",
</span><span>    )
</span><span>    
</span><span>    </span><span style=color:#65737e># 增加会话详情展开功能
</span><span>    selected_session = st.</span><span style=color:#bf616a>selectbox</span><span>("</span><span style=color:#a3be8c>选择会话查看详情:</span><span>", sessions_df["</span><span style=color:#a3be8c>session_id</span><span>"].</span><span style=color:#bf616a>tolist</span><span>())
</span><span>    
</span><span>    </span><span style=color:#b48ead>if </span><span>selected_session:
</span><span>        session_data = </span><span style=color:#bf616a>get_session_events</span><span>(selected_session)
</span><span>        </span><span style=color:#b48ead>if </span><span>session_data and session_data["</span><span style=color:#a3be8c>events</span><span>"]:
</span><span>            st.</span><span style=color:#bf616a>subheader</span><span>(</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>会话 </span><span>{selected_session}</span><span style=color:#a3be8c> 详情</span><span>")
</span><span>            
</span><span>            events = session_data["</span><span style=color:#a3be8c>events</span><span>"]
</span><span>            events_df = pd.</span><span style=color:#bf616a>DataFrame</span><span>(events)
</span><span>            
</span><span>            </span><span style=color:#65737e># 为时间轴创建数据
</span><span>            events_df["</span><span style=color:#a3be8c>timestamp</span><span>"] = pd.</span><span style=color:#bf616a>to_datetime</span><span>(events_df["</span><span style=color:#a3be8c>timestamp</span><span>"])
</span><span>            events_df = events_df.</span><span style=color:#bf616a>sort_values</span><span>("</span><span style=color:#a3be8c>timestamp</span><span>")
</span><span>            
</span><span>            </span><span style=color:#65737e># 创建时间轴可视化
</span><span>            fig = go.</span><span style=color:#bf616a>Figure</span><span>()
</span><span>            
</span><span>            </span><span style=color:#b48ead>for </span><span>i, event </span><span style=color:#b48ead>in </span><span>events_df.</span><span style=color:#bf616a>iterrows</span><span>():
</span><span>                </span><span style=color:#65737e># 根据事件状态设置颜色
</span><span>                color = "</span><span style=color:#a3be8c>green</span><span>"
</span><span>                </span><span style=color:#b48ead>if </span><span>event["</span><span style=color:#a3be8c>status</span><span>"] == "</span><span style=color:#a3be8c>failure</span><span>":
</span><span>                    color = "</span><span style=color:#a3be8c>red</span><span>"
</span><span>                </span><span style=color:#b48ead>elif </span><span>event["</span><span style=color:#a3be8c>status</span><span>"] == "</span><span style=color:#a3be8c>warning</span><span>" or event["</span><span style=color:#a3be8c>status</span><span>"] == "</span><span style=color:#a3be8c>partial</span><span>":
</span><span>                    color = "</span><span style=color:#a3be8c>orange</span><span>"
</span><span>                
</span><span>                </span><span style=color:#65737e># 添加事件点
</span><span>                fig.</span><span style=color:#bf616a>add_trace</span><span>(go.</span><span style=color:#bf616a>Scatter</span><span>(
</span><span>                    </span><span style=color:#bf616a>x</span><span>=[event["</span><span style=color:#a3be8c>timestamp</span><span>"]],
</span><span>                    </span><span style=color:#bf616a>y</span><span>=[event["</span><span style=color:#a3be8c>step</span><span>"]],
</span><span>                    </span><span style=color:#bf616a>mode</span><span>="</span><span style=color:#a3be8c>markers+text</span><span>",
</span><span>                    </span><span style=color:#bf616a>marker</span><span>=</span><span style=color:#bf616a>dict</span><span>(</span><span style=color:#bf616a>color</span><span>=color, </span><span style=color:#bf616a>size</span><span>=</span><span style=color:#d08770>15</span><span>),
</span><span>                    </span><span style=color:#bf616a>text</span><span>=[event["</span><span style=color:#a3be8c>status</span><span>"]],
</span><span>                    </span><span style=color:#bf616a>textposition</span><span>="</span><span style=color:#a3be8c>top center</span><span>",
</span><span>                    </span><span style=color:#bf616a>name</span><span>=</span><span style=color:#b48ead>f</span><span>"{event['</span><span style=color:#a3be8c>step</span><span>']}</span><span style=color:#a3be8c> - </span><span>{event['</span><span style=color:#a3be8c>status</span><span>']}"
</span><span>                ))
</span><span>            
</span><span>            fig.</span><span style=color:#bf616a>update_layout</span><span>(
</span><span>                </span><span style=color:#bf616a>title</span><span>="</span><span style=color:#a3be8c>安装步骤时间轴</span><span>",
</span><span>                </span><span style=color:#bf616a>xaxis_title</span><span>="</span><span style=color:#a3be8c>时间</span><span>",
</span><span>                </span><span style=color:#bf616a>yaxis_title</span><span>="</span><span style=color:#a3be8c>安装步骤</span><span>",
</span><span>                </span><span style=color:#bf616a>height</span><span>=</span><span style=color:#d08770>500
</span><span>            )
</span><span>            
</span><span>            st.</span><span style=color:#bf616a>plotly_chart</span><span>(fig, </span><span style=color:#bf616a>use_container_width</span><span>=</span><span style=color:#d08770>True</span><span>)
</span><span>            
</span><span>            </span><span style=color:#65737e># 显示事件详情
</span><span>            </span><span style=color:#b48ead>with </span><span>st.</span><span style=color:#bf616a>expander</span><span>("</span><span style=color:#a3be8c>查看会话事件详情</span><span>"):
</span><span>                </span><span style=color:#65737e># 选择要展示的列
</span><span>                display_cols = ["</span><span style=color:#a3be8c>step</span><span>", "</span><span style=color:#a3be8c>status</span><span>", "</span><span style=color:#a3be8c>timestamp</span><span>"]
</span><span>                st.</span><span style=color:#bf616a>dataframe</span><span>(events_df[display_cols])
</span><span>                
</span><span>                </span><span style=color:#65737e># 显示最后一个事件的详细指标
</span><span>                </span><span style=color:#b48ead>if </span><span>"</span><span style=color:#a3be8c>metrics</span><span>" in events_df.columns:
</span><span>                    last_event = events_df.iloc[-</span><span style=color:#d08770>1</span><span>]
</span><span>                    </span><span style=color:#b48ead>if </span><span style=color:#96b5b4>isinstance</span><span>(last_event["</span><span style=color:#a3be8c>metrics</span><span>"], dict) and last_event["</span><span style=color:#a3be8c>metrics</span><span>"]:
</span><span>                        st.</span><span style=color:#bf616a>subheader</span><span>("</span><span style=color:#a3be8c>最终指标</span><span>")
</span><span>                        </span><span style=color:#b48ead>for </span><span>key, value </span><span style=color:#b48ead>in </span><span>last_event["</span><span style=color:#a3be8c>metrics</span><span>"].</span><span style=color:#bf616a>items</span><span>():
</span><span>                            st.</span><span style=color:#bf616a>text</span><span>(</span><span style=color:#b48ead>f</span><span>"{key}</span><span style=color:#a3be8c>: </span><span>{value}")
</span><span style=color:#b48ead>else</span><span>:
</span><span>    st.</span><span style=color:#bf616a>info</span><span>("</span><span style=color:#a3be8c>暂无最近会话数据</span><span>")
</span><span>
</span><span style=color:#65737e># 页脚
</span><span>st.</span><span style=color:#bf616a>markdown</span><span>("</span><span style=color:#a3be8c>---</span><span>")
</span><span>st.</span><span style=color:#bf616a>markdown</span><span>("</span><span style=color:#a3be8c>OpenHands Telemetry Dashboard | © 2025</span><span>")
</span></code></pre><h3 id=4-4-rong-qi-hua-pei-zhi>4.4 容器化配置</h3><h4 id=4-4-1-apifu-wu-rong-qi>4.4.1 API服务容器</h4><pre class=language-dockerfile data-lang=dockerfile style=background:#2b303b;color:#c0c5ce><code class=language-dockerfile data-lang=dockerfile><span style=color:#65737e># docker/api.Dockerfile
</span><span style=color:#b48ead>FROM</span><span> python:3.11-slim
</span><span>
</span><span style=color:#b48ead>WORKDIR </span><span>/app
</span><span>
</span><span style=color:#b48ead>COPY</span><span> api/requirements.txt .
</span><span>
</span><span style=color:#b48ead>RUN </span><span>pip install --no-cache-dir -r requirements.txt
</span><span>
</span><span style=color:#b48ead>COPY</span><span> api/app ./app
</span><span>
</span><span>CMD ["</span><span style=color:#a3be8c>uvicorn</span><span>", "</span><span style=color:#a3be8c>app.main:app</span><span>", "</span><span style=color:#a3be8c>--host</span><span>", "</span><span style=color:#a3be8c>0.0.0.0</span><span>", "</span><span style=color:#a3be8c>--port</span><span>", "</span><span style=color:#a3be8c>9999</span><span>"]
</span></code></pre><h4 id=4-4-2-streamlityi-biao-ban-rong-qi>4.4.2 Streamlit仪表板容器</h4><pre class=language-dockerfile data-lang=dockerfile style=background:#2b303b;color:#c0c5ce><code class=language-dockerfile data-lang=dockerfile><span style=color:#65737e># docker/dashboard.Dockerfile
</span><span style=color:#b48ead>FROM</span><span> python:3.11-slim
</span><span>
</span><span style=color:#b48ead>WORKDIR </span><span>/app
</span><span>
</span><span style=color:#b48ead>COPY</span><span> dashboard/requirements.txt .
</span><span>
</span><span style=color:#b48ead>RUN </span><span>pip install --no-cache-dir -r requirements.txt
</span><span>
</span><span style=color:#b48ead>COPY</span><span> dashboard/app.py .
</span><span>
</span><span style=color:#b48ead>EXPOSE </span><span>8501
</span><span>
</span><span>CMD ["</span><span style=color:#a3be8c>streamlit</span><span>", "</span><span style=color:#a3be8c>run</span><span>", "</span><span style=color:#a3be8c>app.py</span><span>"]
</span></code></pre><h4 id=4-4-3-docker-composepei-zhi>4.4.3 Docker Compose配置</h4><pre class=language-yaml data-lang=yaml style=background:#2b303b;color:#c0c5ce><code class=language-yaml data-lang=yaml><span style=color:#65737e># docker-compose.yml
</span><span style=color:#bf616a>services</span><span>:
</span><span>  </span><span style=color:#bf616a>mongodb</span><span>:
</span><span>    </span><span style=color:#bf616a>image</span><span>: </span><span style=color:#a3be8c>mongo:6.0.5
</span><span>    </span><span style=color:#bf616a>ports</span><span>:
</span><span>      - "</span><span style=color:#a3be8c>27017:27017</span><span>"
</span><span>    </span><span style=color:#bf616a>volumes</span><span>:
</span><span>      - </span><span style=color:#a3be8c>mongo_data:/data/db
</span><span>    </span><span style=color:#bf616a>restart</span><span>: </span><span style=color:#a3be8c>always
</span><span>    
</span><span>  </span><span style=color:#bf616a>api</span><span>:
</span><span>    </span><span style=color:#bf616a>build</span><span>:
</span><span>      </span><span style=color:#bf616a>context</span><span>: </span><span style=color:#d08770>.
</span><span>      </span><span style=color:#bf616a>dockerfile</span><span>: </span><span style=color:#a3be8c>docker/api.Dockerfile
</span><span>    </span><span style=color:#bf616a>ports</span><span>:
</span><span>      - "</span><span style=color:#a3be8c>9999:9999</span><span>"
</span><span>    </span><span style=color:#bf616a>depends_on</span><span>:
</span><span>      - </span><span style=color:#a3be8c>mongodb
</span><span>    </span><span style=color:#bf616a>environment</span><span>:
</span><span>      - </span><span style=color:#a3be8c>MONGODB_URI=mongodb://mongodb:27017
</span><span>      - </span><span style=color:#a3be8c>MONGODB_DB=openhands_telemetry
</span><span>      - </span><span style=color:#a3be8c>ENVIRONMENT=production
</span><span>    </span><span style=color:#bf616a>restart</span><span>: </span><span style=color:#a3be8c>always
</span><span>    
</span><span>  </span><span style=color:#bf616a>dashboard</span><span>:
</span><span>    </span><span style=color:#bf616a>build</span><span>:
</span><span>      </span><span style=color:#bf616a>context</span><span>: </span><span style=color:#d08770>.
</span><span>      </span><span style=color:#bf616a>dockerfile</span><span>: </span><span style=color:#a3be8c>docker/dashboard.Dockerfile
</span><span>    </span><span style=color:#bf616a>ports</span><span>:
</span><span>      - "</span><span style=color:#a3be8c>8501:8501</span><span>"
</span><span>    </span><span style=color:#bf616a>depends_on</span><span>:
</span><span>      - </span><span style=color:#a3be8c>api
</span><span>    </span><span style=color:#bf616a>environment</span><span>:
</span><span>      - </span><span style=color:#a3be8c>API_URL=http://api:9999
</span><span>    </span><span style=color:#bf616a>restart</span><span>: </span><span style=color:#a3be8c>always
</span><span>
</span><span style=color:#bf616a>volumes</span><span>:
</span><span>  </span><span style=color:#bf616a>mongo_data</span><span>:
</span></code></pre><h2 id=wu-bu-shu-yu-pei-zhi>五、部署与配置</h2><h3 id=5-1-chuang-jian-yi-lai-wen-jian>5.1 创建依赖文件</h3><p>项目依赖管理是确保环境一致性的关键：<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#65737e># API依赖
</span><span style=color:#96b5b4>cd</span><span> api
</span><span style=color:#bf616a>python -m</span><span> venv venv
</span><span style=color:#96b5b4>source</span><span> venv/bin/activate  </span><span style=color:#65737e># Windows: venv\Scripts\activate
</span><span style=color:#bf616a>pip</span><span> install fastapi uvicorn motor pymongo pandas python-dotenv
</span><span style=color:#bf616a>pip</span><span> freeze > requirements.txt
</span><span>
</span><span style=color:#65737e># Dashboard依赖
</span><span style=color:#96b5b4>cd</span><span> ../dashboard
</span><span style=color:#bf616a>python -m</span><span> venv venv
</span><span style=color:#96b5b4>source</span><span> venv/bin/activate  </span><span style=color:#65737e># Windows: venv\Scripts\activate
</span><span style=color:#bf616a>pip</span><span> install streamlit pandas matplotlib plotly requests python-dotenv
</span><span style=color:#bf616a>pip</span><span> freeze > requirements.txt
</span></code></pre><h3 id=5-2-gou-jian-yu-qi-dong-fu-wu>5.2 构建与启动服务</h3><p>使用Docker Compose简化部署流程：<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#65737e># 构建镜像
</span><span style=color:#bf616a>docker-compose</span><span> build
</span><span>
</span><span style=color:#65737e># 启动服务
</span><span style=color:#bf616a>docker-compose</span><span> up</span><span style=color:#bf616a> -d
</span></code></pre><h3 id=5-3-chu-shi-hua-ce-shi-shu-ju>5.3 初始化测试数据</h3><p>为验证仪表板功能，我们可以发送一些测试数据：<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#65737e># 测试数据发送脚本
</span><span style=color:#bf616a>import</span><span> requests
</span><span style=color:#bf616a>import</span><span> json
</span><span style=color:#bf616a>from</span><span> datetime import datetime, timedelta
</span><span style=color:#bf616a>import</span><span> random
</span><span style=color:#bf616a>import</span><span> uuid
</span><span>
</span><span style=color:#bf616a>API_URL</span><span> = "</span><span style=color:#a3be8c>http://localhost:9999</span><span>"
</span><span>
</span><span style=color:#65737e># 生成一些会话ID
</span><span style=color:#bf616a>session_ids</span><span> = </span><span style=color:#b48ead>[</span><span>str(uuid.uuid4()) for _ in range(5)</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>os_names</span><span> = </span><span style=color:#b48ead>[</span><span>"</span><span style=color:#a3be8c>Windows</span><span>", "</span><span style=color:#a3be8c>MacOS</span><span>", "</span><span style=color:#a3be8c>Linux</span><span>"</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>os_versions</span><span> = </span><span style=color:#b48ead>[</span><span>"</span><span style=color:#a3be8c>Windows 10</span><span>", "</span><span style=color:#a3be8c>Windows 11</span><span>", "</span><span style=color:#a3be8c>MacOS 12.5</span><span>", "</span><span style=color:#a3be8c>Ubuntu 22.04</span><span>"</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>steps</span><span> = </span><span style=color:#b48ead>[</span><span>"</span><span style=color:#a3be8c>check_prerequisites</span><span>", "</span><span style=color:#a3be8c>download_docker</span><span>", "</span><span style=color:#a3be8c>install_docker</span><span>", "</span><span style=color:#a3be8c>configure_docker</span><span>", "</span><span style=color:#a3be8c>install</span><span>"</span><span style=color:#b48ead>]
</span><span style=color:#bf616a>statuses</span><span> = </span><span style=color:#b48ead>[</span><span>"</span><span style=color:#a3be8c>started</span><span>", "</span><span style=color:#a3be8c>in_progress</span><span>", "</span><span style=color:#a3be8c>completed</span><span>", "</span><span style=color:#a3be8c>warning</span><span>", "</span><span style=color:#a3be8c>failure</span><span>"</span><span style=color:#b48ead>]
</span><span>
</span><span style=color:#65737e># 生成随机事件
</span><span style=color:#b48ead>for</span><span> session_id </span><span style=color:#b48ead>in</span><span> session_ids:
</span><span>    </span><span style=color:#bf616a>anonymous_id</span><span> = str(uuid.uuid4())</span><span style=color:#bf616a>[:16]
</span><span>    </span><span style=color:#bf616a>os_name</span><span> = random.choice(os_names)
</span><span>    </span><span style=color:#bf616a>os_version</span><span> = random.choice(</span><span style=color:#b48ead>[</span><span>v for v in os_versions if os_name in v</span><span style=color:#b48ead>]</span><span>)
</span><span>    
</span><span>    </span><span style=color:#65737e># 为每个会话创建一系列事件
</span><span>    </span><span style=color:#bf616a>base_time</span><span> = datetime.utcnow() </span><span style=color:#bf616a>-</span><span> timedelta(days=random.randint(0, 6))
</span><span>    
</span><span>    </span><span style=color:#65737e># 随机决定这个会话是否成功
</span><span>    </span><span style=color:#bf616a>success</span><span> = random.random() > </span><span style=color:#d08770>0</span><span style=color:#bf616a>.3
</span><span>    
</span><span>    </span><span style=color:#b48ead>for</span><span> i, step </span><span style=color:#b48ead>in</span><span> enumerate(steps)</span><span style=color:#96b5b4>:
</span><span>        </span><span style=color:#65737e># 每个步骤的时间增加一些随机值
</span><span>        </span><span style=color:#bf616a>event_time</span><span> = base_time + timedelta(minutes=i*5 + random.randint(1, 3))
</span><span>        
</span><span>        </span><span style=color:#65737e># 对于失败的会话，可能在某个步骤失败
</span><span>        </span><span style=color:#b48ead>if </span><span style=color:#bf616a>not</span><span> success and i > </span><span style=color:#d08770>2</span><span> and random.random() > </span><span style=color:#d08770>0</span><span style=color:#bf616a>.7:
</span><span>            </span><span style=color:#bf616a>status</span><span> = "</span><span style=color:#a3be8c>failure</span><span>"
</span><span>            </span><span style=color:#bf616a>metrics</span><span> = {"</span><span style=color:#a3be8c>error_code</span><span>": random.randint(100, 500), "</span><span style=color:#a3be8c>success</span><span>": False}
</span><span>        </span><span style=color:#b48ead>else</span><span style=color:#96b5b4>:
</span><span>            </span><span style=color:#bf616a>status</span><span> = "</span><span style=color:#a3be8c>completed</span><span>" if i < len(steps) </span><span style=color:#bf616a>-</span><span> 1 or success else "</span><span style=color:#a3be8c>failure</span><span>"
</span><span>            </span><span style=color:#bf616a>metrics</span><span> = {"</span><span style=color:#a3be8c>success</span><span>": status == "</span><span style=color:#a3be8c>completed</span><span>"}
</span><span>        
</span><span>        </span><span style=color:#65737e># 创建事件数据
</span><span>        </span><span style=color:#bf616a>event</span><span> = {
</span><span>            "</span><span style=color:#a3be8c>anonymousId</span><span>": anonymous_id,
</span><span>            "</span><span style=color:#a3be8c>sessionId</span><span>": session_id,
</span><span>            "</span><span style=color:#a3be8c>step</span><span>": step,
</span><span>            "</span><span style=color:#a3be8c>status</span><span>": status,
</span><span>            "</span><span style=color:#a3be8c>timestamp</span><span>": event_time.isoformat(),
</span><span>            "</span><span style=color:#a3be8c>scriptVersion</span><span>": "</span><span style=color:#a3be8c>1.0.0</span><span>",
</span><span>            "</span><span style=color:#a3be8c>osName</span><span>": os_name,
</span><span>            "</span><span style=color:#a3be8c>osVersion</span><span>": os_version,
</span><span>            "</span><span style=color:#a3be8c>cpuArchitecture</span><span>": "</span><span style=color:#a3be8c>x64</span><span>",
</span><span>            "</span><span style=color:#a3be8c>memoryGB</span><span>": random.randint(8, 64),
</span><span>            "</span><span style=color:#a3be8c>metrics</span><span>": metrics
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#65737e># 发送事件
</span><span>        </span><span style=color:#bf616a>response</span><span> = requests.post(f"</span><span style=color:#a3be8c>{API_URL}/api/telemetry</span><span>", json=event)
</span><span>        </span><span style=color:#bf616a>print</span><span>(f"</span><span style=color:#a3be8c>Session {session_id}, Step {step}: {response.status_code}</span><span>")
</span></code></pre><h2 id=liu-xi-tong-gong-neng-zhan-shi>六、系统功能展示</h2><p>OpenHands Telemetry Dashboard提供多个关键功能，助力团队持续优化产品体验：<h3 id=6-1-zong-lan-zhi-biao>6.1 总览指标</h3><p>仪表板顶部显示四个核心KPI：<ul><li>总安装次数<li>成功安装数<li>安装成功率<li>平均安装时间</ul><p>这些指标提供了安装脚本效果的直观反馈，帮助团队快速评估整体表现。<h3 id=6-2-cao-zuo-xi-tong-fen-bu>6.2 操作系统分布</h3><p>通过环形饼图展示不同操作系统上的安装分布，帮助团队了解用户环境构成。<h3 id=6-3-an-zhuang-bu-zou-fen-xi>6.3 安装步骤分析</h3><p>堆叠柱状图清晰展示了每个安装步骤的成功/失败情况，帮助快速识别问题环节。图表按步骤分组，通过颜色区分不同状态，整合了百分比标签，数据直观易读。<h3 id=6-4-hui-hua-xiang-qing-yu-shi-jian-zhou>6.4 会话详情与时间轴</h3><p>系统最强大的功能之一是详细的会话分析：用户可选择特定会话，查看完整的安装时间轴和状态变化。时间轴使用颜色编码（绿色=成功，红色=失败，橙色=警告）直观展示安装流程，每个事件点显示步骤名称和状态。<h3 id=6-5-shu-ju-dao-chu-gong-neng>6.5 数据导出功能</h3><p>为方便进一步分析，系统支持将会话数据导出为CSV格式，便于在Excel等工具中深入研究。<h2 id=qi-chang-jian-wen-ti-yu-jie-jue-fang-an>七、常见问题与解决方案</h2><p>在构建过程中，我们遇到并解决了几个典型问题：<h3 id=7-1-dockerjing-xiang-la-qu-wen-ti>7.1 Docker镜像拉取问题</h3><p><strong>问题</strong>：在某些网络环境下，MongoDB镜像拉取失败，报错"unauthorized: incorrect username or password"。<p><strong>解决方案</strong>：<ol><li>手动登录Docker Hub: <code>docker login</code><li>如无账号，指定具体MongoDB版本: <code>mongo:6.0.5</code><li>清理Docker缓存: <code>docker system prune -a</code></ol><h3 id=7-2-apiyu-dashboardtong-xin-wen-ti>7.2 API与Dashboard通信问题</h3><p><strong>问题</strong>：Dashboard无法连接到API服务。<p><strong>解决方案</strong>：<ol><li>确保Docker网络配置正确<li>在Docker Compose中将API_URL设置为服务名称: <code>API_URL=http://api:9999</code><li>增加调试输出验证连接: <code>st.sidebar.text(f"API URL: {API_URL}")</code></ol><h3 id=7-3-shu-ju-geng-xin-yan-chi>7.3 数据更新延迟</h3><p><strong>问题</strong>：Streamlit缓存导致数据更新不及时。<p><strong>解决方案</strong>：<ol><li>添加强制刷新按钮: <code>st.cache_data.clear()</code><li>调整缓存TTL: <code>@st.cache_data(ttl=60)</code><li>使用实验性重新运行: <code>st.experimental_rerun()</code></ol><h2 id=ba-wei-lai-you-hua-fang-xiang>八、未来优化方向</h2><p>OpenHands Telemetry Dashboard仍有多个可优化方向：<h3 id=8-1-yi-chang-jian-ce-yu-gao-jing>8.1 异常检测与告警</h3><p>实现自动异常检测逻辑，当安装失败率突然上升时，自动告警通知开发团队。<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#b48ead>async def </span><span style=color:#8fa1b3>detect_failure_anomalies</span><span>():
</span><span>    </span><span style=color:#65737e>"""检测异常失败模式"""
</span><span>    </span><span style=color:#65737e># 获取最近24小时内数据
</span><span>    one_day_ago = datetime.</span><span style=color:#bf616a>utcnow</span><span>() - </span><span style=color:#bf616a>timedelta</span><span>(</span><span style=color:#bf616a>hours</span><span>=</span><span style=color:#d08770>24</span><span>)
</span><span>    
</span><span>    </span><span style=color:#65737e># 计算失败率
</span><span>    total_installs = </span><span style=color:#b48ead>await </span><span>telemetry_collection.</span><span style=color:#bf616a>count_documents</span><span>({
</span><span>        "</span><span style=color:#a3be8c>step</span><span>": "</span><span style=color:#a3be8c>install</span><span>",
</span><span>        "</span><span style=color:#a3be8c>timestamp</span><span>": {"</span><span style=color:#a3be8c>$gte</span><span>": one_day_ago}
</span><span>    })
</span><span>    
</span><span>    failed_installs = </span><span style=color:#b48ead>await </span><span>telemetry_collection.</span><span style=color:#bf616a>count_documents</span><span>({
</span><span>        "</span><span style=color:#a3be8c>step</span><span>": "</span><span style=color:#a3be8c>install</span><span>",
</span><span>        "</span><span style=color:#a3be8c>status</span><span>": "</span><span style=color:#a3be8c>failure</span><span>",
</span><span>        "</span><span style=color:#a3be8c>timestamp</span><span>": {"</span><span style=color:#a3be8c>$gte</span><span>": one_day_ago}
</span><span>    })
</span><span>    
</span><span>    failure_rate = failed_installs / total_installs </span><span style=color:#b48ead>if </span><span>total_installs > </span><span style=color:#d08770>0 </span><span style=color:#b48ead>else </span><span style=color:#d08770>0
</span><span>    
</span><span>    </span><span style=color:#65737e># 异常检测逻辑
</span><span>    </span><span style=color:#b48ead>if </span><span>failure_rate > </span><span style=color:#d08770>0.3 </span><span>and total_installs > </span><span style=color:#d08770>10</span><span>:
</span><span>        </span><span style=color:#65737e># 触发告警
</span><span>        </span><span style=color:#bf616a>send_alert</span><span>(</span><span style=color:#b48ead>f</span><span>"</span><span style=color:#a3be8c>安装失败率达到</span><span>{failure_rate*</span><span style=color:#d08770>100:.1f</span><span>}</span><span style=color:#a3be8c>%，请检查系统</span><span>")
</span></code></pre><h3 id=8-2-qu-shi-fen-xi>8.2 趋势分析</h3><p>添加基于时间的趋势分析，帮助团队理解不同版本之间的性能变化。<h3 id=8-3-yong-hu-ti-yan-ping-fen>8.3 用户体验评分</h3><p>集成用户反馈数据，创建综合用户体验评分，全面评估安装体验。<h3 id=8-4-aiyu-ce-fen-xi>8.4 AI预测分析</h3><p>引入机器学习模型，预测可能失败的安装，并提供预防性建议。<h2 id=jiu-zong-jie-yu-jing-yan-fen-xiang>九、总结与经验分享</h2><p>通过这个项目，我们成功构建了一个功能强大的遥测数据仪表板，为OpenHands Starter的持续优化提供了数据支持。这个系统具有几个关键优势：<ol><li><strong>技术栈合理</strong>：FastAPI与Streamlit的组合既高效又强大<li><strong>部署简单</strong>：Docker容器化使得部署过程一致且简单<li><strong>数据可视化直观</strong>：交互式图表使复杂数据易于理解<li><strong>扩展性强</strong>：模块化设计便于未来功能扩展</ol><p>从这个项目中，我们学到了几个关键经验：<ol><li><strong>前后端职责分离</strong>：FastAPI专注于数据处理，Streamlit专注于可视化<li><strong>数据建模的重要性</strong>：良好的数据模型设计是系统稳定性的基础<li><strong>容器化带来便利</strong>：Docker极大简化了多组件系统的部署和管理<li><strong>用户为中心的设计</strong>：从用户需求出发的设计才能创造真正有价值的工具</ol><p>通过这个仪表板，OpenHands团队能够持续监控安装过程，快速识别并解决问题，不断提升用户体验。<p><strong>源码地址</strong>：<a href=https://github.com/Polly2014/OpenHands-Starter-Dashboard>GitHub - OpenHands Telemetry Dashboard</a></div><div class=navigation></div></div><div id=giscus-container><h2>留言与讨论</h2><div class=giscus></div></div><script data-category="Blog Comments" async crossorigin data-category-id=DIC_kwDOL45duM4CnjlZ data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=pathname data-reactions-enabled=1 data-repo=Polly2014/polly2014.github.io data-repo-id=R_kgDOL45duA data-strict=0 data-theme=noborder_light src=https://giscus.app/client.js></script></div></div><script>document.addEventListener('DOMContentLoaded',function(){const c=document.querySelector('.menu-toggle');const d=document.querySelector('.sidebar');const e=document.querySelector('.overlay');function a(){d.classList.toggle('active');e.classList.toggle('active')}c.addEventListener('click',a);e.addEventListener('click',a);let f=0;let g=0;document.addEventListener('touchstart',h=>{f=h.changedTouches[0].screenX},false);document.addEventListener('touchend',h=>{g=h.changedTouches[0].screenX;b()},false);function b(){const h=g- f;if(h>50&&f<30){d.classList.add('active');e.classList.add('active')}else if(h<-50&&d.classList.contains('active')){d.classList.remove('active');e.classList.remove('active')}}})</script>