<!doctype html><html><head><title>Polly Blog - AI Assistant, Tutorials, and Insights</title><meta content="Explore Polly Blog for AI tutorials, insights, and updates on cutting-edge technology." name=description><meta content="Polly, Blog, AI Blog, AI Assistant, Tutorials, Technology Blog, Baoli Wang" name=keywords><meta content="width=device-width,initial-scale=1" name=viewport><meta content="text/html; charset=utf-8" http-equiv=content-type><link rel="shortcut icon" href=https://polly2014.github.io/images/polly.ico type=image/x-icon><link href=https://polly2014.github.io/images/polly.ico rel=icon type=image/x-icon><link href=https://polly2014.github.io/images/polly.ico rel=apple-touch-icon><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css rel=stylesheet><link href=https://polly2014.github.io/css/style_new.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-8JD13N7PHS" async></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-8JD13N7PHS')</script><body><div class=menu-toggle><img alt=Menu src=https://polly2014.github.io/images/polly.png></div><div class=overlay></div><div class="pure-g container"><div class="sidebar pure-u-1 pure-u-md-1-5"><div class=title><a class=pure-menu-heading href=https://polly2014.github.io> <img class="avatar pure-img-responsive" src=https://polly2014.github.io/images/polly.png> </a><div class=introduction><p>Polly's Blog</div><div class=nav><ul class=nav-links><li><a href=https://polly2014.github.io><i class="fas fa-home"></i>Home</a><li><a href=https://polly2014.github.io/archive><i class="fas fa-archive"></i>Archive</a><li><a href=https://polly2014.github.io/category><i class="fas fa-folder"></i>Category</a><li><a href=https://polly2014.github.io/blog><i class="fas fa-file-alt"></i>Posts</a><li><a href=https://polly2014.github.io/publication><i class="fas fa-file-pdf"></i>Research</a><li><a href=https://polly2014.github.io/changelog><i class="fas fa-history"></i>Change log</a><li><a href=https://polly2014.github.io/about><i class="fas fa-info-circle"></i>About Me</a></ul></div><div class=social><ul class=social-links><li><a href=mailto:26716201@qq.com><i class="fas fa-envelope"></i></a><li><a href=https://twitter.com/Polly__007><i class="fab fa-twitter"></i></a><li><a href=https://www.linkedin.com/in/baoliwang><i class="fab fa-linkedin-in"></i></a><li><a href=https://github.com/Polly2014><i class="fab fa-github"></i></a></ul></div></div></div><div class="content pure-u-1 pure-u-md-4-5"><div class=blog-post><h1>Remarkable Day! 拥抱开源，从OpenHands第一个PR开始</h1><div class=content><h2 id=kai-yuan-zhi-lu-de-qi-dian>开源之旅的起点</h2><p>AI Coding的浪潮汹涌不止，OpenHands最是让我爱不释手，虽不及Copilot, Cursor知名，但技术含量感觉只高不低，给玩家了太多想象空间。OpenHands为AI应用构建提供了出色的框架，特别是在LLM调用和Agent开发上极为便捷。昨晚与一朋友Debug个问题到深夜，一筹莫展之际偶然发现了一个关于<code>max_output_tokens</code>参数的bug，借此良机完成了第一个PR。<h2 id=wen-ti-fa-xian-yu-fu-xian>问题发现与复现</h2><p>在尝试通过OpenHands调用<code>openrouter/anthropic/claude-3.7-sonnet</code>模型时，我发现当设置<code>max_output_tokens</code>参数且需要生成较长响应（>4096 tokens）时，系统会陷入死循环。通过日志分析，错误表现为<code>file_text error</code>，导致Agent无法正常完成响应生成。</p><img alt="Loop Stuck" src=Loop_Stuck.png style=width:30%><p>日志片段：<pre style=background:#2b303b;color:#c0c5ce><code><span>LLMSummarizingCondenserConfig(type='llm', llm_config=LLMConfig(model='openrouter/anthropic/claude-3.7-sonnet', 
</span><span>api_key='******', base_url='', api_version=None, ... max_output_tokens=8192, ... reasoning_effort='high', seed=None), 
</span><span>keep_first=4, max_size=80, max_event_length=10000)
</span></code></pre><p>问题链接: <a href=https://github.com/All-Hands-AI/OpenHands/issues/8413>GitHub - OpenHands Issue #8413</a><h2 id=ji-zhu-fen-xi-yu-jie-jue-fang-an>技术分析与解决方案</h2><p>深入源码后，定位到问题出在<code>llm.py</code>文件的第406-421行。OpenHands对<code>max_output_tokens</code>参数有特殊处理逻辑，但这个逻辑只考虑了官方API提供的<code>claude-3-7-sonnet</code>模型，而没有考虑OpenRouter提供的<code>claude-3.7-sonnet</code>模型（注意命名差异）。<p>问题代码段：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#b48ead>if </span><span>'</span><span style=color:#a3be8c>claude-3-7-sonnet</span><span>' in </span><span style=color:#bf616a>self</span><span>.config.model:
</span><span>    </span><span style=color:#bf616a>self</span><span>.config.max_output_tokens = </span><span style=color:#d08770>64000  </span><span style=color:#65737e># litellm set max to 128k, but that requires a header to be set
</span></code></pre><p>修复过程：<ol><li>分析了参数传递路径，确认问题在模型名称匹配逻辑<li>发现通过OpenRouter使用的模型命名与官方API不同（使用<code>.</code>而非<code>-</code>）<li>扩展了条件判断，同时处理两种命名格式<li>编写测试用例验证修复在不同提供商情况下都能正确工作</ol><p>PR中的修复代码：<pre class=language-python data-lang=python style=background:#2b303b;color:#c0c5ce><code class=language-python data-lang=python><span style=color:#b48ead>if </span><span style=color:#96b5b4>any</span><span>(
</span><span>    model in </span><span style=color:#bf616a>self</span><span>.config.model
</span><span>    </span><span style=color:#b48ead>for </span><span>model </span><span style=color:#b48ead>in </span><span>['</span><span style=color:#a3be8c>claude-3-7-sonnet</span><span>', '</span><span style=color:#a3be8c>claude-3.7-sonnet</span><span>']
</span><span>):
</span><span>    </span><span style=color:#bf616a>self</span><span>.config.max_output_tokens = </span><span style=color:#d08770>64000  </span><span style=color:#65737e># litellm set max to 128k, but that requires a header to be set
</span></code></pre><p>PR链接: <a href=https://github.com/All-Hands-AI/OpenHands/pull/8415>GitHub - OpenHands Pull Request #8415</a><h2 id=jie-yu>结语</h2><p>看到PR被Approved, Merged还是让人难掩兴奋的哈哈，尤其OpenHands社区响应迅速，并提供了有建设性的反馈，无怪乎OpenHands能更新迭代如此迅速。也特别欣赏项目维护者对代码质量的高要求和对细节的关注 - 即使是看似简单的一行修改，也经过了严格的审查流程（顺便学习了下Lint代码语法检测的使用哈哈）。<p>Remarkable Day, Help Yourself is Help Others, 未来可期！</div><div class=navigation></div></div><div id=giscus-container><h2>留言与讨论</h2><div class=giscus></div></div><script data-category="Blog Comments" async crossorigin data-category-id=DIC_kwDOL45duM4CnjlZ data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=pathname data-reactions-enabled=1 data-repo=Polly2014/polly2014.github.io data-repo-id=R_kgDOL45duA data-strict=0 data-theme=noborder_light src=https://giscus.app/client.js></script></div></div><script>document.addEventListener('DOMContentLoaded',function(){const c=document.querySelector('.menu-toggle');const d=document.querySelector('.sidebar');const e=document.querySelector('.overlay');function a(){d.classList.toggle('active');e.classList.toggle('active')}c.addEventListener('click',a);e.addEventListener('click',a);let f=0;let g=0;document.addEventListener('touchstart',h=>{f=h.changedTouches[0].screenX},false);document.addEventListener('touchend',h=>{g=h.changedTouches[0].screenX;b()},false);function b(){const h=g- f;if(h>50&&f<30){d.classList.add('active');e.classList.add('active')}else if(h<-50&&d.classList.contains('active')){d.classList.remove('active');e.classList.remove('active')}}})</script>