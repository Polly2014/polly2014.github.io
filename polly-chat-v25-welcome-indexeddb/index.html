<!doctype html><html><head><title>Polly Chat v2.5ï¼šä»æ¬¢è¿å±åˆ° IndexedDB</title><meta content="ä¸€å¤©ä¹‹å†…ç»™åšå®¢èŠå¤©ç³»ç»Ÿåšäº† 8 é¡¹å‡çº§â€”â€”æ¬¢è¿å± 5-chip å…¥å£ã€å°é¾™è™¾ 4 è½® prompt Code Reviewã€CSS max-height æ ¹å› ä¿®å¤ã€localStorage è¿ç§»åˆ° IndexedDBã€‚2 æ¬¡æäº¤ï¼Œ+468 è¡Œï¼Œè®°å½•è¿™åœºå¯†é›†çš„ä¸€äººå†²åˆºã€‚" name=description><meta content="Polly, Blog, AI Blog, AI Assistant, Tutorials, Technology Blog, Baoli Wang" name=keywords><meta content="width=device-width,initial-scale=1" name=viewport><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content=#333 name=theme-color><meta content=article property=og:type><meta content=https://polly.wang/polly-chat-v25-welcome-indexeddb/ property=og:url><meta content="Polly Chat v2.5ï¼šä»æ¬¢è¿å±åˆ° IndexedDB" property=og:title><meta content="ä¸€å¤©ä¹‹å†…ç»™åšå®¢èŠå¤©ç³»ç»Ÿåšäº† 8 é¡¹å‡çº§â€”â€”æ¬¢è¿å± 5-chip å…¥å£ã€å°é¾™è™¾ 4 è½® prompt Code Reviewã€CSS max-height æ ¹å› ä¿®å¤ã€localStorage è¿ç§»åˆ° IndexedDBã€‚2 æ¬¡æäº¤ï¼Œ+468 è¡Œï¼Œè®°å½•è¿™åœºå¯†é›†çš„ä¸€äººå†²åˆºã€‚" property=og:description><meta content=https://polly.wang/polly-chat-v25-welcome-indexeddb/cover.jpg property=og:image><meta content="Polly Blog" property=og:site_name><meta content=zh_CN property=og:locale><meta content=summary_large_image name=twitter:card><meta content=https://polly.wang/polly-chat-v25-welcome-indexeddb/ name=twitter:url><meta content="Polly Chat v2.5ï¼šä»æ¬¢è¿å±åˆ° IndexedDB" name=twitter:title><meta content="ä¸€å¤©ä¹‹å†…ç»™åšå®¢èŠå¤©ç³»ç»Ÿåšäº† 8 é¡¹å‡çº§â€”â€”æ¬¢è¿å± 5-chip å…¥å£ã€å°é¾™è™¾ 4 è½® prompt Code Reviewã€CSS max-height æ ¹å› ä¿®å¤ã€localStorage è¿ç§»åˆ° IndexedDBã€‚2 æ¬¡æäº¤ï¼Œ+468 è¡Œï¼Œè®°å½•è¿™åœºå¯†é›†çš„ä¸€äººå†²åˆºã€‚" name=twitter:description><meta content=https://polly.wang/polly-chat-v25-welcome-indexeddb/cover.jpg name=twitter:image><meta content=2026-02-22T00:00:00 property=article:published_time><meta content=Polly property=article:author><meta content="Polly Chat" property=article:tag><meta content=IndexedDB property=article:tag><meta content=CSS property=article:tag><meta content=å‰ç«¯å¼€å‘ property=article:tag><meta content=å°é¾™è™¾ property=article:tag><meta content="Digital Polly" property=article:tag><meta content="prompt engineering" property=article:tag><link rel="shortcut icon" href=https://polly.wang/images/polly.ico type=image/x-icon><link href=https://polly.wang/images/polly.ico rel=icon type=image/x-icon><link href=https://polly.wang/images/polly.ico rel=apple-touch-icon><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css rel=stylesheet><link href=https://polly.wang/css/style_new.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-8JD13N7PHS" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8JD13N7PHS';);</script><body><div class=menu-toggle><img alt=Menu src=https://polly.wang/images/polly.png></div><div class=overlay></div><div class="pure-g container"><div class="sidebar pure-u-1 pure-u-md-1-5"><div class=title><a class=pure-menu-heading href=https://polly.wang> <img class="avatar pure-img-responsive" src=https://polly.wang/images/polly.png> </a><div class=introduction><p>Polly's Blog</div><div class=nav><ul class=nav-links><li><a href=https://polly.wang><i class="fas fa-home"></i>Home</a><li><a href=https://polly.wang/archive><i class="fas fa-archive"></i>Archive</a><li><a href=https://polly.wang/category><i class="fas fa-folder"></i>Category</a><li><a href=https://polly.wang/blog><i class="fas fa-file-alt"></i>Posts</a><li><a href=https://polly.wang/cfp><i class="fas fa-calendar-alt"></i>CFP</a><li><a href=https://polly.wang/publication><i class="fas fa-file-pdf"></i>Research</a><li><a href=https://polly.wang/changelog><i class="fas fa-history"></i>Change log</a><li><a href=https://polly.wang/about><i class="fas fa-info-circle"></i>About Me</a></ul></div><div class=social><ul class=social-links><li><a href=mailto:26716201@qq.com><i class="fas fa-envelope"></i></a><li><a href=https://twitter.com/Polly__007><i class="fab fa-twitter"></i></a><li><a href=https://www.linkedin.com/in/baoliwang><i class="fab fa-linkedin-in"></i></a><li><a href=https://github.com/Polly2014><i class="fab fa-github"></i></a></ul></div></div></div><div class="content pure-u-1 pure-u-md-4-5"><div class=blog-post><h1>Polly Chat v2.5ï¼šä»æ¬¢è¿å±åˆ° IndexedDB</h1><div class=cover-image><img alt="Polly Chat v2.5ï¼šä»æ¬¢è¿å±åˆ° IndexedDB" loading=lazy src=cover.jpg></div><div class=content><p>å‘¨å…­ä¸‹åˆæ‰“å¼€ polly.wangï¼Œé¦–é¡µèŠå¤©åŒºå°±ä¸€ä¸ªå…‰ç§ƒç§ƒçš„è¾“å…¥æ¡†ï¼Œè¿å¥é—®å€™éƒ½æ²¡æœ‰ã€‚å¯¹é¢å¦‚æœæ˜¯ä¸ªæ–°è®¿å®¢ï¼Œå¤§æ¦‚ç‡ç›´æ¥åˆ’èµ°â€”â€”"è¿™å•¥ï¼Ÿä¸€ä¸ªç©ºç™½å¯¹è¯æ¡†ï¼Ÿ"<p>åˆ°æ™šä¸Š 11 ç‚¹ï¼ŒåŒæ ·çš„é¦–é¡µå·²ç»å˜æˆäº†è¿™æ ·ï¼šæ—¶æ®µé—®å€™è¯­ã€5 ä¸ªå¿«æ·å…¥å£ã€å›¾ç‰‡èƒ½è·¨åˆ·æ–°ä¿ç•™ã€ç§»åŠ¨ç«¯åº•éƒ¨å†ä¹Ÿæ²¡æœ‰é‚£å—å¥‡æ€ªçš„ç•™ç™½ã€‚<p>è¿™ç¯‡è®°å½•ä¸€å¤©ä¹‹å†…çš„ 8 é¡¹æ”¹åŠ¨ã€‚ä¸æ˜¯ä»€ä¹ˆå¤§å·¥ç¨‹ï¼Œä½†å¯†åº¦å¤Ÿé«˜ï¼Œè¿‡ç¨‹ä¹Ÿå¤Ÿæœ‰è¶£â€”â€”ç‰¹åˆ«æ˜¯å°é¾™è™¾åš Code Review çš„é‚£æ®µã€‚</p><span id=continue-reading></span><blockquote><p><strong>ç³»åˆ—å›é¡¾</strong>ï¼š<a href=/Polly-Chat-2.0>Polly Chat 2.0 é‡æ„</a> â†’ <a href=/polly-chat-vision-support>Vision å¤šæ¨¡æ€</a> â†’ <a href=/polly-chat-d1-persistence>D1 æŒä¹…åŒ– (å°é¾™è™¾ä¸»ç¬”)</a> â†’ <strong>æœ¬ç¯‡ v2.5</strong></blockquote><h2 id=ban-ben-xian>ç‰ˆæœ¬çº¿</h2><p>å…ˆæ”¾ä¸ªå…¨æ™¯å›¾ï¼Œæ–¹ä¾¿å®šä½ä»Šå¤©çš„æ”¹åŠ¨åœ¨æ•´æ¡çº¿ä¸Šçš„ä½ç½®ï¼š<table><thead><tr><th style=text-align:center>ç‰ˆæœ¬<th style=text-align:center>æ—¥æœŸ<th>æ ‡å¿—æ”¹åŠ¨<th>åšæ–‡<tbody><tr><td style=text-align:center>2.0<td style=text-align:center>2/13<td>å»åç«¯é‡æ„ï¼ŒSSE ç›´è¿ CopilotX<td><a href=/Polly-Chat-2.0>Polly Chat 2.0</a><tr><td style=text-align:center>2.1<td style=text-align:center>2/13<td>Vision å¤šæ¨¡æ€<td><a href=/polly-chat-vision-support>çœ‹å›¾è¯´è¯</a><tr><td style=text-align:center>2.2<td style=text-align:center>2/14<td>Cloudflare D1 äº‘ç«¯æŒä¹…åŒ–<td><a href=/polly-chat-d1-persistence>å°é¾™è™¾æƒ…äººèŠ‚å®å½•</a><tr><td style=text-align:center>2.3<td style=text-align:center>2/22<td>å¤šå›¾ç²˜è´´ + Blob URL å†…å­˜æ³„æ¼ä¿®å¤<td>â€”<tr><td style=text-align:center>2.4<td style=text-align:center>2/22<td>prompt v4 å¤§æ”¹ç‰ˆï¼ˆå°é¾™è™¾ 4 è½® Reviewï¼‰<td>â€”<tr><td style=text-align:center><strong>2.5</strong><td style=text-align:center><strong>2/22</strong><td><strong>æ¬¢è¿å± + IndexedDB + ç§»åŠ¨ç«¯ä¿®å¤</strong><td><strong>æœ¬ç¯‡</strong></table><p>v2.3 â†’ v2.5 çš„ä¸‰ä¸ªç‰ˆæœ¬å…¨æŒ¤åœ¨åŒä¸€å¤©ï¼Œä¸¤æ¬¡ commitï¼Œ<code>+468 è¡Œ / -111 è¡Œ</code>ï¼Œæ¶‰åŠ 8 ä¸ªæ–‡ä»¶ã€‚ä¸‹é¢æŒ‰æ”¹åŠ¨ç±»å‹é€ä¸ªèŠã€‚<hr><h2 id=yi-huan-ying-ping-5-ge-chip-3-chong-lei-xing>ä¸€ã€æ¬¢è¿å±ï¼š5 ä¸ª Chipï¼Œ3 ç§ç±»å‹</h2><p>å…‰ç§ƒç§ƒçš„è¾“å…¥æ¡†æœ€å¤§çš„é—®é¢˜ä¸æ˜¯ä¸‘ï¼Œæ˜¯<strong>æ²¡ç»™ç”¨æˆ·ä¸€ä¸ªå¼€å£çš„ç†ç”±</strong>ã€‚<p>è§£å†³æ–¹æ¡ˆï¼šåœ¨è¾“å…¥æ¡†ä¸Šæ–¹åŠ ä¸€ä¸ªæ¬¢è¿å±å¹•ï¼ˆwelcome screenï¼‰ï¼ŒåŒ…å«é—®å€™è¯­å’Œ 5 ä¸ªå¿«æ·å…¥å£ï¼ˆchipsï¼‰ã€‚å½“ç”¨æˆ·ç‚¹å‡»ä»»æ„ä¸€ä¸ª chip æˆ–ç›´æ¥æ‰“å­—å‘æ¶ˆæ¯åï¼Œæ¬¢è¿å±è‡ªåŠ¨æ¶ˆå¤±ï¼ŒèŠå¤©ç•Œé¢å±•å¼€ã€‚<h3 id=mo-ban-ceng>æ¨¡æ¿å±‚</h3><pre class=language-html data-lang=html style=background:#2b303b;color:#c0c5ce><code class=language-html data-lang=html><span><</span><span style=color:#bf616a>div </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>welcome-screen</span><span>" </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>welcome-screen</span><span>">
</span><span>    <</span><span style=color:#bf616a>h2</span><span>>å’Œ Polly èŠèŠ&LT/</span><span style=color:#bf616a>h2</span><span>>
</span><span>    <</span><span style=color:#bf616a>p </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>welcome-subtitle</span><span>" </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>welcome-subtitle</span><span>">åšå®¢ä¸»äººçš„æ•°å­—åˆ†èº«ï¼Œéšæ—¶åœ¨çº¿ â˜•&LT/</span><span style=color:#bf616a>p</span><span>>
</span><span>    <</span><span style=color:#bf616a>div </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>welcome-chips</span><span>" </span><span style=color:#8fa1b3>id</span><span>="</span><span style=color:#a3be8c>welcome-chips</span><span>">
</span><span>        <</span><span style=color:#bf616a>button </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>chip</span><span>" </span><span style=color:#d08770>data-msg</span><span>="</span><span style=color:#a3be8c>ä½ æ˜¯è°ï¼Ÿ</span><span>">ğŸ‘‹ ä½ æ˜¯è°&LT/</span><span style=color:#bf616a>button</span><span>>
</span><span>        <</span><span style=color:#bf616a>button </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>chip</span><span>" </span><span style=color:#d08770>data-msg</span><span>="</span><span style=color:#a3be8c>æœ€è¿‘åœ¨å¿™ä»€ä¹ˆï¼Ÿ</span><span>">ğŸ”¥ æœ€è¿‘åœ¨å¿™ä»€ä¹ˆ&LT/</span><span style=color:#bf616a>button</span><span>>
</span><span>        <</span><span style=color:#bf616a>button </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>chip chip-image</span><span>" </span><span style=color:#d08770>data-action</span><span>="</span><span style=color:#a3be8c>upload-image</span><span>">ğŸ“· å‘å¼ å›¾è¯•è¯•&LT/</span><span style=color:#bf616a>button</span><span>>
</span><span>        <</span><span style=color:#bf616a>button </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>chip chip-dynamic</span><span>" </span><span style=color:#d08770>data-msg</span><span>="</span><span style=color:#a3be8c>èŠèŠ AI</span><span>">ğŸ”¬ èŠèŠ AI&LT/</span><span style=color:#bf616a>button</span><span>>
</span><span>        <</span><span style=color:#bf616a>button </span><span style=color:#d08770>class</span><span>="</span><span style=color:#a3be8c>chip</span><span>" </span><span style=color:#d08770>data-msg</span><span>="</span><span style=color:#a3be8c>æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿéšä¾¿èŠèŠ</span><span>">ğŸ’¬ éšä¾¿èŠèŠ&LT/</span><span style=color:#bf616a>button</span><span>>
</span><span>    &LT/</span><span style=color:#bf616a>div</span><span>>
</span><span>&LT/</span><span style=color:#bf616a>div</span><span>>
</span></code></pre><p>5 ä¸ª chip åˆ†ä¸‰ç§ç±»å‹ï¼š<table><thead><tr><th>ç±»å‹<th>ç¤ºä¾‹<th>è¡Œä¸º<tbody><tr><td><strong>é™æ€</strong><td>ğŸ‘‹ ä½ æ˜¯è° / ğŸ”¥ æœ€è¿‘åœ¨å¿™ä»€ä¹ˆ / ğŸ’¬ éšä¾¿èŠèŠ<td>ç‚¹å‡»ç›´æ¥å‘é€ <code>data-msg</code><tr><td><strong>åŠŸèƒ½å‹</strong><td>ğŸ“· å‘å¼ å›¾è¯•è¯•<td>å¼¹å‡ºæ–‡ä»¶é€‰æ‹©å™¨ï¼ˆ<code>data-action="upload-image"</code>ï¼‰<tr><td><strong>åŠ¨æ€</strong><td>ğŸ”¬ èŠèŠ AI<td>åˆå§‹æ–‡æ¡ˆï¼Œè¿è¡Œæ—¶ä» prompt æå– <code>ğŸŸ¢</code> é¡¹ç›®åæ›¿æ¢</table><h3 id=js-shi-jian-bang-ding>JS äº‹ä»¶ç»‘å®š</h3><p>ä¸‰ç§ç±»å‹ç»Ÿä¸€ç»‘å®šï¼Œç”¨ <code>data-action</code> å’Œ <code>data-msg</code> åŒºåˆ†è¡Œä¸ºï¼š<pre class=language-javascript data-lang=javascript style=background:#2b303b;color:#c0c5ce><code class=language-javascript data-lang=javascript><span>document.</span><span style=color:#96b5b4>querySelectorAll</span><span>('</span><span style=color:#a3be8c>.welcome-chips .chip</span><span>').</span><span style=color:#96b5b4>forEach</span><span>(</span><span style=color:#bf616a>chip </span><span style=color:#b48ead>=> </span><span>{
</span><span>    </span><span style=color:#bf616a>chip</span><span>.</span><span style=color:#96b5b4>addEventListener</span><span>('</span><span style=color:#a3be8c>click</span><span>', () </span><span style=color:#b48ead>=> </span><span>{
</span><span>        </span><span style=color:#65737e>// åŠŸèƒ½å‹ï¼šå¼¹æ–‡ä»¶é€‰æ‹©å™¨
</span><span>        </span><span style=color:#b48ead>if </span><span>(</span><span style=color:#bf616a>chip</span><span>.</span><span style=color:#bf616a>dataset</span><span>.action === '</span><span style=color:#a3be8c>upload-image</span><span>') {
</span><span>            </span><span style=color:#b48ead>const </span><span style=color:#bf616a>fileInput </span><span>= document.</span><span style=color:#96b5b4>createElement</span><span>('</span><span style=color:#a3be8c>input</span><span>');
</span><span>            </span><span style=color:#bf616a>fileInput</span><span>.type = '</span><span style=color:#a3be8c>file</span><span>';
</span><span>            </span><span style=color:#bf616a>fileInput</span><span>.accept = '</span><span style=color:#a3be8c>image/*</span><span>';
</span><span>            </span><span style=color:#bf616a>fileInput</span><span>.</span><span style=color:#8fa1b3>onchange </span><span>= (</span><span style=color:#bf616a>e</span><span>) </span><span style=color:#b48ead>=> </span><span>{
</span><span>                </span><span style=color:#b48ead>const </span><span style=color:#bf616a>file </span><span>= </span><span style=color:#bf616a>e</span><span>.target.</span><span style=color:#bf616a>files</span><span>[</span><span style=color:#d08770>0</span><span>];
</span><span>                </span><span style=color:#b48ead>if </span><span>(</span><span style=color:#bf616a>file</span><span>) { </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#8fa1b3>processImage</span><span>(</span><span style=color:#bf616a>file</span><span>); </span><span style=color:#bf616a>this</span><span>.input.</span><span style=color:#96b5b4>focus</span><span>(); }
</span><span>            };
</span><span>            </span><span style=color:#bf616a>fileInput</span><span>.</span><span style=color:#96b5b4>click</span><span>();
</span><span>            </span><span style=color:#b48ead>return</span><span>;
</span><span>        }
</span><span>        </span><span style=color:#65737e>// é™æ€/åŠ¨æ€å‹ï¼šå‘é€æ¶ˆæ¯
</span><span>        </span><span style=color:#b48ead>const </span><span style=color:#bf616a>msg </span><span>= </span><span style=color:#bf616a>chip</span><span>.</span><span style=color:#bf616a>dataset</span><span>.</span><span style=color:#bf616a>msg</span><span>;
</span><span>        </span><span style=color:#b48ead>if </span><span>(</span><span style=color:#bf616a>msg</span><span>) { </span><span style=color:#bf616a>this</span><span>.input.value = </span><span style=color:#bf616a>msg</span><span>; </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#96b5b4>send</span><span>(); }
</span><span>    });
</span><span>});
</span></code></pre><h3 id=dong-tai-chip-cong-prompt-li-wa-xiang-mu-ming>åŠ¨æ€ Chipï¼šä» prompt é‡ŒæŒ–é¡¹ç›®å</h3><p><code>setupWelcome()</code> åœ¨åˆå§‹åŒ–æ—¶æ ¹æ®å½“å‰å°æ—¶æ•°è®¾ç½®å‰¯æ ‡é¢˜ï¼ˆ"æ—©èµ·çš„ç¨‹åºå‘˜ï¼Œéš¾å¾— â˜€ï¸" / "å¤œçŒ«å­æ¨¡å¼ï¼Œæ­£åœ¨çº¿ ğŸŒ™"ï¼‰ï¼Œç„¶åè°ƒç”¨ <code>updateDynamicChips()</code> ä» system prompt ä¸­æ­£åˆ™åŒ¹é…ç¬¬ä¸€ä¸ª <code>ğŸŸ¢</code> åœ¨ç ”é¡¹ç›®åç§°ï¼š<pre class=language-javascript data-lang=javascript style=background:#2b303b;color:#c0c5ce><code class=language-javascript data-lang=javascript><span style=color:#8fa1b3>updateDynamicChips</span><span>() {
</span><span>    </span><span style=color:#b48ead>if </span><span>(!</span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>systemPrompt</span><span>) </span><span style=color:#b48ead>return</span><span>;
</span><span>    </span><span style=color:#b48ead>const </span><span style=color:#bf616a>dynamicChip </span><span>= document.</span><span style=color:#96b5b4>querySelector</span><span>('</span><span style=color:#a3be8c>.chip-dynamic</span><span>');
</span><span>    </span><span style=color:#b48ead>if </span><span>(!</span><span style=color:#bf616a>dynamicChip</span><span>) </span><span style=color:#b48ead>return</span><span>;
</span><span>    </span><span style=color:#b48ead>const </span><span style=color:#bf616a>projectMatch </span><span>= </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>systemPrompt</span><span>.</span><span style=color:#96b5b4>match</span><span>(/</span><span style=color:#96b5b4>\*\*(</span><span style=color:#d08770>.</span><span>+?</span><span style=color:#96b5b4>)\*\*</span><span style=color:#d08770>\s</span><span>*</span><span style=color:#96b5b4>\(ğŸŸ¢\)</span><span>/);
</span><span>    </span><span style=color:#b48ead>if </span><span>(</span><span style=color:#bf616a>projectMatch</span><span>) {
</span><span>        </span><span style=color:#b48ead>const </span><span style=color:#bf616a>name </span><span>= </span><span style=color:#bf616a>projectMatch</span><span>[</span><span style=color:#d08770>1</span><span>];
</span><span>        </span><span style=color:#bf616a>dynamicChip</span><span>.</span><span style=color:#bf616a>textContent </span><span>= `</span><span style=color:#a3be8c>ğŸ”¬ ${</span><span style=color:#bf616a>name</span><span style=color:#a3be8c>.</span><span style=color:#96b5b4>slice</span><span style=color:#a3be8c>(</span><span style=color:#d08770>0</span><span style=color:#a3be8c>, </span><span style=color:#d08770>10</span><span style=color:#a3be8c>)}</span><span>`;
</span><span>        </span><span style=color:#bf616a>dynamicChip</span><span>.</span><span style=color:#bf616a>dataset</span><span>.</span><span style=color:#bf616a>msg </span><span>= `</span><span style=color:#a3be8c>${</span><span style=color:#bf616a>name</span><span style=color:#a3be8c>} æ˜¯ä»€ä¹ˆï¼Ÿè·Ÿæˆ‘è®²è®²</span><span>`;
</span><span>    }
</span><span>}
</span></code></pre><p>è¿™è®© chip å†…å®¹éš prompt è‡ªåŠ¨æ›´æ–°â€”â€”æ¯æ¬¡ <code>build_prompt.py</code> é‡æ–°ç”Ÿæˆ prompt åï¼Œé¦–é¡µçš„ chip ä¹Ÿä¼šè·Ÿç€å˜ã€‚<h3 id=xian-yin-luo-ji>æ˜¾éšé€»è¾‘</h3><p>çº¯ CSS æ§åˆ¶ï¼Œé›¶ JSï¼š<pre class=language-css data-lang=css style=background:#2b303b;color:#c0c5ce><code class=language-css data-lang=css><span style=color:#8fa1b3>.</span><span style=color:#d08770>polly-chat</span><span style=color:#8fa1b3>.</span><span style=color:#d08770>expanded </span><span style=color:#8fa1b3>.</span><span style=color:#d08770>welcome-screen </span><span>{ display: none; }
</span></code></pre><p><code>.expanded</code> ç”± JS åœ¨å‘é€æ¶ˆæ¯æ—¶æ·»åŠ åˆ° <code>.polly-chat</code> å®¹å™¨ä¸Šï¼Œæ¬¢è¿å±å°±è‡ªåŠ¨æ¶ˆå¤±äº†ã€‚ç‚¹ New Chat æ—¶ç§»é™¤ <code>.expanded</code>ï¼Œæ¬¢è¿å±åˆå›æ¥ã€‚<hr><h2 id=er-xiao-long-xia-prompt-code-review-4-lun-die-dai>äºŒã€å°é¾™è™¾ Prompt Code Reviewï¼š4 è½®è¿­ä»£</h2><p>è¿™æ˜¯ä»Šå¤©æœ€æœ‰è¶£çš„éƒ¨åˆ†ã€‚<p>prompt v3 æ˜¯æˆ‘è‡ªå·±å†™çš„ï¼Œåƒä¸€ä»½äº§å“è¯´æ˜ä¹¦ï¼šè§„åˆ™ 1ã€è§„åˆ™ 2ã€è§„åˆ™ 3â€¦â€¦åå‡ æ¡ç¡¬æ€§çº¦æŸã€‚èƒ½ç”¨ï¼Œä½†æ€»è§‰å¾—å¯¹è¯å"å®¢æœå‘³"ã€‚<p>äºæ˜¯æŠŠ prompt ä¸¢ç»™å°é¾™è™¾åš Code Reviewã€‚4 è½®è¿­ä»£ä¸‹æ¥ï¼Œæ ¸å¿ƒæ”¹åŠ¨ï¼š<h3 id=gui-ze-yue-shu-ren-ge-shi-fan>è§„åˆ™çº¦æŸ â†’ äººæ ¼ç¤ºèŒƒ</h3><p><strong>Beforeï¼ˆv3ï¼‰</strong>ï¼š<blockquote><p>"å›å¤æ—¶å…ˆå…±æƒ…ï¼Œå†å›ç­”é—®é¢˜ï¼Œæœ€åç”¨åé—®å¥ç»“å°¾ã€‚"</blockquote><p><strong>Afterï¼ˆv4ï¼‰</strong>ï¼š<blockquote><p>"æˆ‘è¯´è¯çš„æ–¹å¼ï¼šç›´æ¥ä½†ä¸ç”Ÿç¡¬ï¼Œå¶å°”å¸¦ç‚¹ä¿çš®ï¼ŒæŠ€æœ¯èŠæ·±äº†ä¼šå…´å¥‹åœ°è¶Šè¯´è¶Šå¿«ã€‚"</blockquote><p>ä»"ä½ åº”è¯¥æ€ä¹ˆåš"å˜æˆ"æˆ‘æ˜¯ä»€ä¹ˆæ ·çš„äºº"ã€‚LLM æ¨¡ä»¿äººæ ¼æè¿°æ¯”éµå®ˆè§„åˆ™åˆ—è¡¨è‡ªç„¶å¾—å¤šã€‚<h3 id=fan-mian-shi-fan-anti-patterns>åé¢ç¤ºèŒƒï¼ˆAnti-patternsï¼‰</h3><p>å°é¾™è™¾åŠ äº† 4 æ¡æ˜ç¡®çš„"ä¸è¦è¿™æ ·è¯´"ï¼š<ol><li>âŒ <strong>å®¢æœè…”</strong>ï¼š"éå¸¸æ„Ÿè°¢æ‚¨çš„æé—®ï¼è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ã€‚"<li>âŒ <strong>é¢è¯•è…”</strong>ï¼š"æˆ‘åœ¨è¿™ä¸ªé¢†åŸŸæœ‰ä¸°å¯Œçš„ç»éªŒ..."<li>âŒ <strong>å…±æƒ…æ¨¡æ¿</strong>ï¼š"æˆ‘å®Œå…¨ç†è§£ä½ çš„æ„Ÿå—ã€‚"<li>âŒ <strong>æŠ¥èœå</strong>ï¼š"æˆ‘ç›®å‰æ­£åœ¨åš Aã€Bã€Cã€Dã€E äº”ä¸ªé¡¹ç›®ã€‚"</ol><p>è¿™ç»„åé¢ç¤ºèŒƒæ•ˆæœæå¥½ã€‚ä¹‹å‰æ•°å­— Polly æœ€çˆ±è¯´"è¿™æ˜¯ä¸ªå¾ˆå¥½çš„é—®é¢˜"ï¼ŒåŠ äº† anti-pattern ä¹‹åå†ä¹Ÿæ²¡å‡ºç°è¿‡ã€‚<h3 id=qi-ta-gai-dong>å…¶ä»–æ”¹åŠ¨</h3><ul><li><strong>è¯­è¨€é•œåƒ</strong>ï¼šä»"å»ºè®®"å‡çº§ä¸º"é“å¾‹"â€”â€”ç”¨æˆ·è¯´ä¸­æ–‡å°±å›ä¸­æ–‡ï¼Œè¯´è‹±æ–‡å°±å›è‹±æ–‡ï¼Œç»ä¸åˆ‡æ¢<li><strong>æ—¶é—´æ„ŸçŸ¥</strong>ï¼šJS ç«¯ <code>getTimeContext()</code> æ³¨å…¥æ—¶æ®µï¼ˆå‡Œæ™¨/æ—©æ™¨/ä¸Šåˆ/ä¸‹åˆ/æ™šä¸Šï¼‰ï¼Œprompt é‡Œç”¨æ—¶æ®µåšåœºæ™¯åŒ–å›åº”<li><strong>ç¡¬æ€§è§„åˆ™ç²¾ç®€</strong>ï¼š7 â†’ 6 æ¡ï¼Œå»æ‰"æ¯ 3 å¥è‡³å°‘ä¸€ä¸ªåé—®"è¿™ç§æ— æ³•ç¨³å®šæ‰§è¡Œçš„çº¦æŸ<li><strong>milestone å»é‡</strong>ï¼š<code>build_prompt.py</code> åš year-prefix åŒ¹é…ï¼Œé¿å…é‡Œç¨‹ç¢‘å’Œè¿‘æœŸåŠ¨æ€é‡å¤</ul><h3 id=xiao-guo-ce-shi>æ•ˆæœæµ‹è¯•</h3><p>ç”¨ <code>test_prompt.py</code> CLI å·¥å…·è·‘äº† 4 ä¸ª chip çš„ presetï¼š<table><thead><tr><th>Chip<th>è¯„åˆ†<th>äº®ç‚¹<tbody><tr><td>ğŸ‘‹ ä½ æ˜¯è°<td>A<td>ç®€æ´è‡ªç„¶ï¼Œå¸¦åé—®<tr><td>ğŸ”¥ æœ€è¿‘åœ¨å¿™ä»€ä¹ˆ<td>A<td>åˆ—äº† 3 ä¸ªé¡¹ç›® + åé—®<tr><td>ğŸ”¬ èŠèŠ AI<td>A<td>ä»ä¸ªäººç»å†åˆ‡å…¥è€Œéæ³›æ³›è€Œè°ˆ<tr><td>ğŸ’¬ éšä¾¿èŠèŠ<td>A<td>æ—¥å¸¸è¯­æ°”ï¼Œè¿˜æåˆ°äº†å°å®ï¼ˆæˆ‘å®¶çŒ«ï¼‰</table><p>4 è½® Review åçš„ prompt v4ï¼Œæ¯ä¸ª chip éƒ½èƒ½äº§ç”Ÿè‡ªç„¶ã€æœ‰ä¸ªæ€§çš„å›å¤ï¼Œæ²¡æœ‰å®¢æœè…”ã€‚å°é¾™è™¾çš„ Code Review ä»·å€¼è¶…å‡ºé¢„æœŸã€‚<hr><h2 id=san-css-gen-yin-fen-xi-yi-dong-duan-di-bu-de-shen-mi-liu-bai>ä¸‰ã€CSS æ ¹å› åˆ†æï¼šç§»åŠ¨ç«¯åº•éƒ¨çš„ç¥ç§˜ç•™ç™½</h2><p>è¿™ä¸ª bug è¡¨ç°å¾ˆç®€å•ï¼šç§»åŠ¨ç«¯å±•å¼€èŠå¤©åï¼Œåº•éƒ¨æœ‰ä¸€å¤§å—ç©ºç™½ï¼Œè¾“å…¥æ¡†æ‚¬åœ¨åŠç©ºä¸­ã€‚<h3 id=pai-cha-guo-cheng>æ’æŸ¥è¿‡ç¨‹</h3><p>ç¬¬ä¸€ååº”æ˜¯ <code>margin</code> æˆ– <code>padding</code> å¤šäº†ï¼Œæ”¹äº†å‡ è½®æ•°å€¼éƒ½ä¸å¯¹ã€‚ç›´åˆ°æŸ¥çœ‹ <code>#chat-box</code> çš„ computed stylesï¼Œå‘ç°äº†çœŸå‡¶ï¼š<pre class=language-css data-lang=css style=background:#2b303b;color:#c0c5ce><code class=language-css data-lang=css><span style=color:#65737e>/* ç§»åŠ¨ç«¯åª’ä½“æŸ¥è¯¢é‡Œçš„æ—§ä»£ç  */
</span><span style=color:#8fa1b3>#chat-box </span><span>{
</span><span>    max-height: </span><span style=color:#96b5b4>calc</span><span>(</span><span style=color:#d08770>100vh </span><span>- </span><span style=color:#d08770>200px</span><span>);
</span><span>}
</span></code></pre><p><code>max-height</code> æŠŠèŠå¤©åŒºåŸŸç¡¬æ€§æˆªæ–­äº†ã€‚å³ä½¿ <code>flex: 1</code> æƒ³è®© <code>#chat-box</code> å¡«æ»¡å‰©ä½™ç©ºé—´ï¼Œ<code>max-height</code> çš„ä¼˜å…ˆçº§æ›´é«˜â€”â€”flex ç®—å‡ºæ¥çš„é«˜åº¦å¦‚æœè¶…è¿‡ <code>max-height</code>ï¼Œå°±ä¼šè¢«æˆªæ‰ï¼Œäºæ˜¯åº•éƒ¨å‡ºç°ç©ºç™½ã€‚<h3 id=xiu-fu>ä¿®å¤</h3><pre class=language-css data-lang=css style=background:#2b303b;color:#c0c5ce><code class=language-css data-lang=css><span style=color:#b48ead>@media </span><span>(max-width: </span><span style=color:#d08770>768px</span><span>) {
</span><span>    </span><span style=color:#8fa1b3>#chat-box </span><span>{
</span><span>        max-height: </span><span style=color:#96b5b4>calc</span><span>(</span><span style=color:#d08770>100vh </span><span>- </span><span style=color:#d08770>120px</span><span>); </span><span style=color:#65737e>/* é™ä½éå±•å¼€æ€é™åˆ¶ */
</span><span>    }
</span><span>    </span><span style=color:#8fa1b3>#chat-box.</span><span style=color:#d08770>expanded </span><span>{
</span><span>        max-height: none; </span><span style=color:#65737e>/* å±•å¼€åç”± flex:1 æ§åˆ¶ */
</span><span>    }
</span><span>    </span><span style=color:#8fa1b3>.</span><span style=color:#d08770>polly-chat</span><span style=color:#8fa1b3>.</span><span style=color:#d08770>expanded </span><span style=color:#8fa1b3>.</span><span style=color:#d08770>input-container </span><span>{
</span><span>        margin-bottom: </span><span style=color:#d08770>24px</span><span>; </span><span style=color:#65737e>/* ç»™åº•éƒ¨ä¸€ç‚¹å‘¼å¸ç©ºé—´ */
</span><span>    }
</span><span>}
</span></code></pre><p>å…³é”®ä¸€è¡Œï¼š<code>max-height: none</code>ã€‚å±•å¼€åå–æ¶ˆé«˜åº¦é™åˆ¶ï¼Œè®© flexbox è‡ªç”±å¸ƒå±€ã€‚éå±•å¼€æ€ä¿ç•™ <code>calc(100vh - 120px)</code> ä½œä¸ºå®‰å…¨ç½‘ï¼ˆä» 200px ç¼©å‡åˆ° 120pxï¼Œè¿›ä¸€æ­¥å‡å°‘ç©ºç™½ï¼‰ã€‚<h3 id=jiao-xun>æ•™è®­</h3><blockquote><p><strong><code>max-height</code> å’Œ <code>flex: 1</code> ä¸€èµ·ç”¨æ—¶è¦æåº¦å°å¿ƒã€‚</strong> flex è®¡ç®—çš„æ˜¯"ç†æƒ³é«˜åº¦"ï¼Œä½† <code>max-height</code> ä¼šå¼ºåˆ¶æˆªæ–­ã€‚ä¸¤è€…å†²çªæ—¶ï¼Œ<code>max-height</code> èµ¢ã€‚</blockquote><hr><h2 id=si-indexeddb-qian-yi-gao-bie-localstorage-de-5mb-tian-hua-ban>å››ã€IndexedDB è¿ç§»ï¼šå‘Šåˆ« localStorage çš„ 5MB å¤©èŠ±æ¿</h2><p>v2.1 åŠ äº† Vision åŠŸèƒ½åï¼Œç”¨æˆ·å¯ä»¥å‘å›¾ç‰‡èŠå¤©ã€‚å›¾ç‰‡ä»¥ base64 å­˜åœ¨ <code>messages</code> æ•°ç»„é‡Œï¼Œä¸€å¼ å›¾å°±å‡ ç™¾ KBã€‚<code>localStorage</code> æœ€å¤š 5MBï¼ˆè¿˜å¾—è·Ÿå…¶ä»–æ•°æ®å…±äº«ï¼‰ï¼Œå­˜å‡ å¼ å›¾å°±çˆ†äº†ã€‚<p>ä¹‹å‰çš„æƒå®œä¹‹è®¡æ˜¯å­˜ <code>localStorage</code> æ—¶å‰¥æ‰å›¾ç‰‡â€”â€”ä½†è¿™æ„å‘³ç€åˆ·æ–°é¡µé¢åå›¾ç‰‡æ¶ˆå¤±ã€‚<h3 id=fang-an-xuan-ze>æ–¹æ¡ˆé€‰æ‹©</h3><table><thead><tr><th>æ–¹æ¡ˆ<th>ä¼˜ç‚¹<th>ç¼ºç‚¹<tbody><tr><td>localStorage + å‹ç¼©<td>æ”¹åŠ¨å°<td>æ²»æ ‡ä¸æ²»æœ¬ï¼Œ5MB è¿˜æ˜¯ä¼šçˆ†<tr><td><strong>IndexedDB</strong><td><strong>å®¹é‡å‡ ä¹æ— é™ï¼ŒåŸç”Ÿå¼‚æ­¥</strong><td><strong>API æ¯” localStorage å¤æ‚</strong><tr><td>Cache API<td>é€‚åˆç¼“å­˜è¯·æ±‚<td>è¯­ä¹‰ä¸åŒ¹é…</table><p>å°é¾™è™¾çš„å»ºè®®æ˜¯æ–¹æ¡ˆ Bâ€”â€”IndexedDBã€‚è™½ç„¶ API å•°å—¦äº†ç‚¹ï¼Œä½†å°è£…ä¸€ä¸‹å°±å¥½ã€‚<h3 id=shi-xian>å®ç°</h3><p>4 ä¸ªåº•å±‚æ–¹æ³•ï¼Œæ€»å…± 30 è¡Œï¼š<pre class=language-javascript data-lang=javascript style=background:#2b303b;color:#c0c5ce><code class=language-javascript data-lang=javascript><span style=color:#65737e>// DB: polly_chat, Store: history
</span><span style=color:#8fa1b3>_openDB</span><span>() {
</span><span>    </span><span style=color:#b48ead>return </span><span>new Promise((</span><span style=color:#bf616a>resolve</span><span>, </span><span style=color:#bf616a>reject</span><span>) </span><span style=color:#b48ead>=> </span><span>{
</span><span>        </span><span style=color:#b48ead>const </span><span style=color:#bf616a>req </span><span>= </span><span style=color:#bf616a>indexedDB</span><span>.</span><span style=color:#96b5b4>open</span><span>(</span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>DB_NAME</span><span>, </span><span style=color:#d08770>1</span><span>);
</span><span>        </span><span style=color:#bf616a>req</span><span>.</span><span style=color:#8fa1b3>onupgradeneeded </span><span>= () </span><span style=color:#b48ead>=> </span><span style=color:#bf616a>req</span><span>.</span><span style=color:#bf616a>result</span><span>.</span><span style=color:#8fa1b3>createObjectStore</span><span>(</span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>STORE_NAME</span><span>);
</span><span>        </span><span style=color:#bf616a>req</span><span>.</span><span style=color:#8fa1b3>onsuccess </span><span>= () </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>resolve</span><span>(</span><span style=color:#bf616a>req</span><span>.</span><span style=color:#bf616a>result</span><span>);
</span><span>        </span><span style=color:#bf616a>req</span><span>.</span><span style=color:#8fa1b3>onerror </span><span>= () </span><span style=color:#b48ead>=> </span><span style=color:#8fa1b3>reject</span><span>(</span><span style=color:#bf616a>req</span><span>.</span><span style=color:#bf616a>error</span><span>);
</span><span>    });
</span><span>}
</span><span>
</span><span style=color:#bf616a>async </span><span style=color:#8fa1b3>_idbGet</span><span>(</span><span style=color:#bf616a>key</span><span>) { </span><span style=color:#65737e>/* readonly transaction â†’ get(key) */ </span><span>}
</span><span style=color:#bf616a>async </span><span style=color:#8fa1b3>_idbPut</span><span>(</span><span style=color:#bf616a>key</span><span>, </span><span style=color:#bf616a>value</span><span>) { </span><span style=color:#65737e>/* readwrite transaction â†’ put(value, key) */ </span><span>}
</span><span style=color:#bf616a>async </span><span style=color:#8fa1b3>_idbDelete</span><span>(</span><span style=color:#bf616a>key</span><span>) { </span><span style=color:#65737e>/* readwrite transaction â†’ delete(key) */ </span><span>}
</span></code></pre><p>ä¸Šå±‚ <code>saveHistory()</code> å’Œ <code>restoreHistory()</code> æ”¹æˆ <code>async</code>ï¼Œå†…éƒ¨æŠŠ <code>localStorage.setItem</code> / <code>getItem</code> æ›¿æ¢æˆ <code>_idbPut</code> / <code>_idbGet</code>ã€‚<h3 id=zi-dong-qian-yi>è‡ªåŠ¨è¿ç§»</h3><p>è€ƒè™‘åˆ°è€ç”¨æˆ·æµè§ˆå™¨é‡Œå¯èƒ½è¿˜å­˜ç€ localStorage æ•°æ®ï¼ŒåŠ äº†è¿ç§»é€»è¾‘ï¼š<pre class=language-javascript data-lang=javascript style=background:#2b303b;color:#c0c5ce><code class=language-javascript data-lang=javascript><span style=color:#bf616a>async </span><span style=color:#8fa1b3>restoreHistory</span><span>() {
</span><span>    </span><span style=color:#65737e>// æ£€æµ‹æ—§ localStorage æ•°æ®
</span><span>    </span><span style=color:#b48ead>const </span><span style=color:#bf616a>legacy </span><span>= </span><span style=color:#bf616a>localStorage</span><span>.</span><span style=color:#96b5b4>getItem</span><span>(</span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>STORAGE_KEY</span><span>);
</span><span>    </span><span style=color:#b48ead>if </span><span>(</span><span style=color:#bf616a>legacy</span><span>) {
</span><span>        </span><span style=color:#b48ead>const </span><span style=color:#bf616a>legacyData </span><span>= JSON.</span><span style=color:#96b5b4>parse</span><span>(</span><span style=color:#bf616a>legacy</span><span>);
</span><span>        </span><span style=color:#b48ead>if </span><span>(</span><span style=color:#bf616a>legacyData</span><span>.</span><span style=color:#bf616a>messages</span><span>?.length > </span><span style=color:#d08770>0</span><span>) {
</span><span>            </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#8fa1b3>_idbPut</span><span>('</span><span style=color:#a3be8c>current</span><span>', </span><span style=color:#bf616a>legacyData</span><span>);
</span><span>        }
</span><span>        </span><span style=color:#bf616a>localStorage</span><span>.</span><span style=color:#96b5b4>removeItem</span><span>(</span><span style=color:#bf616a>this</span><span>.</span><span style=color:#bf616a>STORAGE_KEY</span><span>); </span><span style=color:#65737e>// è¿ç§»åæ¸…é™¤
</span><span>        </span><span style=color:#ebcb8b>console</span><span>.</span><span style=color:#96b5b4>log</span><span>('</span><span style=color:#a3be8c>ğŸ“¦ Migrated localStorage â†’ IndexedDB</span><span>');
</span><span>    }
</span><span>    </span><span style=color:#65737e>// ä» IndexedDB è¯»å–
</span><span>    </span><span style=color:#b48ead>const </span><span style=color:#bf616a>data </span><span>= </span><span style=color:#b48ead>await </span><span style=color:#bf616a>this</span><span>.</span><span style=color:#8fa1b3>_idbGet</span><span>('</span><span style=color:#a3be8c>current</span><span>');
</span><span>    </span><span style=color:#65737e>// ...æ¢å¤æ¶ˆæ¯
</span><span>}
</span></code></pre><p>è¿ç§»æ˜¯ä¸€æ¬¡æ€§çš„ï¼šè¯» localStorage â†’ å†™ IndexedDB â†’ åˆ  localStorageã€‚ä¸‹æ¬¡åˆ·æ–°å°±ç›´æ¥èµ° IndexedDB äº†ã€‚<h3 id=xiao-guo>æ•ˆæœ</h3><ul><li>âœ… å›¾ç‰‡èŠå¤©è·¨åˆ·æ–°ä¸ä¸¢å¤±ï¼ˆä¹‹å‰ä¸¢ï¼‰<li>âœ… å­˜å‚¨å®¹é‡ä» 5MB â†’ å‡ ä¹æ— é™<li>âœ… è€ç”¨æˆ·æ— æ„Ÿè¿ç§»<li>âœ… <code>newChat()</code> åŒæ—¶æ¸…é™¤ IndexedDB å’Œ legacy localStorage</ul><hr><h2 id=wu-san-ge-xiao-xiu-fu>äº”ã€ä¸‰ä¸ªå°ä¿®å¤</h2><h3 id=1-thinking-fadeout-bing-xing-hua>1. thinking fadeOut å¹¶è¡ŒåŒ–</h3><p>æ—§é€»è¾‘ï¼šthinking åŠ¨ç”»æ’­å®Œ â†’ åˆ é™¤ DOM â†’ æ¸²æŸ“å›å¤æ–‡æœ¬ã€‚é—®é¢˜æ˜¯ fadeOut åŠ¨ç”»æœ‰ 300msï¼Œè¿™æ®µæ—¶é—´ç”¨æˆ·ç›¯ç€ç©ºç™½ç­‰ã€‚<p>æ–°é€»è¾‘ï¼šfadeOut å’Œæ–‡æœ¬æ¸²æŸ“<strong>å¹¶è¡Œ</strong>ã€‚æ¸²æŸ“ç¬¬ä¸€ä¸ª token çš„åŒæ—¶ thinking åœ¨ fadeï¼Œè§†è§‰ä¸Šæ— ç¼è¡”æ¥ã€‚<h3 id=2-dompurify-xss-fang-hu>2. DOMPurify XSS é˜²æŠ¤</h3><p>èŠå¤©å›å¤ç”¨ <code>marked.js</code> æ¸²æŸ“ Markdownï¼Œç†è®ºä¸Šæœ‰ XSS é£é™©ã€‚åŠ äº† DOMPurify v3 åšæ¶ˆæ¯’ï¼š<pre class=language-html data-lang=html style=background:#2b303b;color:#c0c5ce><code class=language-html data-lang=html><span><</span><span style=color:#bf616a>script </span><span style=color:#d08770>src</span><span>="</span><span style=color:#a3be8c>https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js</span><span>">&LT/</span><span style=color:#bf616a>script</span><span>>
</span></code></pre><p>æ¸²æŸ“é“¾å˜æˆï¼š<code>markdown â†’ marked.parse() â†’ DOMPurify.sanitize() â†’ innerHTML</code>ã€‚<h3 id=3-blob-url-nei-cun-xie-lou-xiu-fu>3. Blob URL å†…å­˜æ³„æ¼ä¿®å¤</h3><p>v2.3 æ”¯æŒå¤šå›¾ç²˜è´´åï¼Œæ¯æ¬¡ç²˜è´´ä¼š <code>URL.createObjectURL()</code> ç”Ÿæˆé¢„è§ˆ URLã€‚å¦‚æœç”¨æˆ·è¿ç»­ç²˜è´´å¤šæ¬¡ï¼Œæ—§çš„ Blob URL æ²¡æœ‰é‡Šæ”¾ã€‚ä¿®å¤ï¼šåœ¨åˆ›å»ºæ–° URL å‰ <code>revokeObjectURL()</code> æ—§çš„ã€‚<hr><h2 id=liu-test-prompt-py-zhong-duan-li-de-qa-huan-jing>å…­ã€test_prompt.pyï¼šç»ˆç«¯é‡Œçš„ QA ç¯å¢ƒ</h2><p>æ”¹å®Œ prompt ä¹‹åï¼Œä¹‹å‰çš„æµ‹è¯•æ–¹å¼æ˜¯ï¼šå¼€æµè§ˆå™¨ â†’ æ‰“å¼€ polly.wang â†’ æ‰‹åŠ¨è¾“å…¥ â†’ çœ‹å›å¤ã€‚æ¥å›åˆ‡æ¢å¾ˆä½æ•ˆã€‚<p>äºæ˜¯å†™äº†ä¸ª CLI æµ‹è¯•å·¥å…· <code>test_prompt.py</code>ï¼Œä¸æäº¤ï¼ˆgitignoreï¼‰ï¼Œçº¯æœ¬åœ°ä½¿ç”¨ï¼š<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#65737e># å•æ¡æµ‹è¯•
</span><span style=color:#bf616a>python</span><span> scripts/test_prompt.py "</span><span style=color:#a3be8c>ä½ æ˜¯è°</span><span>"
</span><span>
</span><span style=color:#65737e># äº¤äº’æ¨¡å¼
</span><span style=color:#bf616a>python</span><span> scripts/test_prompt.py
</span><span>> æœ€è¿‘åœ¨å¿™ä»€ä¹ˆ
</span><span>> /new              </span><span style=color:#65737e># é‡ç½®å¯¹è¯
</span><span>> /quit             </span><span style=color:#65737e># é€€å‡º
</span><span>
</span><span style=color:#65737e># 5 ä¸ª preset
</span><span style=color:#bf616a>python</span><span> scripts/test_prompt.py</span><span style=color:#bf616a> --preset</span><span> 1  </span><span style=color:#65737e># ä½ æ˜¯è°ï¼Ÿ
</span><span style=color:#bf616a>python</span><span> scripts/test_prompt.py</span><span style=color:#bf616a> --preset</span><span> 2  </span><span style=color:#65737e># æœ€è¿‘åœ¨å¿™ä»€ä¹ˆï¼Ÿ
</span><span style=color:#bf616a>python</span><span> scripts/test_prompt.py</span><span style=color:#bf616a> --preset</span><span> 3  </span><span style=color:#65737e># èŠèŠ AI
</span><span style=color:#bf616a>python</span><span> scripts/test_prompt.py</span><span style=color:#bf616a> --preset</span><span> 4  </span><span style=color:#65737e># éšä¾¿èŠèŠ
</span><span style=color:#bf616a>python</span><span> scripts/test_prompt.py</span><span style=color:#bf616a> --preset</span><span> 5  </span><span style=color:#65737e># English test
</span></code></pre><p>å·¥å…·ç›´æ¥è¯» <code>polly-prompt.json</code>ï¼Œå¤åˆ» <code>getTimeContext()</code> çš„æ—¶æ®µæ³¨å…¥é€»è¾‘ï¼Œè°ƒç”¨ <code>api.polly.wang/v1/messages</code>ï¼ˆå’Œçº¿ä¸Šå®Œå…¨ä¸€è‡´çš„ APIï¼‰ã€‚æ¯æ¬¡æ”¹å®Œ prompt åç»ˆç«¯é‡Œè·‘ä¸€è½® presetï¼Œ30 ç§’å°±èƒ½éªŒè¯æ•ˆæœã€‚<hr><h2 id=cheng-guo-hui-zong>æˆæœæ±‡æ€»</h2><h3 id=dai-ma-liang>ä»£ç é‡</h3><table><thead><tr><th>æ–‡ä»¶<th style=text-align:right>è¡Œæ•°<th>ä¸»è¦æ”¹åŠ¨<tbody><tr><td>polly-chat.js<td style=text-align:right>751<td>IndexedDB + æ¬¢è¿å± + chip äº‹ä»¶<tr><td>style_new.css<td style=text-align:right>1593<td>æ¬¢è¿å±æ ·å¼ + ç§»åŠ¨ç«¯ä¿®å¤<tr><td>build_prompt.py<td style=text-align:right>689<td>Layer 3 åšæ–‡åŠ¨æ€ + milestone å»é‡<tr><td>index.html<td style=text-align:right>54<td>æ¬¢è¿å± HTML + DOMPurify<tr><td>polly-prompt.json<td style=text-align:right>â€”<td>v2026.02.22<tr><td><strong>åˆè®¡</strong><td style=text-align:right><strong>3087</strong><td>â€”</table><h3 id=ti-jiao-ji-lu>æäº¤è®°å½•</h3><pre style=background:#2b303b;color:#c0c5ce><code><span>3b49044  feat(chat): å°é¾™è™¾ v4 prompt å¤§æ”¹ç‰ˆ + å¤šå›¾èŠå¤©æ”¯æŒ
</span><span>         3 files, +137 / -31
</span><span>
</span><span>3a74c17  feat(chat): æ¬¢è¿å± + IndexedDB æŒä¹…åŒ– + ç§»åŠ¨ç«¯ä¿®å¤ + prompt æ›´æ–°
</span><span>         5 files, +331 / -80
</span></code></pre><hr><h2 id=fan-si>åæ€</h2><p><strong>å°é¾™è™¾çš„ Code Review æ¯”æˆ‘é¢„æƒ³çš„æœ‰ç”¨å¾—å¤šã€‚</strong> æˆ‘è‡ªå·±å†™ prompt å®¹æ˜“é™·å…¥"è§„åˆ™æ€ç»´"â€”â€”è§‰å¾—åŠ ä¸€æ¡è§„åˆ™å°±èƒ½è§£å†³ä¸€ä¸ªé—®é¢˜ã€‚å°é¾™è™¾çš„æ–¹å¼å®Œå…¨ä¸åŒï¼šç»™äººæ ¼æè¿°ï¼Œç»™åé¢ç¤ºèŒƒï¼Œè®© LLM è‡ªå·±æ¨æ–­è¯¥æ€ä¹ˆè¯´ã€‚æ•ˆæœå¥½å¾ˆå¤šã€‚<p><strong>IndexedDB æ—©å°±è¯¥è¿ç§»äº†ã€‚</strong> ä» v2.1 åŠ  Vision çš„é‚£å¤©èµ·å°±çŸ¥é“ localStorage ä¸å¤Ÿç”¨ï¼Œä½†ä¸€ç›´ç”¨"å‰¥æ‰å›¾ç‰‡"çš„ workaround å‡‘åˆã€‚æ‹–äº† 9 å¤©æ‰åšæ­£ç¡®çš„äº‹ã€‚å¥½åœ¨è¿ç§»æœ¬èº«ä¸å¤æ‚ï¼Œ30 è¡Œå°è£… + è‡ªåŠ¨è¿ç§»é€»è¾‘å°±æå®šäº†ã€‚<p><strong>CSS çš„ <code>max-height</code> å‘å€¼å¾—è®°ä½ã€‚</strong> ä¸æ˜¯ç¬¬ä¸€æ¬¡åœ¨ flex å¸ƒå±€é‡Œè¢« <code>max-height</code> å‘äº†ã€‚å†™ä¸ªå¤‡å¿˜å½•è´´åœ¨æ˜¾ç¤ºå™¨ä¸Šï¼š<strong>flex + max-height = å°å¿ƒ</strong>ã€‚<p>ä¸‹ä¸€æ­¥å¤§æ¦‚æ˜¯ç»™æ¬¢è¿å±åŠ ä¸ªå¤´åƒï¼Œç„¶åæŠŠåŠ¨æ€ chip åšå¾—æ›´æ™ºèƒ½â€”â€”ä¸åªæ˜¯ä» prompt é‡Œæ­£åˆ™åŒ¹é…é¡¹ç›®åï¼Œè€Œæ˜¯æ ¹æ®æœ€è¿‘åšæ–‡ä¸»é¢˜åŠ¨æ€æ¨èè¯é¢˜ã€‚<hr><blockquote><p><strong>ç‰ˆæœ¬æ—¶é—´çº¿</strong><table><thead><tr><th style=text-align:center>ç‰ˆæœ¬<th style=text-align:center>æ—¥æœŸ<th>æ–‡ç« <tbody><tr><td style=text-align:center>2.0<td style=text-align:center>2/13<td><a href=/Polly-Chat-2.0>Polly Chat 2.0: From Clunky Backend to Zero-Backend</a><tr><td style=text-align:center>2.1<td style=text-align:center>2/13<td><a href=/polly-chat-vision-support>ç»™åšå®¢èŠå¤©åŠ ä¸Šã€Œçœ‹å›¾è¯´è¯ã€åŠŸèƒ½</a><tr><td style=text-align:center>2.2<td style=text-align:center>2/14<td><a href=/polly-chat-d1-persistence>ç»™ Polly è£…ä¸Šè®°å¿†ï¼šä¸€åªè™¾çš„æƒ…äººèŠ‚å¼€å‘å®å½•</a><tr><td style=text-align:center><strong>2.5</strong><td style=text-align:center><strong>2/22</strong><td><strong>æœ¬ç¯‡</strong></table></blockquote></div><div class=navigation></div></div><div id=giscus-container><h2>ç•™è¨€ä¸è®¨è®º</h2><div class=giscus></div></div><script data-category="Blog Comments" async crossorigin data-category-id=DIC_kwDOL45duM4CnjlZ data-emit-metadata=0 data-input-position=bottom data-lang=en data-mapping=pathname data-reactions-enabled=1 data-repo=Polly2014/polly2014.github.io data-repo-id=R_kgDOL45duA data-strict=0 data-theme=noborder_light src=https://giscus.app/client.js></script><script type=module>
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                // ç°ç™½é»‘è‰²è°ƒ + è“è‰²ç‚¹ç¼€
                primaryColor: '#e8e8e8',
                primaryTextColor: '#333',
                primaryBorderColor: '#999',
                lineColor: 'rgb(61, 146, 201)',
                secondaryColor: '#f5f5f5',
                tertiaryColor: '#fafafa',
                background: '#f2f2f2',
                mainBkg: '#f5f5f5',
                nodeBorder: '#999',
                clusterBkg: '#eee',
                clusterBorder: '#ccc',
                titleColor: '#333',
                edgeLabelBackground: '#f2f2f2',
                // æ–‡æœ¬é¢œè‰²
                textColor: '#333',
                nodeTextColor: '#333',
                // å…¶ä»–
                fontFamily: "'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace"
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        // æŸ¥æ‰¾æ‰€æœ‰ mermaid ä»£ç å—å¹¶æ¸²æŸ“
        document.querySelectorAll('pre code.language-mermaid').forEach((block, index) => {
            const container = document.createElement('div');
            container.className = 'mermaid';
            container.textContent = block.textContent;
            block.parentNode.replaceWith(container);
        });

        // æ¸²æŸ“æ‰€æœ‰ mermaid å›¾è¡¨
        await mermaid.run();
    </script><style>.cover-image{text-align:center;margin:1.5em 0 2em 0}.cover-image img{width:60%;height:auto;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)}.mermaid{background:#fafafa;border:1px solid #ddd;padding:20px;margin:20px 0;overflow-x:auto}.mermaid svg{max-width:100%;height:auto}@media (max-width:768px){.cover-image img{width:100%}}</style></div></div><script>document.addEventListener('DOMContentLoaded',function(){const c=document.querySelector('.menu-toggle');const d=document.querySelector('.sidebar');const e=document.querySelector('.overlay');function a(){d.classList.toggle('active');e.classList.toggle('active')}c.addEventListener('click',a);e.addEventListener('click',a);let f=0;let g=0;document.addEventListener('touchstart',h=>{f=h.changedTouches[0].screenX},false);document.addEventListener('touchend',h=>{g=h.changedTouches[0].screenX;b()},false);function b(){const h=g- f;if(h>50&&f<30){d.classList.add('active');e.classList.add('active')}else if(h<-50&&d.classList.contains('active')){d.classList.remove('active');e.classList.remove('active')}}})</script>