<!doctype html><html><head><title>Polly Blog - AI Assistant, Tutorials, and Insights</title><meta content="Explore Polly Blog for AI tutorials, insights, and updates on cutting-edge technology." name=description><meta content="Polly, Blog, AI Blog, AI Assistant, Tutorials, Technology Blog, Baoli Wang" name=keywords><meta content="width=device-width,initial-scale=1" name=viewport><meta content="text/html; charset=utf-8" http-equiv=content-type><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/grids-responsive-min.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css rel=stylesheet><link href=https://polly2014.github.io/css/style_new.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-8JD13N7PHS" async></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-8JD13N7PHS')</script><body><div class=menu-toggle><img alt=Menu src=https://polly2014.github.io/images/polly.png></div><div class=overlay></div><div class="pure-g container"><div class="sidebar pure-u-1 pure-u-md-1-5"><div class=title><a class=pure-menu-heading href=https://polly2014.github.io> <img class="avatar pure-img-responsive" src=https://polly2014.github.io/images/polly.png> </a><div class=introduction><p>Polly's Blog</div><div class=nav><ul class=nav-links><li><a href=https://polly2014.github.io><i class="fas fa-home"></i>Home</a><li><a href=https://polly2014.github.io/archive><i class="fas fa-archive"></i>Archive</a><li><a href=https://polly2014.github.io/category><i class="fas fa-folder"></i>Category</a><li><a href=https://polly2014.github.io/blog><i class="fas fa-file-alt"></i>Posts</a><li><a href=https://polly2014.github.io/publication><i class="fas fa-file-pdf"></i>Research</a><li><a href=https://polly2014.github.io/changelog><i class="fas fa-history"></i>Change log</a><li><a href=https://polly2014.github.io/about><i class="fas fa-info-circle"></i>About Me</a></ul></div><div class=social><ul class=social-links><li><a href=mailto:26716201@qq.com><i class="fas fa-envelope"></i></a><li><a href=https://twitter.com/Polly__007><i class="fab fa-twitter"></i></a><li><a href=https://www.linkedin.com/in/baoliwang><i class="fab fa-linkedin-in"></i></a><li><a href=https://github.com/Polly2014><i class="fab fa-github"></i></a></ul></div></div></div><div class="content pure-u-1 pure-u-md-4-5"><div class=polly-chat><h2>Welcome to talk with Polly</h2><div id=chat-box></div><div class=input-container><input placeholder="Type your message here..." id=user-input><button id=send-button><i class="fas fa-paper-plane"></i></button></div></div><script src=https://cdn.jsdelivr.net/npm/marked/marked.min.js></script><script>const CONFIG={API_KEY:'13b0343745850744bd1383e2050c0ae98129951e575cd7b5d1a2a11cd3f7846c',API_URL:['localhost','127.0.0.1'].includes(window.location.hostname)?'http://localhost:50206':'https://daitianjun.com:50206',WS_URL:['localhost','127.0.0.1'].includes(window.location.hostname)?'ws://localhost:50206':'ws://daitianjun.com:50206',HEADERS:{'Content-Type':'application/json','Accept':'application/json','X-API-Key':'13b0343745850744bd1383e2050c0ae98129951e575cd7b5d1a2a11cd3f7846c'}};let ws=null;let preferWebSocket=false;let wsConnected=false;let reconnectAttempts=0;const MAX_RECONNECT_ATTEMPTS=3;const chatBox=document.getElementById('chat-box');const userInput=document.getElementById('user-input');const sendButton=document.getElementById('send-button');function typeWriter(a,b,c=50){let d=0;a.textContent='';return new Promise(e=>{function f(){if(d<b.length){a.textContent+=b.charAt(d);d++;scrollToBottom();setTimeout(f,c)}else{e()}}f()})}function typeWriterHTML(a,b,c=50){return new Promise(d=>{const g=document.createElement('div');g.innerHTML=b;a.innerHTML='';const h=[];function e(m){if(m.nodeType===Node.TEXT_NODE&&m.textContent.trim()!==''){m._originalText=m.textContent;m._currentText='';m.nodeValue='';h.push(m)}else if(m.nodeType===Node.ELEMENT_NODE){for(let n=0;n<m.childNodes.length;n++){e(m.childNodes[n])}}}for(let m=0;m<g.childNodes.length;m++){const n=g.childNodes[m].cloneNode(true);e(n);a.appendChild(n)};let i=0;let j=0;let k=0;const l=10;function f(){if(i<h.length){const m=h[i];const n=m._originalText;if(j<n.length){m._currentText+=n[j];m.nodeValue=m._currentText;j++;k++;if(k>=l){const o=a.getBoundingClientRect();const p=chatBox.getBoundingClientRect();if(o.bottom>p.bottom){scrollToBottom()};k=0};setTimeout(f,c)}else{i++;j=0;scrollToBottom();setTimeout(f,c*2)}}else{scrollToBottom();d()}}setTimeout(f,c)})}function scrollToBottom(){chatBox.scrollTop=chatBox.scrollHeight}function checkConnection(){if(!ws||ws.readyState!==WebSocket.OPEN){console.log('检测到连接断开，尝试重连');handleReconnect();return false};return true}function initWebSocket(){if(!preferWebSocket){console.log('已切换到 HTTP 模式');userInput.disabled=false;return};const a=new URL(`${CONFIG.WS_URL}/ws/polly`);a.searchParams.append('api_key',CONFIG.API_KEY);ws=new WebSocket(a.toString());let b;ws.onopen=()=>{console.log('WebSocket 连接成功');wsConnected=true;userInput.disabled=false;reconnectAttempts=0;b=setInterval(()=>{if(ws.readyState===WebSocket.OPEN){ws.send(JSON.stringify({type:'ping'}))}},30000)};ws.onclose=c=>{console.log(`WebSocket 连接关闭: ${c.code} - ${c.reason}`);wsConnected=false;userInput.disabled=false;clearInterval(b);if(c.code===4003){console.log('API 密钥验证失败，切换到 HTTP 模式');preferWebSocket=false}else{handleReconnect()}};ws.onerror=c=>{console.error('WebSocket 错误:',c);wsConnected=false}}function handleReconnect(){if(!preferWebSocket)return;if(reconnectAttempts<MAX_RECONNECT_ATTEMPTS){reconnectAttempts++;const a=Math.min(1000*Math.pow(2,reconnectAttempts),30000);console.log(`尝试第 ${reconnectAttempts} 次重连，延迟 ${a}ms`);setTimeout(initWebSocket,a)}else{console.log('WebSocket 连接失败多次，切换到 HTTP 模式');preferWebSocket=false;userInput.disabled=false}}async function sendMessage(){const a=userInput.value;if(!a)return;userInput.disabled=true;sendButton.disabled=true;try{const b=document.querySelector('.polly-chat');if(!b.classList.contains('expanded')){b.classList.add('expanded');chatBox.classList.add('expanded');await new Promise(e=>setTimeout(e,300))};displayUserMessage(a);userInput.value='';const {pollyContainer:c,pollyBubble:d}=createPollyMessageContainer();if(preferWebSocket&&ws&&ws.readyState===WebSocket.OPEN){try{const e=await sendWebSocketMessage(a);await displayPollyResponse(d,e.reply)}catch(e){console.error('WebSocket 发送失败:',e);if(e.message.includes('连接断开')||e.message.includes('超时')){if(await attemptReconnection()){const g=await sendWebSocketMessage(a);await displayPollyResponse(d,g.reply);return}};console.log('降级到 HTTP 模式');preferWebSocket=false;const f=await sendHttpMessage(a);await displayPollyResponse(d,f.reply)}}else{const e=await sendHttpMessage(a);await displayPollyResponse(d,e.reply)}}catch(b){console.error('消息发送失败:',b);const c=document.querySelector('.chat-bubble.polly:last-child');await handleError(c,b)}finally{userInput.disabled=false;sendButton.disabled=false;userInput.focus();scrollToBottom()}}async function sendWebSocketMessage(a,b=10000){return new Promise((c,d)=>{const e=setTimeout(()=>{d(new Error('WebSocket 响应超时'))},b);const f=g=>{clearTimeout(e);try{const h=JSON.parse(g.data);if(h.error){d(new Error(h.error))}else{c(h)}}catch(h){d(new Error('无效的响应格式'))};ws.removeEventListener('message',f)};try{ws.addEventListener('message',f);ws.send(JSON.stringify({message:a}))}catch(g){clearTimeout(e);ws.removeEventListener('message',f);d(new Error('WebSocket 发送失败'))}})}async function sendHttpMessage(a){try{const b=await fetch(`${CONFIG.API_URL}/api/polly`,{method:'POST',headers:CONFIG.HEADERS,mode:'cors',credentials:'include',body:JSON.stringify({message:a})});if(!b.ok){const c=await b.json().catch(()=>({}));if(b.status===403){throw new Error('API Key 验证失败')};throw new Error(c.detail||`请求失败 (${b.status})`)};return b.json()}catch(b){console.error('HTTP请求错误:',b);if(b.message.includes('SSL')||b.message.includes('cert')){throw new Error('服务器证书验证失败，请使用HTTP或更新证书')};throw b}}async function attemptReconnection(a=2){for(let b=0;b<a;b++){try{await new Promise(c=>setTimeout(c,1000*Math.pow(2,b)));await initWebSocket();if(ws&&ws.readyState===WebSocket.OPEN){console.log('重连成功');return true}}catch(c){console.error(`第 ${b+ 1} 次重连失败:`,c)}};return false}async function displayPollyResponse(a,b){const c=a.querySelector('.thinking');if(c){a.removeChild(c)};a.innerHTML='';const d=marked.parse(b);await typeWriterHTML(a,d,30);scrollToBottom()}function displayUserMessage(a){const b=document.createElement('div');b.className='message-container user-message';const c=document.createElement('div');c.className='chat-bubble user';c.textContent=a;const d=document.createElement('div');d.className='chat-avatar';d.innerHTML='<i class="fas fa-user"></i>';b.appendChild(d);b.appendChild(c);chatBox.appendChild(b);scrollToBottom()}function createPollyMessageContainer(){const a=document.createElement('div');a.className='message-container polly-message';const b=document.createElement('div');b.className='chat-avatar';b.innerHTML=`<img src="https://polly2014.github.io/images/polly.png" alt="Polly">`;const c=document.createElement('div');c.className='chat-bubble polly';const d=document.createElement('div');d.className='thinking';for(let e=0;e<3;e++){const f=document.createElement('span');d.appendChild(f)};c.appendChild(d);a.appendChild(b);a.appendChild(c);chatBox.appendChild(a);return {pollyContainer:a,pollyBubble:c}}async function handleError(a,b){console.error('Error:',b);a.innerHTML='';let c='哎呀，好像出问题了呢，Polly正在火速解决ing >_<';if(b.message.includes('API Key')){c='API Key 验证失败，请联系管理员'}else if(b.message.includes('请求失败')){c='网络请求失败，请稍后再试'}else if(b.message.includes('超时')){c='响应超时，已切换到 HTTP 模式'};await typeWriter(a,c)}window.addEventListener('load',()=>{initWebSocket();userInput.focus();const a=document.querySelector('.polly-chat');a.style.opacity='0';requestAnimationFrame(()=>{a.style.transition='opacity 0.6s ease-out';a.style.opacity='1'})});sendButton.addEventListener('click',sendMessage);userInput.addEventListener('keypress',a=>{if(a.key==='Enter'){a.preventDefault();sendMessage()}});document.querySelector('.polly-chat').addEventListener('click',()=>{userInput.focus()});userInput.addEventListener('click',a=>{a.stopPropagation()});sendButton.addEventListener('click',a=>{a.stopPropagation()})</script></div></div><script>document.addEventListener('DOMContentLoaded',function(){const c=document.querySelector('.menu-toggle');const d=document.querySelector('.sidebar');const e=document.querySelector('.overlay');function a(){d.classList.toggle('active');e.classList.toggle('active')}c.addEventListener('click',a);e.addEventListener('click',a);let f=0;let g=0;document.addEventListener('touchstart',h=>{f=h.changedTouches[0].screenX},false);document.addEventListener('touchend',h=>{g=h.changedTouches[0].screenX;b()},false);function b(){const h=g- f;if(h>50&&f<30){d.classList.add('active');e.classList.add('active')}else if(h<-50&&d.classList.contains('active')){d.classList.remove('active');e.classList.remove('active')}}})</script>